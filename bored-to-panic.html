<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bored to Panic – IMTHEBUS Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Inter:wght@400;500;600&display=swap">

  <!-- Charts / export libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --bg-board: #fdfdfd;
      --ink: #111111;
      --border-strong: #000000;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f3f3f3;
      background-image: url("assets/whiteboard.jpg");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: var(--ink);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Layout shell */

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    nav {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(253, 253, 253, 0.96);
      border-bottom: 2px solid var(--border-strong);
      padding: 0.4rem 1.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-left {
      display: flex;
      gap: 1.25rem;
      font-size: 0.95rem;
    }

    .nav-left a {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      position: relative;
      padding-bottom: 0.1rem;
    }

    .nav-left a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -0.05rem;
      width: 0;
      height: 2px;
      background: #000;
      transition: width 0.15s ease-out;
    }

    .nav-left a:hover::after {
      width: 100%;
    }

    .nav-right {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.04em;
    }

    main {
      flex: 1;
      padding: 1.5rem 1.25rem 2rem;
    }

    .page-inner {
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-grid {
      display: grid;
      grid-template-columns: minmax(260px, 340px) minmax(0, 1fr);
      gap: 1.25rem;
      align-items: flex-start;
    }

    @media (max-width: 860px) {
      .page-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Sidebar clipboard */

    .sidebar {
      background: #ffffff;
      border: 3px solid #000;
      border-radius: 18px;
      box-shadow: 0 10px 0 rgba(0, 0, 0, 0.12);
      padding: 1.1rem 1.1rem 1.2rem;
      position: relative;
    }

    .sidebar::before {
      content: "";
      position: absolute;
      top: 0.45rem;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 9px;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
    }

    .sidebar-title {
      margin-top: 1.6rem;
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.6rem;
    }

    .sidebar-subtitle {
      margin-top: 0.25rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .sidebar-field {
      margin-top: 0.75rem;
      font-size: 0.85rem;
    }

    .sidebar-field label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .sidebar-field input,
    .sidebar-field select {
      width: 100%;
      font: inherit;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
    }

    .sidebar-field select.role-missing {
      border-color: #f97316;
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.4);
    }

    .sidebar-note {
      margin-top: 0.5rem;
      font-size: 0.78rem;
      color: #555;
    }

    .sidebar-section {
      margin-top: 0.9rem;
      border-top: 1px solid #ddd;
      padding-top: 0.5rem;
    }

    .sidebar-section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.9rem;
    }

    .sidebar-section-header span.label {
      font-weight: 600;
    }

    .sidebar-section-header span.hint {
      font-size: 0.78rem;
      color: #777;
    }

    .sidebar-section-body {
      font-size: 0.82rem;
      color: #444;
      max-height: 220px;
    }

    .sidebar-section.static .sidebar-section-body {
      max-height: none;
    }

    .sidebar-section-body p {
      margin: 0.45rem 0;
    }

    .sidebar-section-body ul {
      margin: 0.3rem 0 0.3rem 1.1rem;
      padding: 0;
    }

    .sidebar-section-body li {
      margin-bottom: 0.2rem;
    }

    .sidebar-export-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
    }

    .sidebar-section.sidebar-export:hover .sidebar-export-body {
      max-height: 260px;
    }

    .sidebar-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }

    .sidebar-buttons button,
    .sidebar-buttons select {
      font: inherit;
      font-size: 0.78rem;
    }

    .sidebar-buttons button {
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
    }

    .sidebar-buttons button.primary {
      background: #000;
      color: #fff;
    }

    .sidebar-buttons button.danger {
      background: #e11d48;
      color: #fff;
    }

    .sidebar-buttons button:hover {
      transform: translateY(-1px);
    }

    .sidebar-buttons select {
      border-radius: 999px;
      border: 2px solid #000;
      padding: 0.28rem 0.55rem;
      max-width: 100%;
    }

    /* Board */

    .board-wrapper {
      background: var(--bg-board);
      border-radius: 22px;
      border: 3px solid var(--border-strong);
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.14);
      padding: 1rem 1.15rem 1.35rem;
      position: relative;
      overflow: hidden;
    }

    .board-wrapper:fullscreen {
      overflow-y: auto;
    }

    .board-inner {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .board-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .board-title-display {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.7rem;
    }

    .board-toolbar {
      display: flex;
      gap: 0.4rem;
    }

    .board-toolbar button {
      font: inherit;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.25rem 0.7rem;
      cursor: pointer;
    }

    .board-intro {
      font-size: 0.9rem;
      max-width: 40rem;
    }

    .board-about {
      margin-top: 0.25rem;
      padding: 0.6rem 0.75rem;
      border-radius: 14px;
      border: 2px dashed #000;
      background: #fffef0;
      font-size: 0.86rem;
      line-height: 1.5;
    }

    .board-about strong {
      font-weight: 600;
    }

    .board-body {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(260px, 1fr);
      gap: 1rem;
      align-items: flex-start;
    }

    @media (max-width: 980px) {
      .board-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Export stacking */
    .board-inner.export-mode .board-body {
      display: flex;
      flex-direction: column;
    }

    .board-column {
      min-width: 0;
    }

    /* Question sections */

    .question-section {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .question-section-header {
      width: 100%;
      border: none;
      background: #fff;
      padding: 0.55rem 0.7rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      text-align: left;
    }

    .question-section-title {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.05rem;
    }

    .question-section-subtitle {
      font-size: 0.8rem;
      color: #555;
      margin-left: 0.35rem;
    }

    .question-section-toggle {
      font-size: 1.1rem;
      font-weight: 600;
      transition: transform 0.2s;
    }

    .question-section-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
      border-top: 2px solid #000;
    }

    .question-section.open .question-section-body {
      max-height: 600px;
    }

    .question-section.open .question-section-toggle {
      transform: rotate(90deg);
    }

    .question-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .question-table th,
    .question-table td {
      padding: 0.45rem 0.5rem;
      vertical-align: middle;
    }

    .question-table th {
      border-bottom: 1px solid #ddd;
      font-size: 0.78rem;
      text-align: center;
    }

    .question-table th:first-child,
    .question-table td:first-child {
      width: 2.2rem;
      text-align: center;
    }

    .question-table th:nth-child(2),
    .question-table td:nth-child(2) {
      text-align: left;
    }

    .question-number {
      font-size: 0.8rem;
      color: #444;
    }

    .question-text {
      max-width: 360px;
    }

    .scale-label-row th {
      font-weight: 500;
    }

    .scale-label-row th:nth-child(3) {
      text-align: center;
    }

    .scale-label-row th span {
      display: block;
    }

    .scale-label-row th span.label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .scale-label-row th span.caption {
      font-size: 0.7rem;
      color: #666;
    }

    .response-cell {
      text-align: center;
    }

    .response-radio {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid #000;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .response-radio input {
      display: none;
    }

    .response-radio span {
      user-select: none;
    }

    .response-radio.selected {
      background: #000;
      color: #fff;
    }

    .calculate-row {
      margin-top: 0.65rem;
      display: flex;
      justify-content: flex-start;
    }

    .calculate-row button {
      font: inherit;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #000;
      color: #fff;
      padding: 0.45rem 1.1rem;
      cursor: pointer;
      transition: box-shadow 0.15s, transform 0.1s, background 0.15s, border-color 0.15s;
    }

    .calculate-row button.calculated {
      background: #16a34a;
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.35);
      transform: translateY(-1px);
    }

    /* Right column: ring and results */

    .donut-panel {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.6rem 0.8rem 0.7rem;
      margin-bottom: 0.6rem;
    }

    .donut-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.3rem;
    }

    .donut-header-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .donut-header-note {
      font-size: 0.75rem;
      color: #555;
    }

    #zoneRing {
      width: 100%;
      height: 220px;
      display: block;
    }

    .zone-legend-row {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      margin-top: 0.15rem;
    }

    .zone-legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .zone-legend-label {
      flex: 1;
    }

    .zone-legend-value {
      min-width: 2.2rem;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .results-panel,
    .overall-panel,
    .entries-panel {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.7rem 0.8rem;
      font-size: 0.85rem;
      margin-bottom: 0.6rem;
    }

    .results-panel h3,
    .overall-panel h3,
    .entries-panel h3 {
      margin: 0 0 0.4rem;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .results-panel p,
    .overall-panel p {
      margin: 0.25rem 0;
    }

    .results-panel table,
    .overall-panel table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.35rem;
      font-size: 0.8rem;
    }

    .results-panel th,
    .results-panel td,
    .overall-panel th,
    .overall-panel td {
      border: 1px solid #000;
      padding: 0.25rem 0.3rem;
      vertical-align: top;
    }

    .conversation-prompts {
      margin-top: 0.4rem;
      font-size: 0.8rem;
    }

    .conversation-prompts ul {
      margin: 0.25rem 0 0.25rem 1rem;
      padding: 0;
    }

    .entries-panel table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .entries-panel th,
    .entries-panel td {
      border: 1px solid #000;
      padding: 0.25rem 0.3rem;
    }

    .entries-chart-container {
      margin-top: 0.5rem;
      display: none;
    }

    #entriesTrend {
      width: 100%;
      height: 220px;
    }

    /* Export header/footer inside board for PDF */

    .export-header {
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.4rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .export-header-title {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .export-header-meta {
      font-size: 0.8rem;
    }

    .export-footer {
      border-top: 1px solid #ccc;
      margin-top: 0.8rem;
      padding-top: 0.3rem;
      font-size: 0.75rem;
      text-align: right;
      color: #444;
    }

    /* Site footer */

    footer.site-footer {
      border-top: 2px solid #000;
      background: rgba(253, 253, 253, 0.96);
      padding: 0.8rem 1.75rem 1rem;
      font-size: 0.8rem;
    }

    .footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 1.4rem;
    }

    .footer-group-title {
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 600;
      font-size: 0.72rem;
      margin-bottom: 0.2rem;
    }

    .footer-group a {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.1rem;
    }

    .footer-group a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
<div class="page">
  <nav>
    <div class="nav-left">
      <a href="index.html">Home</a>
      <a href="index.html#tools">Tools</a>
      <a href="about.html">About</a>
    </div>
    <div class="nav-right">IMTHEBUS tools</div>
  </nav>

  <main>
    <div class="page-inner">
      <div class="page-grid">

        <!-- Sidebar clipboard -->
        <aside class="sidebar">
          <h1 class="sidebar-title">Bored to Panic scale</h1>
          <p class="sidebar-subtitle">
            A shared language for how work feels, from bored through comfort and stretch, into stress and panic.
          </p>

          <div class="sidebar-field">
            <label for="personName">Name (optional)</label>
            <input id="personName" type="text" placeholder="e.g. Alex Smith" />
          </div>

          <div class="sidebar-field">
            <label for="roleLevel">Role level (optional)</label>
            <select id="roleLevel">
              <option value="">Select role level</option>
              <option value="L1">Operator</option>
              <option value="L2">Senior Operator</option>
              <option value="L3">Supervisor</option>
              <option value="L4">Manager</option>
              <option value="L5">Director</option>
            </select>
          </div>

          <div class="sidebar-field">
            <label for="context">Context (optional)</label>
            <select id="context">
              <option value="">Select context</option>
              <option value="Normal week">Normal week</option>
              <option value="Peak period">Peak period</option>
              <option value="Project workload">Project workload</option>
              <option value="Returning from leave">Returning from leave</option>
              <option value="Team changes">Team changes</option>
              <option value="User-defined">Other (specify below)</option>
            </select>
          </div>

          <div class="sidebar-field" style="margin-top:0.45rem;">
            <input id="contextCustom" type="text" placeholder="Specify your context (optional)" style="display:none;">
          </div>

          <p class="sidebar-note">
            Use this once per check-in to capture how the last few days or weeks have actually felt.
          </p>

          <!-- How it works (always visible) -->
          <div class="sidebar-section static">
            <div class="sidebar-section-header">
              <span class="label">About this tool</span>
            </div>
            <div class="sidebar-section-body">
              <p>
                The Bored → Comfort → Stretch → Stress → Panic scale is based on the Yerkes–Dodson law and
                turns it into a simple conversational tool.
              </p>
              <p>
                Over time, spending more time in <strong>Stretch</strong> makes that work feel easier.
                Your comfort zone grows, so you visit Stress less often and Panic becomes rarer
                and less intense. You also get used to seeing yourself succeed or learning from
                failures without treating them as disasters.
              </p>
              <p>
                This tool focuses on where your time and energy sit now. It does not label people as
                good or bad performers. It asks whether the “exercise” you do each day is helping you
                grow a bigger Comfort zone, or pushing you toward Boredom or Panic.
              </p>
            </div>
          </div>

          <!-- Data and privacy -->
          <div class="sidebar-section">
            <div class="sidebar-section-header">
              <span class="label">Data and privacy</span>
              <span class="hint">hover to expand</span>
            </div>
            <div class="sidebar-section-body">
              <p>
                Your responses are stored only in this browser using local storage.
                Nothing is uploaded, shared or sent anywhere.
              </p>
              <p>
                Clearing browser storage, switching device or pressing “Clear all saved entries” deletes the data permanently.
              </p>
            </div>
          </div>

          <!-- Saved / export -->
          <div class="sidebar-section sidebar-export">
            <div class="sidebar-section-header">
              <span class="label">Saved results &amp; export</span>
              <span class="hint">hover to expand</span>
            </div>
            <div class="sidebar-export-body">
              <div class="sidebar-field" style="margin-top:0.4rem;">
                <label for="loadEntry">Load a previous result</label>
                <select id="loadEntry">
                  <option value="">Select saved entry</option>
                </select>
              </div>

              <div class="sidebar-buttons">
                <button id="saveEntry" type="button" class="primary">Save entry</button>
                <button id="exportCsv" type="button">Export CSV</button>
                <button id="exportPdf" type="button">Save as PDF</button>
                <button id="clearEntries" type="button" class="danger">Clear all</button>
              </div>

              <p class="sidebar-note" style="margin-top:0.35rem;">
                Saved entries stay in this browser only. Use CSV or PDF to keep a record elsewhere.
              </p>
            </div>
          </div>
        </aside>

        <!-- Board -->
        <section class="board-wrapper" id="boardWrapper">
          <div class="board-inner" id="boardInner">
            <div class="board-header">
              <div class="board-title-display">Bored to Panic assessment</div>
              <div class="board-toolbar">
                <button type="button" id="fullscreenToggle">Fullscreen board</button>
              </div>
            </div>
            <p class="board-intro">
              This tool helps you and your manager understand how work feels at the moment.
              It maps your answers to five zones: Bored, Comfort, Stretch, Stress and Panic.
            </p>
            <div class="board-about" id="boardAbout">
              <strong>Why Bored and Panic matter:</strong>
              Both Bored and Panic are zones we do not enjoy. They are not places where we feel
              safely challenged or comfortable, and they rarely support learning. We spend time in
              <strong>Stretch</strong> to expand our Comfort zone, and we learn how to recover when we have
              to visit Stress. This tool is about understanding where you currently spend your time and
              whether the “exercise” you do each day is helping or hindering that growth.
            </div>

            <div class="board-body" id="boardBody">
              <!-- Left: questions -->
              <div class="board-column">
                <div id="questionSections"></div>
                <div class="calculate-row">
                  <button id="calculateFromQuestions" type="button">Calculate from answers</button>
                </div>
              </div>

              <!-- Right: ring and results -->
              <div class="board-column">
                <div class="donut-panel">
                  <div class="donut-header">
                    <div class="donut-header-title">Zone pattern</div>
                    <div class="donut-header-note" id="donutLabel">
                      Equal starting pattern. Update after calculation.
                    </div>
                  </div>
                  <canvas id="zoneRing" width="260" height="220"></canvas>
                  <div id="zoneRingLegend"></div>
                </div>

                <div class="results-panel">
                  <h3>Calculated zone and scores</h3>
                  <div id="calculationResults">
                    Answer the questions and click <strong>Calculate from answers</strong> to see the pattern and
                    suggested prompts.
                  </div>
                </div>

                <div class="overall-panel">
                  <h3>Overall scale result</h3>
                  <div id="overallResult">
                    Select a role level to compare your pattern against a typical target for that role.
                  </div>
                </div>

                <div class="entries-panel">
                  <h3>Recorded entries (this browser)</h3>
                  <p style="margin:0 0 0.3rem;">Use this to track how your pattern changes over time.</p>
                  <table id="entriesTable">
                    <thead>
                    <tr>
                      <th>Date</th>
                      <th>Bored %</th>
                      <th>Comfort %</th>
                      <th>Stretch %</th>
                      <th>Stress %</th>
                      <th>Panic %</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                  <div class="entries-chart-container" id="entriesChartContainer">
                    <canvas id="entriesTrend"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div>© <span id="year"></span> IMTHEBUS. All rights reserved.</div>
        <div>
          Tool design, questions, scoring model and interpretation framework created by Dean Rougvie.
          All calculations are experimental and may contain errors.
        </div>
      </div>
      <div class="footer-links">
        <div class="footer-group">
          <div class="footer-group-title">Contact</div>
          <a href="mailto:contact@imthebus.co.uk?subject=General%20enquiry">contact@imthebus.co.uk</a>
          <a href="mailto:contact@imthebus.co.uk?subject=Bug%20report">Report a bug</a>
          <a href="mailto:contact@imthebus.co.uk?subject=Tool%20idea">Suggest a tool</a>
        </div>
        <div class="footer-group">
          <div class="footer-group-title">Legal</div>
          <a href="stuff.html#privacy">Privacy notice</a>
          <a href="stuff.html#terms">Terms of use</a>
        </div>
      </div>
    </div>
  </footer>
</div>

<script>
  // Footer year
  document.getElementById("year").textContent = new Date().getFullYear();

  const contextSelect = document.getElementById("context");
  const contextCustom = document.getElementById("contextCustom");
  contextSelect.addEventListener("change", () => {
    contextCustom.style.display = contextSelect.value === "User-defined" ? "block" : "none";
  });

  // Questions definition (same wording as before)
  const questions = [
    { id: 1,  text: "I regularly handle tasks that feel new or unfamiliar." },
    { id: 2,  text: "I complete many tasks automatically, without conscious effort." },
    { id: 3,  text: "I must make decisions without having all the information I would like." },
    { id: 4,  text: "I feel calm and in control during most of my working time." },
    { id: 5,  text: "I feel overwhelmed or unable to keep up with my work." },
    { id: 6,  text: "My work feels repetitive or predictable." },
    { id: 7,  text: "I put deliberate effort into practising new skills or behaviours." },
    { id: 8,  text: "I feel mentally stretched in a way that requires focus." },
    { id: 9,  text: "I adapt how I work to achieve good results." },   // reverse scored
    { id: 10, text: "I feel positively challenged and encouraged to grow." },
    { id: 11, text: "My days are stable and contain few unexpected demands." },
    { id: 12, text: "My workload builds up faster than I can process it." },
    { id: 13, text: "I need to switch rapidly between competing tasks." },
    { id: 14, text: "I take on responsibilities that require learning and adaptation." },
    { id: 15, text: "I feel energised or stimulated by new challenges." },
    { id: 16, text: "I find myself firefighting without space to recover." },
    { id: 17, text: "I complete routine tasks smoothly and confidently." },
    { id: 18, text: "I manage situations involving tight deadlines or time pressure." },
    { id: 19, text: "I feel under used or under challenged in parts of my role." },
    { id: 20, text: "I can predict how most of my day or week will unfold." },
    { id: 21, text: "I feel a mild sense of pressure that helps me stay focused." },
    { id: 22, text: "I take on tasks that sit outside my comfort zone." },
    { id: 23, text: "I experience periods where I cannot think clearly due to pressure." },
    { id: 24, text: "I feel confident in handling unexpected problems when they arise." },
    { id: 25, text: "I avoid tasks that feel too overwhelming." }
  ];

  // Group questions into sections (matching your screenshot)
  const sections = [
    {
      id: "workload",
      title: "Workload and pace",
      subtitle: "How fast work comes at you and how heavy it feels.",
      questionIds: [3,5,12,13,16,18]
    },
    {
      id: "challenge",
      title: "Challenge and growth",
      subtitle: "Stretch, learning and positive pressure.",
      questionIds: [1,7,8,10,14,15,22,21]
    },
    {
      id: "stability",
      title: "Stability and routine",
      subtitle: "Predictability, habits and smooth running.",
      questionIds: [2,4,11,17,20,24]
    },
    {
      id: "capacity",
      title: "Capacity and under / over use",
      subtitle: "Whether your role feels too small or too big.",
      questionIds: [6,19,25]
    },
    {
      id: "control",
      title: "Control and problem solving",
      subtitle: "Clarity, confidence and reacting under pressure.",
      questionIds: [9,21,23]
    }
  ];

  const reverseScored = new Set([9]);

  // Response options: values 0–4, labels 1–5
  const responseOptions = [
    { value: 0, label: "1" },
    { value: 1, label: "2" },
    { value: 2, label: "3" },
    { value: 3, label: "4" },
    { value: 4, label: "5" }
  ];

  // Zone mappings
  const zoneQuestions = {
    bored:   [2, 6, 9, 19, 20],
    comfort: [4, 11, 17, 20, 24],
    stretch: [1, 7, 8, 10, 14, 15, 18, 21, 22],
    stress:  [3, 12, 13],
    panic:   [5, 16, 23, 25]
  };

  const zoneLabels = {
    bored: "Bored",
    comfort: "Comfort",
    stretch: "Stretch",
    stress: "Stress",
    panic: "Panic"
  };

  const zoneColors = {
    bored:   { fill: "#111827", stroke: "#111827" },
    comfort: { fill: "#60a5fa", stroke: "#1d4ed8" },
    stretch: { fill: "#4ade80", stroke: "#15803d" },
    stress:  { fill: "#fbbf24", stroke: "#b45309" },
    panic:   { fill: "#f97373", stroke: "#b91c1c" }
  };

  const roleTargets = {
    L1: { bored: 20, comfort: 45, stretch: 30, stress: 5,  panic: 0 },
    L2: { bored: 15, comfort: 40, stretch: 35, stress: 10, panic: 0 },
    L3: { bored: 10, comfort: 30, stretch: 40, stress: 20, panic: 0 },
    L4: { bored: 8,  comfort: 25, stretch: 45, stress: 22, panic: 0 },
    L5: { bored: 5,  comfort: 20, stretch: 55, stress: 20, panic: 0 }
  };

  const roleLabels = {
    L1: "Operator",
    L2: "Senior Operator",
    L3: "Supervisor",
    L4: "Manager",
    L5: "Director"
  };

  const descriptions = {
    1: {
      label: "Bored",
      text: "Underloaded. Too little challenge or variety. Skills underused and development may stall.",
      manager: "Increase challenge, variety or responsibility. Clarify expectations for growth."
    },
    2: {
      label: "Comfort",
      text: "Workload feels manageable with low pressure. Reliable performance but limited stretch.",
      manager: "Keep the core stable but agree some stretch tasks or projects."
    },
    3: {
      label: "Stretch",
      text: "Healthy stretch zone. Work is challenging in a good way, with visible learning.",
      manager: "Protect this state, keep priorities clear and recognise the effort."
    },
    4: {
      label: "Stress",
      text: "High pressure and cognitive load. Work is being done but fatigue and error risk rise.",
      manager: "Re-prioritise, remove low value work or add temporary support."
    },
    5: {
      label: "Panic",
      text: "Demand exceeds capacity. Performance becomes unstable and reactive.",
      manager: "Intervene quickly. Adjust workload and support and treat it as a system issue."
    }
  };

  const roleLevelSelect = document.getElementById("roleLevel");
  const saveButton = document.getElementById("saveEntry");
  const exportButton = document.getElementById("exportCsv");
  const exportPdfButton = document.getElementById("exportPdf");
  const clearButton = document.getElementById("clearEntries");
  const loadSelect = document.getElementById("loadEntry");
  const calculationResults = document.getElementById("calculationResults");
  const overallResult = document.getElementById("overallResult");
  const entriesTableBody = document.querySelector("#entriesTable tbody");
  const calculateButton = document.getElementById("calculateFromQuestions");
  const donutLabel = document.getElementById("donutLabel");
  const boardWrapper = document.getElementById("boardWrapper");
  const boardInner = document.getElementById("boardInner");
  const entriesChartContainer = document.getElementById("entriesChartContainer");
  const entriesTrendCanvas = document.getElementById("entriesTrend");

  let latestZonePercents = null;
  let latestZoneRaw = null;
  let latestTopZone = null;
  let latestTopScore = null;
  let latestResponses = null;
  let latestScaleScore = null;
  let latestReviewText = "";
  let trendChart = null;

  /* ---------- Build questions UI ---------- */

  const questionSectionsContainer = document.getElementById("questionSections");
  const questionMap = new Map(questions.map(q => [q.id, q]));

  function openSection(wrapper) {
    document.querySelectorAll(".question-section").forEach(sec => {
      if (sec === wrapper) {
        sec.classList.add("open");
      } else {
        sec.classList.remove("open");
      }
    });
  }

  function buildQuestions() {
    sections.forEach(section => {
      const wrapper = document.createElement("div");
      wrapper.className = "question-section";
      wrapper.dataset.sectionId = section.id;

      const headerBtn = document.createElement("button");
      headerBtn.type = "button";
      headerBtn.className = "question-section-header";
      headerBtn.innerHTML = `
        <div>
          <span class="question-section-title">${section.title}</span>
          <span class="question-section-subtitle">${section.subtitle}</span>
        </div>
        <div class="question-section-toggle">+</div>
      `;
      wrapper.appendChild(headerBtn);

      const body = document.createElement("div");
      body.className = "question-section-body";

      const table = document.createElement("table");
      table.className = "question-table";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr class="scale-label-row">
          <th>#</th>
          <th>Question</th>
          <th colspan="5">
            <span class="label">Never → Always</span>
            <span class="caption">1 = never, 3 = sometimes, 5 = always</span>
          </th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      section.questionIds.forEach(qid => {
        const q = questionMap.get(qid);
        if (!q) return;
        const tr = document.createElement("tr");

        const tdNum = document.createElement("td");
        tdNum.className = "question-number";
        tdNum.textContent = q.id;
        tr.appendChild(tdNum);

        const tdText = document.createElement("td");
        tdText.className = "question-text";
        tdText.textContent = q.text;
        tr.appendChild(tdText);

        responseOptions.forEach(opt => {
          const td = document.createElement("td");
          td.className = "response-cell";

          const label = document.createElement("label");
          label.className = "response-radio";
          const input = document.createElement("input");
          input.type = "radio";
          input.name = `q${q.id}`;
          input.value = opt.value;

          const span = document.createElement("span");
          span.textContent = opt.label;

          label.appendChild(input);
          label.appendChild(span);
          td.appendChild(label);
          tr.appendChild(td);

          label.addEventListener("click", () => {
            document
              .querySelectorAll(`label.response-radio input[name="q${q.id}"]`)
              .forEach(r => r.parentElement.classList.remove("selected"));
            label.classList.add("selected");
          });
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      body.appendChild(table);
      wrapper.appendChild(body);
      questionSectionsContainer.appendChild(wrapper);

      headerBtn.addEventListener("click", () => {
        openSection(wrapper);
      });
    });

    // Open the first section by default
    const firstSection = document.querySelector(".question-section");
    if (firstSection) firstSection.classList.add("open");
  }

  buildQuestions();

  /* ---------- Ring chart (concentric bands, not pie) ---------- */

  const ringCanvas = document.getElementById("zoneRing");
  const ringCtx = ringCanvas.getContext("2d");

  function drawRingChart(data) {
    const w = ringCanvas.width;
    const h = ringCanvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const maxRadius = Math.min(w, h) / 2 - 8;

    ringCtx.clearRect(0, 0, w, h);

    const order = ["bored", "comfort", "stretch", "stress", "panic"];
    const values = data || { bored: 20, comfort: 20, stretch: 20, stress: 20, panic: 20 };

    let innerR = 0;
    order.forEach(zone => {
      const pct = values[zone] ?? 0;
      const outerR = innerR + maxRadius * (pct / 100);
      if (outerR <= innerR) return;

      ringCtx.beginPath();
      ringCtx.arc(cx, cy, outerR, 0, 2 * Math.PI);
      ringCtx.arc(cx, cy, innerR, 2 * Math.PI, 0, true);
      ringCtx.closePath();
      ringCtx.fillStyle = zoneColors[zone].fill;
      ringCtx.fill();

      innerR = outerR;
    });

    // Outer ring
    ringCtx.beginPath();
    ringCtx.arc(cx, cy, maxRadius, 0, 2 * Math.PI);
    ringCtx.strokeStyle = "#000";
    ringCtx.lineWidth = 2;
    ringCtx.stroke();
  }

  function updateRingLegend(data, labelText) {
    const legend = document.getElementById("zoneRingLegend");
    const order = ["bored", "comfort", "stretch", "stress", "panic"];
    const values = data || { bored: 20, comfort: 20, stretch: 20, stress: 20, panic: 20 };
    const rows = order.map(zone => {
      const pct = values[zone] ?? 0;
      return `
        <div class="zone-legend-row">
          <span class="zone-legend-swatch" style="background:${zoneColors[zone].stroke};"></span>
          <span class="zone-legend-label">${zoneLabels[zone]}</span>
          <span class="zone-legend-value">${pct}%</span>
        </div>
      `;
    }).join("");
    legend.innerHTML = rows;
    donutLabel.textContent = labelText;
  }

  drawRingChart(null);
  updateRingLegend(null, "Equal starting pattern. Update after calculation.");

  /* ---------- Scoring logic (averages into percentages) ---------- */

  function getResponses() {
    const responses = {};
    for (const q of questions) {
      const checked = document.querySelector(`input[name="q${q.id}"]:checked`);
      if (!checked) return null;
      responses[q.id] = parseInt(checked.value, 10);
    }
    return responses;
  }

  function calculateZoneScores(responses) {
    const raw = {};
    const avg = {};
    let totalIntensity = 0;
    const zones = Object.keys(zoneQuestions);

    zones.forEach(zone => {
      const ids = zoneQuestions[zone];
      let sum = 0;
      ids.forEach(id => {
        const base = responses[id] ?? 0;
        const score = reverseScored.has(id) ? (4 - base) : base;
        sum += score;
      });
      const mean = ids.length ? sum / ids.length : 0;
      raw[zone] = sum;
      avg[zone] = mean;
      totalIntensity += mean;
    });

    const percents = {};
    if (totalIntensity === 0) {
      zones.forEach(z => { percents[z] = 0; });
    } else {
      let running = 0;
      zones.forEach((zone, idx) => {
        if (idx === zones.length - 1) {
          percents[zone] = Math.max(0, 100 - running);
        } else {
          const p = Math.round((avg[zone] / totalIntensity) * 100);
          percents[zone] = p;
          running += p;
        }
      });
    }

    return { raw, percents };
  }

  function currentTarget(role) {
    return role ? roleTargets[role] : null;
  }

  function levelLabel(actual, ideal) {
    const diff = actual - ideal;
    if (Math.abs(diff) <= 5) return "close to target";
    if (diff > 5) return "higher than target";
    return "lower than target";
  }

  function zoneNarrative(zone, actual, ideal) {
    const level = levelLabel(actual, ideal);
    switch (zone) {
      case "bored":
        if (level === "higher than target") return "Boredom is high; explore extra responsibility, variety or clearer goals.";
        if (level === "lower than target") return "Boredom is low; capability is broadly in use.";
        return "Boredom is close to target; look at other zones for focus.";
      case "comfort":
        if (level === "higher than target") return "Comfort is high; add some stretch work so learning continues.";
        if (level === "lower than target") return "Comfort is low; stabilise core workload, routines and support.";
        return "Comfort is about right; keep the basics predictable.";
      case "stretch":
        if (level === "higher than target") return "Stretch is high; check that support, clarity and recovery time are strong.";
        if (level === "lower than target") return "Stretch is low; development and learning may be limited.";
        return "Stretch is on target; protect time for this.";
      case "stress":
        if (level === "higher than target") return "Stress is high; review priorities, capacity and decision bottlenecks.";
        if (level === "lower than target") return "Stress is low; there may be spare capacity if needed for short bursts.";
        return "Stress is close to target; keep an eye on recovery time.";
      case "panic":
        if (level === "higher than target") return "Panic is higher than expected; treat this as a system issue, not an individual failing.";
        if (level === "lower than target") return "Panic is low; keep clear boundaries and buffers in place.";
        return "Panic is around expected; still useful to understand triggers and early warning signs.";
      default:
        return "";
    }
  }

  function buildFlags(percents) {
    const flags = [];
    const b = percents.bored;
    const c = percents.comfort;
    const st = percents.stretch;
    const sr = percents.stress;
    const p = percents.panic;

    // Praise patterns
    if (st >= 35 && st <= 60 && p < 10 && sr >= 5 && sr <= 25 && b < 20) {
      flags.push("You are spending a healthy amount of time in Stretch with manageable Stress and low Panic. Protect this pattern by keeping priorities clear and making recovery time explicit.");
    }

    if (c >= 30 && c <= 50 && b < 25 && p < 10) {
      flags.push("Comfort looks solid without drifting into boredom or panic. Keep core routines predictable and communication clear.");
    }

    // Risk patterns
    if (p >= 15) {
      flags.push("Panic at or above 15%: review specific situations that feel overwhelming and adjust workload, support or decision routes urgently.");
    } else if (p >= 10) {
      flags.push("Panic between 10–15%: agree regular check-ins, spot triggers early and treat this as a system pattern, not an individual weakness.");
    }

    if (sr + p >= 35) {
      flags.push("Combined Stress and Panic above 35%: this suggests a sustained high-pressure pattern. Consider rescoping work, adding resource or changing how priorities are set.");
    }

    if (b >= 25 && st < 30) {
      flags.push("Bored is high and Stretch is low: capability may be under-used and development slowing. Explore new responsibilities, projects or skills to practise.");
    }

    if (b >= 20 && p >= 10) {
      flags.push("High Bored and Panic together suggests the role swings between under-used and overwhelming. Review how work is distributed, where decisions pile up and how urgent work interrupts the basics.");
    }

    if (st < 25 && (b + c) > 60) {
      flags.push("Most of your time is in Bored and Comfort with limited Stretch. Learning may be flattening off; agree a small number of realistic growth tasks.");
    }

    if (sr < 5 && st < 30 && p === 0 && b < 10) {
      flags.push("Very low Stress and Panic with modest Stretch may mean there is spare capacity. Check whether this is intentional or whether more responsibility could be delegated safely.");
    }

    if (!flags.length) {
      flags.push("No strong risk flags from this pattern. Use the results to ask what is helping it work well and what you would like more of or less of.");
    }

    return flags;
  }

  function computeReviewRecommendation(percents, role) {
    const zones = ["bored", "comfort", "stretch", "stress", "panic"];
    const target = role ? roleTargets[role] : null;
    let avgDiff = null;
    let days = 0;
    let label = "";

    if (target) {
      let totalDiff = 0;
      zones.forEach(z => {
        const actual = percents[z] ?? 0;
        const ideal = target[z] ?? 0;
        totalDiff += Math.abs(actual - ideal);
      });
      avgDiff = totalDiff / zones.length;

      if (avgDiff >= 20) {
        label = "about 6 weeks";
        days = 42;
      } else if (avgDiff >= 15) {
        label = "about 2 months";
        days = 60;
      } else if (avgDiff >= 10) {
        label = "around 3 months";
        days = 90;
      } else if (avgDiff >= 5) {
        label = "around 6 months";
        days = 180;
      } else {
        label = "around 12 months";
        days = 365;
      }
    } else {
      label = "around 3 months";
      days = 90;
    }

    const now = new Date();
    const reviewDate = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
    const dateString = reviewDate.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });

    return { label, dateString, avgDiff };
  }

  function renderResults(percents, role, topZone, topScore) {
    const target = currentTarget(role);

    const flags = buildFlags(percents);

    calculationResults.innerHTML = `
      <p><strong>Highest zone:</strong> ${zoneLabels[topZone]} (${topScore}%)</p>
      ${
        target
          ? `<table>
               <thead>
                 <tr><th>Zone</th><th>Current</th><th>Target</th></tr>
               </thead>
               <tbody>
                 <tr><td>Bored</td><td>${percents.bored}%</td><td>${target.bored}%</td></tr>
                 <tr><td>Comfort</td><td>${percents.comfort}%</td><td>${target.comfort}%</td></tr>
                 <tr><td>Stretch</td><td>${percents.stretch}%</td><td>${target.stretch}%</td></tr>
                 <tr><td>Stress</td><td>${percents.stress}%</td><td>${target.stress}%</td></tr>
                 <tr><td>Panic</td><td>${percents.panic}%</td><td>${target.panic}%</td></tr>
               </tbody>
             </table>`
          : `<p><strong>Pattern:</strong> Bored ${percents.bored}% · Comfort ${percents.comfort}% · Stretch ${percents.stretch}% · Stress ${percents.stress}% · Panic ${percents.panic}%</p>`
      }
      <div class="conversation-prompts">
        <strong>Feedback and conversation prompts:</strong>
        <ul>${flags.map(f => `<li>${f}</li>`).join("")}</ul>
      </div>
    `;

    renderOverallScale(percents, role, topZone);
    drawRingChart(percents);
    updateRingLegend(percents, "Current pattern");
  }

  function renderOverallScale(percents, role, topZone) {
    const scoreMap = { bored: 1, comfort: 2, stretch: 3, stress: 4, panic: 5 };
    const score = scoreMap[topZone] || 3;
    latestScaleScore = score;
    const desc = descriptions[score];
    const target = currentTarget(role);

    let html = `
      <p><strong>Overall position:</strong> ${desc.label} (score ${score}/5)</p>
      <p>${desc.text}</p>
      <p><strong>Manager focus:</strong> ${desc.manager}</p>
    `;

    if (target) {
      html += `<table>
        <thead><tr><th>Zone</th><th>Comment</th></tr></thead>
        <tbody>
          ${["bored","comfort","stretch","stress","panic"].map(z => {
            const actual = percents[z] ?? 0;
            const ideal = target[z] ?? 0;
            return `<tr><td>${zoneLabels[z]}</td><td>${zoneNarrative(z, actual, ideal)}</td></tr>`;
          }).join("")}
        </tbody>
      </table>`;
    }

    const rec = computeReviewRecommendation(percents, role);
    latestReviewText = `Suggested time to redo this assessment: ${rec.label}, around ${rec.dateString}.`;
    html += `<p><strong>When to revisit:</strong> ${latestReviewText}</p>`;

    overallResult.innerHTML = html;
  }

  function handleCalculate() {
    const responses = getResponses();
    if (!responses) {
      alert("Please answer all questions before calculating.");
      return;
    }
    const { raw, percents } = calculateZoneScores(responses);
    const entriesArr = Object.entries(percents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["stretch", 0];

    latestZonePercents = percents;
    latestZoneRaw = raw;
    latestTopZone = topZone;
    latestTopScore = topScore;
    latestResponses = responses;

    const role = roleLevelSelect.value || null;

    if (!role) {
      roleLevelSelect.classList.add("role-missing");
      roleLevelSelect.focus();
      document.querySelector(".sidebar").scrollIntoView({ behavior: "smooth", block: "start" });
      setTimeout(() => roleLevelSelect.classList.remove("role-missing"), 2000);
    }

    renderResults(percents, role, topZone, topScore);

    // Visual feedback on button and scroll to results column
    calculateButton.classList.add("calculated");
    calculateButton.textContent = "Calculated – see results on the right";
    const rightColumn = document.querySelector(".board-column:nth-child(2)");
    if (rightColumn) {
      rightColumn.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    setTimeout(() => {
      calculateButton.classList.remove("calculated");
      calculateButton.textContent = "Calculate from answers";
    }, 2500);
  }

  calculateButton.addEventListener("click", handleCalculate);

  roleLevelSelect.addEventListener("change", () => {
    if (!latestZonePercents) return;
    const role = roleLevelSelect.value || null;
    const entriesArr = Object.entries(latestZonePercents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["stretch", 0];
    renderResults(latestZonePercents, role, topZone, topScore);
  });

  /* ---------- Local storage for entries ---------- */

  function loadEntries() {
    try {
      return JSON.parse(localStorage.getItem("boredToPanicEntries") || "[]");
    } catch {
      return [];
    }
  }

  function saveEntries(entries) {
    localStorage.setItem("boredToPanicEntries", JSON.stringify(entries));
  }

  function renderTrendChart() {
    const entries = loadEntries();
    if (!entriesTrendCanvas || !entriesChartContainer) return;

    if (entries.length <= 1) {
      if (trendChart) {
        trendChart.destroy();
        trendChart = null;
      }
      entriesChartContainer.style.display = "none";
      return;
    }

    const labels = entries.map(e => e.timestamp);
    const zones = ["bored", "comfort", "stretch", "stress", "panic"];

    const datasets = zones.map(z => ({
      label: zoneLabels[z],
      data: entries.map(e => (e.zonePercents ? e.zonePercents[z] ?? null : null)),
      borderColor: zoneColors[z].stroke,
      backgroundColor: "transparent",
      tension: 0.25,
      spanGaps: true
    }));

    if (trendChart) {
      trendChart.destroy();
    }

    trendChart = new Chart(entriesTrendCanvas.getContext("2d"), {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { callback: v => v + "%" }
          }
        },
        plugins: {
          legend: { position: "bottom" }
        }
      }
    });

    entriesChartContainer.style.display = "block";
  }

  function renderEntriesTableAndDropdown() {
    const entries = loadEntries();
    entriesTableBody.innerHTML = "";
    loadSelect.innerHTML = '<option value="">Select saved entry</option>';

    entries.forEach((entry, index) => {
      const tr = document.createElement("tr");
      const zp = entry.zonePercents || {};
      tr.innerHTML = `
        <td>${entry.timestamp}</td>
        <td>${zp.bored ?? ""}%</td>
        <td>${zp.comfort ?? ""}%</td>
        <td>${zp.stretch ?? ""}%</td>
        <td>${zp.stress ?? ""}%</td>
        <td>${zp.panic ?? ""}%</td>
      `;
      entriesTableBody.appendChild(tr);

      const opt = document.createElement("option");
      const label = descriptions[entry.score]?.label || `Score ${entry.score}`;
      opt.value = index.toString();
      opt.textContent = `${entry.timestamp} – ${entry.name || "No name"} (${label})`;
      loadSelect.appendChild(opt);
    });

    renderTrendChart();
  }

  renderEntriesTableAndDropdown();

  function handleSave() {
    if (!latestZonePercents || !latestTopZone) {
      alert("Please calculate your results before saving.");
      return;
    }
    const name = document.getElementById("personName").value.trim();
    const roleLevel = roleLevelSelect.value || "";
    let contextValue = "";
    if (contextSelect.value === "User-defined") {
      contextValue = contextCustom.value.trim();
    } else {
      contextValue = contextSelect.value;
    }

    const scoreMap = { bored: 1, comfort: 2, stretch: 3, stress: 4, panic: 5 };
    const score = scoreMap[latestTopZone] || latestScaleScore || 3;
    const entries = loadEntries();
    const timestamp = new Date().toLocaleString();
    entries.push({
      timestamp,
      name,
      roleLevel,
      context: contextValue,
      score,
      zonePercents: latestZonePercents,
      zoneRaw: latestZoneRaw,
      responses: latestResponses
    });
    saveEntries(entries);
    renderEntriesTableAndDropdown();
    alert("Entry saved in this browser.");
  }

  function toCsvRow(cells) {
    return cells.map(cell => {
      const val = cell == null ? "" : String(cell);
      if (/[",\n]/.test(val)) {
        return '"' + val.replace(/"/g, '""') + '"';
      }
      return val;
    }).join(",");
  }

  function handleExportCsv() {
    const entries = loadEntries();
    if (!entries.length) {
      alert("No entries to export.");
      return;
    }
    const headers = [
      "Timestamp","Name","RoleLevel","Context","Score","ZoneLabel",
      "Bored%","Comfort%","Stretch%","Stress%","Panic%"
    ];
    questions.forEach(q => headers.push(`Q${q.id}`));
    const rows = [toCsvRow(headers)];

    entries.forEach(entry => {
      const zp = entry.zonePercents || {};
      const responses = entry.responses || {};
      const row = [
        entry.timestamp,
        entry.name || "",
        entry.roleLevel || "",
        entry.context || "",
        entry.score,
        descriptions[entry.score]?.label || "",
        zp.bored ?? "",
        zp.comfort ?? "",
        zp.stretch ?? "",
        zp.stress ?? "",
        zp.panic ?? ""
      ];
      questions.forEach(q => row.push(responses[q.id] ?? ""));
      rows.push(toCsvRow(row));
    });

    const blob = new Blob([rows.join("\r\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "bored_to_panic_entries.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function handleClearEntries() {
    if (!confirm("Clear all saved entries in this browser?")) return;
    localStorage.removeItem("boredToPanicEntries");
    renderEntriesTableAndDropdown();
  }

  function handleLoadEntry() {
    const idx = loadSelect.value;
    if (idx === "") return;
    const entries = loadEntries();
    const entry = entries[parseInt(idx, 10)];
    if (!entry) return;

    document.getElementById("personName").value = entry.name || "";
    roleLevelSelect.value = entry.roleLevel || "";

    if (entry.context) {
      const match = Array.from(contextSelect.options).find(o => o.value === entry.context);
      if (match) {
        contextSelect.value = entry.context;
        contextCustom.value = "";
        contextCustom.style.display = "none";
      } else {
        contextSelect.value = "User-defined";
        contextCustom.value = entry.context;
        contextCustom.style.display = "block";
      }
    } else {
      contextSelect.value = "";
      contextCustom.value = "";
      contextCustom.style.display = "none";
    }

    questions.forEach(q => {
      document
        .querySelectorAll(`label.response-radio input[name="q${q.id}"]`)
        .forEach(r => {
          r.checked = false;
          r.parentElement.classList.remove("selected");
        });
    });

    if (entry.responses) {
      Object.entries(entry.responses).forEach(([qid, val]) => {
        const radio = document.querySelector(`label.response-radio input[name="q${qid}"][value="${val}"]`);
        if (radio) {
          radio.checked = true;
          radio.parentElement.classList.add("selected");
        }
      });
    }

    latestResponses = entry.responses || null;
    let percents = entry.zonePercents;
    let raw = entry.zoneRaw;

    if (!percents && entry.responses) {
      const calc = calculateZoneScores(entry.responses);
      percents = calc.percents;
      raw = calc.raw;
    }
    if (!percents) {
      alert("This saved entry does not contain enough data to reconstruct scores.");
      return;
    }

    latestZonePercents = percents;
    latestZoneRaw = raw;
    const entriesArr = Object.entries(percents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["stretch", 0];
    latestTopZone = topZone;
    latestTopScore = topScore;
    const role = roleLevelSelect.value || null;
    renderResults(percents, role, topZone, topScore);
  }

  saveButton.addEventListener("click", handleSave);
  exportButton.addEventListener("click", handleExportCsv);
  clearButton.addEventListener("click", handleClearEntries);
  loadSelect.addEventListener("change", handleLoadEntry);

  /* ---------- Fullscreen ---------- */

  document.getElementById("fullscreenToggle").addEventListener("click", () => {
    if (!document.fullscreenElement) {
      boardWrapper.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });

  /* ---------- PDF export with expanded sections & header/footer ---------- */

  async function handleExportPdf() {
    const { jsPDF } = window.jspdf;

    // Capture currently open sections
    const sectionEls = Array.from(document.querySelectorAll(".question-section"));
    const openState = sectionEls.map(el => el.classList.contains("open"));

    // Expand all sections
    sectionEls.forEach(el => el.classList.add("open"));

    // Switch to export layout
    boardInner.classList.add("export-mode");

    // Add export header
    const exportHeader = document.createElement("div");
    exportHeader.className = "export-header";
    const name = document.getElementById("personName").value.trim() || "Not specified";
    const role = roleLabels[roleLevelSelect.value] || (roleLevelSelect.value || "Not specified");
    let contextValue = "";
    if (contextSelect.value === "User-defined") {
      contextValue = contextCustom.value.trim();
    } else {
      contextValue = contextSelect.value || "";
    }
    const contextLabel = contextValue || "Not specified";
    const now = new Date();
    const dateString = now.toLocaleString();

    const aboutExport = "Both Bored and Panic are zones that feel negative and rarely support learning. We spend time in Stretch to grow our Comfort zone, and to learn how to recover when we have to visit Stress. This assessment is about understanding where that time is spent and whether the daily \"exercise\" of work is helping or hindering that growth.";

    const reviewExport = latestReviewText || "Suggested time to redo this assessment will appear here once you have calculated your results.";

    exportHeader.innerHTML = `
      <div class="export-header-title">Bored to Panic assessment</div>
      <div class="export-header-meta">
        Name: ${name} · Role: ${role} · Context: ${contextLabel} · Date: ${dateString}
      </div>
      <div style="margin-top:0.35rem;font-size:0.8rem;">
        ${aboutExport}
      </div>
      <div style="margin-top:0.25rem;font-size:0.8rem;"><strong>${reviewExport}</strong></div>
    `;
    boardInner.insertBefore(exportHeader, boardInner.firstChild);

    // Add export footer
    const exportFooter = document.createElement("div");
    exportFooter.className = "export-footer";
    const url = "https://imthebus.co.uk/web-tools/bored-to-panic.html";
    exportFooter.textContent = `Generated from IMTHEBUS Bored to Panic tool (${url}) on ${dateString}`;
    boardInner.appendChild(exportFooter);

    // Render to canvas and PDF
    const canvas = await html2canvas(boardWrapper, { scale: 2 });
    const img = canvas.toDataURL("image/jpeg", 0.9);
    const pdf = new jsPDF("p", "mm", "a4");
    const width = pdf.internal.pageSize.getWidth();
    const height = (canvas.height * width) / canvas.width;
    pdf.addImage(img, "JPEG", 0, 0, width, height);
    pdf.save("Bored_to_Panic_Assessment.pdf");

    // Cleanup: remove header/footer and restore layout
    exportHeader.remove();
    exportFooter.remove();
    boardInner.classList.remove("export-mode");

    // Restore section open state
    sectionEls.forEach((el, idx) => {
      el.classList.toggle("open", openState[idx]);
    });
  }

  exportPdfButton.addEventListener("click", handleExportPdf);
</script>
</body>
</html>
