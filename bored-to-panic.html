<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IMTHEBUS tools – Bored to Panic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared base styles and core helpers -->
  <link rel="stylesheet" href="assets/imthebus-base.css" />
  <script src="assets/imthebus-core.js" defer></script>

  <!-- External libs used only on this page -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

  <style>
    main.page {
      align-items: flex-start;
    }

    .b2p-sidebar {
      position: relative;
      padding-top: 1.4rem;
    }

    .b2p-sidebar-inner {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .b2p-sidebar-title {
      font-size: 1.15rem;
      margin: 0;
      line-height: 1.2;
    }

    .b2p-sidebar-text {
      font-size: 0.9rem;
      margin: 0;
    }

    .b2p-sidebar-meta-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
    }

    .b2p-sidebar-meta-row label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.1rem;
    }

    .b2p-sidebar-meta-row input,
    .b2p-sidebar-meta-row select {
      width: 100%;
      font: inherit;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 2px solid #000;
      padding: 0.28rem 0.55rem;
      background: #fff;
    }

    .b2p-context-row {
      margin-top: 0.25rem;
    }

    .b2p-context-custom {
      margin-top: 0.3rem;
    }

    .b2p-context-custom input {
      width: 100%;
      font: inherit;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 2px solid #000;
      padding: 0.28rem 0.55rem;
      background: #fff;
    }

    .b2p-assessment-count {
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }

    /* Sidebar collapsible sections */

    .sidebar-section {
      border-radius: 18px;
      border: 2px solid #000;
      background: #fff;
      margin-top: 0.4rem;
      overflow: hidden;
    }

    .sidebar-section-header {
      width: 100%;
      background: #fff;
      border: none;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 0.45rem 0.7rem;
      font: inherit;
      cursor: pointer;
    }

    .sidebar-section-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .sidebar-section-toggle {
      font-size: 0.95rem;
      padding-left: 0.5rem;
    }

    .sidebar-section-body {
      padding: 0.35rem 0.7rem 0.55rem;
      font-size: 0.82rem;
      display: none;
    }

    .sidebar-section.open .sidebar-section-body {
      display: block;
    }

    .sidebar-section-body p {
      margin: 0.25rem 0;
    }

    .sidebar-section-body ul {
      margin: 0.25rem 0 0.25rem 1rem;
      padding: 0;
    }

    .b2p-sidebar-load-row {
      margin-top: 0.4rem;
      font-size: 0.82rem;
    }

    .b2p-sidebar-load-row label {
      display: block;
      margin-bottom: 0.1rem;
    }

    .b2p-sidebar-load-row select {
      width: 100%;
      font: inherit;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 2px solid #000;
      padding: 0.25rem 0.55rem;
      background: #fff;
    }

    .sidebar-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.3rem;
      margin-top: 0.55rem;
    }

    .sidebar-buttons button {
      font: inherit;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 2px solid #000;
      padding: 0.3rem 0.4rem;
      cursor: pointer;
      background: #fff;
      transition: background 0.12s ease-out, transform 0.08s ease-out;
      white-space: nowrap;
    }

    .sidebar-buttons button.primary {
      background: #000;
      color: #fff;
    }

    .sidebar-buttons button.danger {
      border-color: #b91c1c;
    }

    .sidebar-buttons button:hover {
      transform: translateY(1px);
    }

    .sidebar-note {
      font-size: 0.78rem;
      margin: 0.4rem 0 0;
    }

    /* Board layout */

    .b2p-board-inner {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .b2p-board-header {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      align-items: flex-start;
      margin-bottom: 0.25rem;
    }

    .b2p-board-header .page-title {
      margin-bottom: 0.15rem;
    }

    .b2p-board-header .page-subtitle {
      max-width: 34rem;
      margin: 0;
      font-size: 0.9rem;
    }

    .board-toolbar {
      display: flex;
      gap: 0.35rem;
      align-items: center;
    }

    .board-toolbar .btn {
      font-size: 0.8rem;
    }

    .b2p-board-body {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 0.75rem;
      align-items: flex-start;
    }

    .b2p-column {
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
    }

    /* Question sections */

    .question-section {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      margin-bottom: 0.45rem;
      overflow: hidden;
    }

    .question-section-header {
      padding: 0.45rem 0.7rem;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .question-section-title-group {
      display: flex;
      flex-direction: column;
    }

    .question-section-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .question-section-subtitle {
      font-size: 0.78rem;
    }

    .question-section-toggle {
      font-size: 0.95rem;
      padding-left: 0.5rem;
    }

    .question-section-body {
      display: none;
      padding: 0 0.7rem 0.55rem;
    }

    .question-section.open .question-section-body {
      display: block;
    }

    .question-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .question-table thead th {
      border-bottom: 1px solid #000;
      padding: 0.2rem 0.2rem;
    }

    .question-table tbody td {
      padding: 0.25rem 0.2rem;
      vertical-align: middle;
    }

    .question-text {
      width: 60%;
      text-align: left;
    }

    .response-cell {
      text-align: center;
    }

    .response-radio {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid #000;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .response-radio input {
      display: none;
    }

    .response-radio span {
      user-select: none;
    }

    .response-radio.selected {
      background: #000;
      color: #fff;
    }

    .calculate-row {
      margin-top: 0.65rem;
      display: flex;
      justify-content: flex-start;
    }

    .calculate-row button {
      font: inherit;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #000;
      color: #fff;
      padding: 0.45rem 1.1rem;
      cursor: pointer;
      transition: background 0.15s ease-out, transform 0.08s ease-out;
    }

    .calculate-row button.calculating {
      background: #1f2937;
      transform: translateY(1px);
    }

    /* Right column panels */

    .donut-panel {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.6rem 0.8rem 0.7rem;
      margin-bottom: 0.6rem;
    }

    .donut-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.3rem;
    }

    .donut-header-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .donut-header-note {
      font-size: 0.75rem;
      color: #555;
    }

    #zoneRing {
      width: 100%;
      height: 220px;
      display: block;
    }

    .zone-legend-row {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      margin-top: 0.15rem;
    }

    .zone-legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .zone-legend-label {
      flex: 1;
    }

    .zone-legend-value {
      min-width: 2.2rem;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .results-panel,
    .overall-panel,
    .entries-panel {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.7rem 0.8rem;
      font-size: 0.85rem;
      margin-bottom: 0.6rem;
    }

    .results-panel h3,
    .overall-panel h3,
    .entries-panel h3 {
      margin: 0 0 0.4rem;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .results-panel p,
    .overall-panel p {
      margin: 0.25rem 0;
    }

    .results-panel table,
    .overall-panel table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.35rem;
      font-size: 0.8rem;
    }

    .results-panel th,
    .results-panel td,
    .overall-panel th,
    .overall-panel td {
      border: 1px solid #000;
      padding: 0.25rem 0.3rem;
      vertical-align: top;
    }

    .conversation-prompts {
      margin-top: 0.4rem;
      font-size: 0.8rem;
    }

    .conversation-prompts ul {
      margin: 0.25rem 0 0.25rem 1rem;
      padding: 0;
    }

    .entries-panel table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .entries-panel th,
    .entries-panel td {
      border: 1px solid #000;
      padding: 0.2rem 0.25rem;
      text-align: left;
    }

    .entries-panel th {
      background: #f5f5f5;
    }

    /* Export tweaks */

    .export-header {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.6rem 0.8rem 0.7rem;
      margin-bottom: 0.6rem;
      font-size: 0.85rem;
    }

    .export-header-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 0.2rem;
    }

    .export-header-meta {
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
    }

    .export-highlight {
      font-size: 0.82rem;
      margin-bottom: 0.25rem;
    }

    .export-suggestion {
      font-size: 0.8rem;
      font-style: italic;
    }

    .export-footer {
      margin-top: 0.6rem;
      font-size: 0.78rem;
    }

    .export-mode {
      background: #fff;
    }

    @media (max-width: 960px) {
      .b2p-board-body {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body data-counter-key="bored-to-panic">
  <div data-include="partials/header.html"></div>

  <main class="page">
    <!-- Sidebar -->
    <aside class="sidebar-card b2p-sidebar">
      <div class="b2p-sidebar-inner">
        <h2 class="b2p-sidebar-title">Bored to Panic assessment</h2>
        <p class="b2p-sidebar-text">
          This tool helps you and your manager understand how work feels at the moment. It maps your answers
          to five zones: Bored, Comfort, Stretch, Stress and Panic, giving you a shared language for how
          work feels and where pressure is landing.
        </p>

        <!-- Details first, open by default -->
        <div class="sidebar-section open" id="detailsSection">
          <button type="button" class="sidebar-section-header">
            <span class="sidebar-section-title">Details for this assessment</span>
            <span class="sidebar-section-toggle">+</span>
          </button>
          <div class="sidebar-section-body">
            <div class="b2p-sidebar-meta-row">
              <div>
                <label for="personName">Name (optional)</label>
                <input id="personName" type="text" placeholder="Name" />
              </div>
              <div>
                <label for="roleLevel">Role level</label>
                <select id="roleLevel">
                  <option value="">Select role level</option>
                  <option value="L1">L1 – Operator</option>
                  <option value="L2">L2 – Senior operator</option>
                  <option value="L3">L3 – Supervisor</option>
                  <option value="L4">L4 – Manager</option>
                  <option value="L5">L5 – Director</option>
                </select>
              </div>
            </div>

            <div class="b2p-context-row">
              <label for="contextSelect">Context</label>
              <select id="contextSelect">
                <option value="">Whole role</option>
                <option value="Last 2 weeks">Last 2 weeks</option>
                <option value="Last 3 months">Last 3 months</option>
                <option value="Busy season / peak">Busy season / peak</option>
                <option value="Specific project">Specific project</option>
                <option value="User-defined">Something else (describe)</option>
              </select>
            </div>

            <div class="b2p-context-custom" id="contextCustomWrapper" style="display:none;">
              <label for="contextCustom">Describe the context</label>
              <input id="contextCustom" type="text" placeholder="For example: stocktake week, new role, etc." />
            </div>

            <p class="b2p-assessment-count">
              Assessments completed in this browser: <strong id="assessmentCount">0</strong>
            </p>
          </div>
        </div>

        <!-- About second -->
        <div class="sidebar-section" id="aboutSection">
          <button type="button" class="sidebar-section-header">
            <span class="sidebar-section-title">About this tool</span>
            <span class="sidebar-section-toggle">+</span>
          </button>
          <div class="sidebar-section-body">
            <p>
              Both Bored and Panic are zones we do not enjoy. They are not places where we feel safely
              challenged or comfortable, and they rarely support learning.
            </p>
            <p>
              We spend time in <strong>Stretch</strong> to expand our Comfort zone, and we learn how to
              recover when we have to visit <strong>Stress</strong>. This assessment is about understanding
              where you currently spend your time and whether the daily “exercise” of work is helping or
              hindering that growth.
            </p>
          </div>
        </div>

        <div class="sidebar-section">
          <button type="button" class="sidebar-section-header">
            <span class="sidebar-section-title">Saved assessments</span>
            <span class="sidebar-section-toggle">+</span>
          </button>
          <div class="sidebar-section-body">
            <div class="b2p-sidebar-load-row">
              <label for="loadEntry">Load a previous result</label>
              <select id="loadEntry">
                <option value="">Select saved entry</option>
              </select>
            </div>

            <div class="sidebar-buttons">
              <button id="saveEntry" type="button" class="primary">Save current view</button>
              <button id="exportCsv" type="button">Export CSV</button>
              <button id="clearEntries" type="button" class="danger">Clear all</button>
            </div>

            <p class="sidebar-note">
              Entries stay in this browser only. Use CSV or PDF to keep a record elsewhere.
            </p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Board -->
    <section class="board-wrapper" id="boardWrapper">
      <div class="board-inner-shell b2p-board-inner" id="boardInner">
        <div class="b2p-board-header">
          <div>
            <div class="page-title">Bored to Panic assessment board</div>
            <p class="page-subtitle">
              Map where your time sits between Bored, Comfort, Stretch, Stress and Panic, then compare it to
              a typical pattern for your role level.
            </p>
          </div>
          <div class="board-toolbar">
            <button type="button" class="btn btn-pill-small" id="fullscreenToggle">Fullscreen board</button>
            <button type="button" class="btn btn-pill-small" id="exportPdf">Save as PDF</button>
          </div>
        </div>

        <div class="b2p-board-body" id="boardBody">
          <!-- Left: questions -->
          <div class="b2p-column">
            <div id="questionSections"></div>
            <div class="calculate-row">
              <button id="calculateFromQuestions" type="button">Calculate from answers</button>
            </div>
          </div>

          <!-- Right: ring chart and results -->
          <div class="b2p-column">
            <div class="donut-panel">
              <div class="donut-header">
                <div class="donut-header-title">Zone pattern</div>
                <div class="donut-header-note" id="donutLabel">
                  Equal starting pattern. Updates after calculation.
                </div>
              </div>
              <canvas id="zoneRing" width="260" height="220"></canvas>
              <div id="zoneRingLegend"></div>
            </div>

            <div class="results-panel">
              <h3>Calculated zone and scores</h3>
              <div id="calculationResults">
                Answer the questions and click <strong>Calculate from answers</strong> to see your
                distribution across Bored, Comfort, Stretch, Stress and Panic.
              </div>
            </div>

            <div class="overall-panel">
              <h3>Overall scale result</h3>
              <div id="overallResult">
                Select a role level to compare your pattern against a typical target for that role.
              </div>
            </div>

            <div class="entries-panel">
              <h3>Recorded entries in this browser</h3>
              <table id="entriesTable">
                <thead>
                  <tr>
                    <th>Timestamp</th>
                    <th>Bored%</th>
                    <th>Comfort%</th>
                    <th>Stretch%</th>
                    <th>Stress%</th>
                    <th>Panic%</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div data-include="partials/footer.html"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      /* Sidebar collapsibles */
      document.querySelectorAll(".sidebar-section").forEach(section => {
        const header = section.querySelector(".sidebar-section-header");
        header.addEventListener("click", () => {
          section.classList.toggle("open");
        });
      });

      const contextSelect = document.getElementById("contextSelect");
      const contextCustomWrapper = document.getElementById("contextCustomWrapper");
      const contextCustom = document.getElementById("contextCustom");

      contextSelect.addEventListener("change", () => {
        if (contextSelect.value === "User-defined") {
          contextCustomWrapper.style.display = "block";
        } else {
          contextCustomWrapper.style.display = "none";
          contextCustom.value = "";
        }
      });

      /* Question data */

      const questions = [
        { id: 1,  text: "I regularly take on tasks that feel stretching but achievable." },
        { id: 2,  text: "Most of my time is spent on familiar, routine tasks." },
        { id: 3,  text: "My workload often feels intense or heavy." },
        { id: 4,  text: "I have a predictable core to my role that I can rely on." },
        { id: 5,  text: "I regularly feel close to overload or panic." },
        { id: 6,  text: "I have periods where I feel under-used or not challenged." },
        { id: 7,  text: "I am given opportunities that stretch my skills and experience." },
        { id: 8,  text: "I have clear goals that push me to grow." },
        { id: 9,  text: "I adapt how I work to achieve good results." },   // reverse scored
        { id: 10, text: "I feel positively challenged and encouraged to grow." },
        { id: 11, text: "My days are stable and contain few unexpected demands." },
        { id: 12, text: "My workload builds up faster than I can process it." },
        { id: 13, text: "I need to switch rapidly between competing tasks." },
        { id: 14, text: "I take on responsibilities that require learning and adaptation." },
        { id: 15, text: "I feel energised or stimulated by new challenges." },
        { id: 16, text: "I find myself firefighting without space to recover." },
        { id: 17, text: "I complete routine tasks smoothly and confidently." },
        { id: 18, text: "I manage situations involving tight deadlines or time pressure." },
        { id: 19, text: "I feel under used or under challenged in parts of my role." },
        { id: 20, text: "I can predict how most of my day or week will unfold." },
        { id: 21, text: "I feel a mild sense of pressure that helps me stay focused." },
        { id: 22, text: "I take on tasks that sit outside my comfort zone." },
        { id: 23, text: "I experience periods where I cannot think clearly due to pressure." },
        { id: 24, text: "I feel confident in handling unexpected problems when they arise." },
        { id: 25, text: "I avoid tasks that feel too overwhelming." }
      ];

      const sections = [
        {
          id: "workload",
          title: "Workload and pace",
          subtitle: "How fast work comes at you and how heavy it feels.",
          questionIds: [3, 5, 12, 13, 16, 18]
        },
        {
          id: "challenge",
          title: "Challenge and growth",
          subtitle: "Stretch, learning and positive pressure.",
          questionIds: [1, 7, 8, 10, 14, 15, 22, 21]
        },
        {
          id: "stability",
          title: "Stability and routine",
          subtitle: "Predictability, habits and smooth running.",
          questionIds: [2, 4, 11, 17, 20, 24]
        },
        {
          id: "capacity",
          title: "Capacity and under / over use",
          subtitle: "Whether your role feels too small or too big.",
          questionIds: [6, 19, 25]
        },
        {
          id: "control",
          title: "Control and problem solving",
          subtitle: "Clarity, confidence and reacting under pressure.",
          questionIds: [9, 21, 23]
        }
      ];

      const reverseScored = new Set([9]);

      const responseOptions = [
        { value: 0, label: "1" },
        { value: 1, label: "2" },
        { value: 2, label: "3" },
        { value: 3, label: "4" },
        { value: 4, label: "5" }
      ];

      const zoneQuestions = {
        bored:   [2, 6, 9, 19, 20],
        comfort: [4, 11, 17, 20, 24],
        stretch: [1, 7, 8, 10, 14, 15, 18, 21, 22],
        stress:  [3, 12, 13],
        panic:   [5, 16, 23, 25]
      };

      const zoneLabels = {
        bored: "Bored",
        comfort: "Comfort",
        stretch: "Stretch",
        stress: "Stress",
        panic: "Panic"
      };

      /* Ring chart colours */

      const zoneColors = {
        bored:   { fill: "rgba(17,24,39,0.35)", stroke: "#111827" },
        comfort: { fill: "rgba(96,165,250,0.8)", stroke: "#1d4ed8" },
        stretch: { fill: "rgba(74,222,128,0.8)", stroke: "#15803d" },
        stress:  { fill: "rgba(251,191,36,0.8)", stroke: "#b45309" },
        panic:   { fill: "rgba(248,113,113,0.8)", stroke: "#b91c1c" }
      };

      const roleTargets = {
        L1: { bored: 20, comfort: 45, stretch: 30, stress: 5,  panic: 0 },
        L2: { bored: 15, comfort: 40, stretch: 35, stress: 10, panic: 0 },
        L3: { bored: 10, comfort: 30, stretch: 40, stress: 20, panic: 0 },
        L4: { bored: 8,  comfort: 25, stretch: 45, stress: 22, panic: 0 },
        L5: { bored: 5,  comfort: 20, stretch: 55, stress: 20, panic: 0 }
      };

      const roleLabels = {
        L1: "Operator",
        L2: "Senior Operator",
        L3: "Supervisor",
        L4: "Manager",
        L5: "Director"
      };

      const roleLevelSelect = document.getElementById("roleLevel");
      const saveButton = document.getElementById("saveEntry");
      const exportButton = document.getElementById("exportCsv");
      const exportPdfButton = document.getElementById("exportPdf");
      const clearButton = document.getElementById("clearEntries");
      const loadSelect = document.getElementById("loadEntry");
      const calculationResults = document.getElementById("calculationResults");
      const overallResult = document.getElementById("overallResult");
      const entriesTableBody = document.querySelector("#entriesTable tbody");
      const calculateButton = document.getElementById("calculateFromQuestions");
      const donutLabel = document.getElementById("donutLabel");
      const boardWrapper = document.getElementById("boardWrapper");
      const boardInner = document.getElementById("boardInner");
      const assessmentCountSpan = document.getElementById("assessmentCount");

      let latestZonePercents = null;
      let latestZoneRaw = null;
      let latestTopZone = null;
      let latestTopScore = null;
      let latestResponses = null;
      let latestScaleScore = null;
      let latestFollowupText = "";

      /* Assessment counter */

      function loadAssessmentCount() {
        const raw = localStorage.getItem("boredToPanicCount");
        const n = raw ? parseInt(raw, 10) || 0 : 0;
        assessmentCountSpan.textContent = n;
        return n;
      }

      function incrementAssessmentCount() {
        const n = loadAssessmentCount() + 1;
        localStorage.setItem("boredToPanicCount", String(n));
        assessmentCountSpan.textContent = n;
      }

      loadAssessmentCount();

      /* Build questions UI */

      const questionSectionsContainer = document.getElementById("questionSections");
      const questionMap = new Map(questions.map(q => [q.id, q]));

      function buildQuestions() {
        sections.forEach(section => {
          const wrapper = document.createElement("div");
          wrapper.className = "question-section";

          const header = document.createElement("div");
          header.className = "question-section-header";

          const titleGroup = document.createElement("div");
          titleGroup.className = "question-section-title-group";

          const title = document.createElement("div");
          title.className = "question-section-title";
          title.textContent = section.title;

          const subtitle = document.createElement("div");
          subtitle.className = "question-section-subtitle";
          subtitle.textContent = section.subtitle;

          titleGroup.appendChild(title);
          titleGroup.appendChild(subtitle);

          const toggle = document.createElement("div");
          toggle.className = "question-section-toggle";
          toggle.textContent = "+";

          header.appendChild(titleGroup);
          header.appendChild(toggle);
          wrapper.appendChild(header);

          const body = document.createElement("div");
          body.className = "question-section-body";

          const table = document.createElement("table");
          table.className = "question-table";

          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          const thText = document.createElement("th");
          thText.className = "question-text";
          thText.textContent = "Statement";
          headRow.appendChild(thText);

          responseOptions.forEach(opt => {
            const th = document.createElement("th");
            th.textContent = opt.label;
            headRow.appendChild(th);
          });

          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");

          section.questionIds.forEach(id => {
            const q = questionMap.get(id);
            if (!q) return;

            const tr = document.createElement("tr");
            const tdText = document.createElement("td");
            tdText.className = "question-text";
            tdText.textContent = q.text;
            tr.appendChild(tdText);

            responseOptions.forEach(opt => {
              const td = document.createElement("td");
              td.className = "response-cell";

              const label = document.createElement("label");
              label.className = "response-radio";
              const input = document.createElement("input");
              input.type = "radio";
              input.name = `q${q.id}`;
              input.value = opt.value;

              const span = document.createElement("span");
              span.textContent = opt.label;

              label.appendChild(input);
              label.appendChild(span);
              td.appendChild(label);
              tr.appendChild(td);

              label.addEventListener("click", () => {
                document
                  .querySelectorAll(`label.response-radio input[name="q${q.id}"]`)
                  .forEach(r => r.parentElement.classList.remove("selected"));
                label.classList.add("selected");
              });
            });

            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          body.appendChild(table);
          wrapper.appendChild(body);
          questionSectionsContainer.appendChild(wrapper);

          header.addEventListener("click", () => {
            const isOpen = wrapper.classList.contains("open");
            document
              .querySelectorAll(".question-section")
              .forEach(sec => sec.classList.remove("open"));
            if (!isOpen) {
              wrapper.classList.add("open");
            }
          });
        });

        const firstSection = document.querySelector(".question-section");
        if (firstSection) firstSection.classList.add("open");
      }

      buildQuestions();

      /* Ring chart */

      const ringCanvas = document.getElementById("zoneRing");
      const ringCtx = ringCanvas.getContext("2d");

      function drawRingChart(data) {
        const w = ringCanvas.width;
        const h = ringCanvas.height;
        const cx = w / 2;
        const cy = h / 2;
        const maxRadius = Math.min(w, h) / 2 - 8;

        ringCtx.clearRect(0, 0, w, h);

        const order = ["bored", "comfort", "stretch", "stress", "panic"];
        const values = data || { bored: 20, comfort: 20, stretch: 20, stress: 20, panic: 20 };

        let innerR = 0;
        order.forEach(zone => {
          const pct = values[zone] ?? 0;
          const outerR = innerR + maxRadius * (pct / 100);
          if (outerR <= innerR) return;

          ringCtx.beginPath();
          ringCtx.arc(cx, cy, outerR, 0, 2 * Math.PI);
          ringCtx.arc(cx, cy, innerR, 2 * Math.PI, 0, true);
          ringCtx.closePath();
          ringCtx.fillStyle = zoneColors[zone].fill;
          ringCtx.fill();

          innerR = outerR;
        });

        ringCtx.beginPath();
        ringCtx.arc(cx, cy, maxRadius, 0, 2 * Math.PI);
        ringCtx.strokeStyle = "#000";
        ringCtx.lineWidth = 2;
        ringCtx.stroke();
      }

      function updateRingLegend(data, labelText) {
        const legend = document.getElementById("zoneRingLegend");
        const order = ["bored", "comfort", "stretch", "stress", "panic"];
        const values = data || { bored: 20, comfort: 20, stretch: 20, stress: 20, panic: 20 };
        const rows = order
          .map(zone => {
            const pct = values[zone] ?? 0;
            return `
              <div class="zone-legend-row">
                <span class="zone-legend-swatch" style="background:${zoneColors[zone].stroke};"></span>
                <span class="zone-legend-label">${zoneLabels[zone]}</span>
                <span class="zone-legend-value">${pct}%</span>
              </div>
            `;
          })
          .join("");
        legend.innerHTML = rows;
        donutLabel.textContent = labelText;
      }

      drawRingChart(null);
      updateRingLegend(null, "Equal starting pattern. Updates after calculation.");

      /* Scoring */

      function getResponses() {
        const responses = {};
        for (const q of questions) {
          const checked = document.querySelector(`input[name="q${q.id}"]:checked`);
          if (!checked) return null;
          responses[q.id] = parseInt(checked.value, 10);
        }
        return responses;
      }

      function calculateZoneScores(responses) {
        const raw = {};
        const avg = {};
        let totalIntensity = 0;
        const zones = Object.keys(zoneQuestions);

        zones.forEach(zone => {
          const ids = zoneQuestions[zone];
          let sum = 0;
          ids.forEach(id => {
            const base = responses[id] ?? 0;
            const score = reverseScored.has(id) ? 4 - base : base;
            sum += score;
          });
          const mean = ids.length ? sum / ids.length : 0;
          raw[zone] = sum;
          avg[zone] = mean;
          totalIntensity += mean;
        });

        const percents = {};
        if (totalIntensity === 0) {
          zones.forEach(z => {
            percents[z] = 0;
          });
        } else {
          let running = 0;
          zones.forEach((zone, idx) => {
            if (idx === zones.length - 1) {
              percents[zone] = Math.max(0, 100 - running);
            } else {
              const p = Math.round((avg[zone] / totalIntensity) * 100);
              percents[zone] = p;
              running += p;
            }
          });
        }

        return { raw, percents };
      }

      function currentTarget(role) {
        return role ? roleTargets[role] : null;
      }

      function levelLabel(actual, ideal) {
        const diff = actual - ideal;
        if (Math.abs(diff) <= 5) return "close to target";
        if (diff > 5) return "higher than target";
        return "lower than target";
      }

      function zoneNarrative(zone, actual, ideal) {
        const level = levelLabel(actual, ideal);
        switch (zone) {
          case "bored":
            if (level === "higher than target")
              return "Boredom is high; explore extra responsibility or variety.";
            if (level === "lower than target")
              return "Boredom is low; capability is broadly in use.";
            return "Boredom is close to target; look at other zones for focus.";
          case "comfort":
            if (level === "higher than target")
              return "Comfort is high; consider adding some stretch work.";
            if (level === "lower than target")
              return "Comfort is low; stabilise core workload and routines.";
            return "Comfort is about right; keep the basics predictable.";
          case "stretch":
            if (level === "higher than target")
              return "Stretch is high; make sure support and clarity are strong.";
            if (level === "lower than target")
              return "Stretch is low; development work may be limited.";
            return "Stretch is on target; protect time for this.";
          case "stress":
            if (level === "higher than target")
              return "Stress is high; review priorities and capacity.";
            if (level === "lower than target")
              return "Stress is low; there may be spare capacity if needed.";
            return "Stress is close to target; keep an eye on recovery time.";
          case "panic":
            if (level === "higher than target")
              return "Panic is higher than expected; treat as a system issue.";
            if (level === "lower than target")
              return "Panic is low; keep boundaries and buffers in place.";
            return "Panic is around expected; still worth understanding triggers.";
          default:
            return "";
        }
      }

      function buildPatternCommentary(percents) {
        const flags = [];
        const praise = [];

        if (percents.panic >= 15) {
          flags.push(
            "Panic at or above 15%: dig into specific situations that feel overwhelming and agree changes to workload, boundaries and support."
          );
        } else if (percents.panic >= 10) {
          flags.push(
            "Panic between 10% and 15%: track patterns that tip things over the edge and agree how to spot them earlier."
          );
        }

        if (percents.stress >= 30) {
          flags.push(
            "Stress at or above 30%: high risk of fatigue or errors; review priorities and capacity."
          );
        }

        if (percents.stretch >= 40 && percents.stress <= 20 && percents.panic <= 5) {
          praise.push(
            "Strong time in Stretch with limited Stress and Panic suggests healthy challenge with support."
          );
        }

        if (percents.bored >= 25 && percents.stretch <= 20) {
          flags.push(
            "High Bored with low Stretch: development or variety may be limited; explore growth tasks."
          );
        }

        if (!flags.length && !praise.length) {
          praise.push(
            "No strong risk signals from this pattern. Still useful to ask what is helping it work well and what you would like more of."
          );
        }

        return { flags, praise };
      }

      function buildConversationPromptsHtml(percents) {
        const { flags, praise } = buildPatternCommentary(percents);
        let html = '<div class="conversation-prompts">';
        if (praise.length) {
          html += "<strong>What seems to be working:</strong><ul>";
          praise.forEach(p => {
            html += `<li>${p}</li>`;
          });
          html += "</ul>";
        }
        if (flags.length) {
          html += "<strong>Things to watch or adjust:</strong><ul>";
          flags.forEach(f => {
            html += `<li>${f}</li>`;
          });
          html += "</ul>";
        }
        html += "</div>";
        return html;
      }

      function getFollowupSuggestion(percents, role) {
        const target = currentTarget(role);
        const now = new Date();
        if (!target) {
          const weeks = 12;
          const future = new Date(now.getTime() + weeks * 7 * 24 * 60 * 60 * 1000);
          return {
            text: `Suggested time to redo this assessment: around ${
              weeks === 12 ? "3 months" : weeks + " weeks"
            }, around ${future.toLocaleDateString()}.`,
            dateLabel: future.toLocaleDateString()
          };
        }

        const zones = ["bored", "comfort", "stretch", "stress", "panic"];
        let sumDiff = 0;
        zones.forEach(z => {
          sumDiff += Math.abs((percents[z] ?? 0) - target[z]);
        });
        const avgDiff = sumDiff / zones.length;

        let weeks;
        if (avgDiff >= 18) weeks = 6;
        else if (avgDiff >= 14) weeks = 8;
        else if (avgDiff >= 10) weeks = 12;
        else if (avgDiff >= 6) weeks = 24;
        else weeks = 52;

        const future = new Date(now.getTime() + weeks * 7 * 24 * 60 * 60 * 1000);
        const label =
          weeks === 52
            ? "about a year"
            : weeks === 24
            ? "about 6 months"
            : weeks === 12
            ? "about 3 months"
            : `${weeks} weeks`;

        return {
          text: `Suggested time to redo this assessment: around ${label}, around ${future.toLocaleDateString()}.`,
          dateLabel: future.toLocaleDateString()
        };
      }

      function renderResults(percents, role, topZone, topScore) {
        const target = currentTarget(role);

        calculationResults.innerHTML = `
          <p><strong>Highest zone:</strong> ${zoneLabels[topZone]} (${topScore}%)</p>
          <p><strong>Pattern:</strong> Bored ${percents.bored}% · Comfort ${percents.comfort}% · Stretch ${percents.stretch}% · Stress ${percents.stress}% · Panic ${percents.panic}%</p>
          ${
            target
              ? `<table>
                   <thead>
                     <tr><th>Zone</th><th>Current</th><th>Target</th></tr>
                   </thead>
                   <tbody>
                     <tr><td>Bored</td><td>${percents.bored}%</td><td>${target.bored}%</td></tr>
                     <tr><td>Comfort</td><td>${percents.comfort}%</td><td>${target.comfort}%</td></tr>
                     <tr><td>Stretch</td><td>${percents.stretch}%</td><td>${target.stretch}%</td></tr>
                     <tr><td>Stress</td><td>${percents.stress}%</td><td>${target.stress}%</td></tr>
                     <tr><td>Panic</td><td>${percents.panic}%</td><td>${target.panic}%</td></tr>
                   </tbody>
                 </table>`
              : ""
          }
          ${buildConversationPromptsHtml(percents)}
        `;

        renderOverallScale(percents, role, topZone);
        drawRingChart(percents);
        updateRingLegend(percents, "Current pattern");
      }

      function renderOverallScale(percents, role, topZone) {
        const scoreMap = { bored: 1, comfort: 2, stretch: 3, stress: 4, panic: 5 };
        const score = scoreMap[topZone] || 3;
        latestScaleScore = score;
        const desc = {
          1: {
            label: "Bored",
            text: "Underloaded. Too little challenge or variety. Skills underused and development may stall.",
            manager: "Increase challenge, variety or responsibility. Clarify expectations for growth."
          },
          2: {
            label: "Comfort",
            text: "Workload feels manageable with low pressure. Reliable performance but limited stretch.",
            manager: "Keep the core stable but agree some stretch tasks or projects."
          },
          3: {
            label: "Stretch",
            text: "Healthy stretch zone. Work is challenging in a good way, with visible learning.",
            manager: "Protect this state, keep priorities clear and recognise the effort."
          },
          4: {
            label: "Stress",
            text: "High pressure and cognitive load. Work is being done but fatigue and error risk rise.",
            manager: "Re-prioritise, remove low value work or add temporary support."
          },
          5: {
            label: "Panic",
            text: "Demand exceeds capacity. Performance becomes unstable and reactive.",
            manager: "Intervene quickly. Adjust workload and support and treat it as a system issue."
          }
        }[score];

        const target = currentTarget(role);

        let html = `
          <p><strong>Overall position:</strong> ${desc.label} (score ${score}/5)</p>
          <p>${desc.text}</p>
          <p><strong>Manager focus:</strong> ${desc.manager}</p>
        `;

        if (target) {
          html += `<p><strong>Role pattern (${roleLabels[role]}):</strong> Bored ${target.bored}%, Comfort ${target.comfort}%, Stretch ${target.stretch}%, Stress ${target.stress}%, Panic ${target.panic}%.</p>`;
          html += `<table>
            <thead><tr><th>Zone</th><th>Comment</th></tr></thead>
            <tbody>
              ${["bored", "comfort", "stretch", "stress", "panic"]
                .map(z => {
                  const actual = percents[z] ?? 0;
                  const ideal = target[z] ?? 0;
                  return `<tr><td>${zoneLabels[z]}</td><td>${zoneNarrative(
                    z,
                    actual,
                    ideal
                  )}</td></tr>`;
                })
                .join("")}
            </tbody>
          </table>`;
        }

        const follow = getFollowupSuggestion(percents, role);
        latestFollowupText = follow.text;
        html += `<p style="margin-top:0.4rem;"><strong>${follow.text}</strong></p>`;

        overallResult.innerHTML = html;
      }

      /* Local storage */

      function loadEntries() {
        try {
          return JSON.parse(localStorage.getItem("boredToPanicEntries") || "[]");
        } catch {
          return [];
        }
      }

      function saveEntries(entries) {
        localStorage.setItem("boredToPanicEntries", JSON.stringify(entries));
      }

      function renderEntriesTableAndDropdown() {
        const entries = loadEntries();
        entriesTableBody.innerHTML = "";
        loadSelect.innerHTML = '<option value="">Select saved entry</option>';

        entries.forEach((entry, index) => {
          const tr = document.createElement("tr");
          const zp = entry.zonePercents || {};
          tr.innerHTML = `
            <td>${entry.timestamp}</td>
            <td>${zp.bored ?? ""}%</td>
            <td>${zp.comfort ?? ""}%</td>
            <td>${zp.stretch ?? ""}%</td>
            <td>${zp.stress ?? ""}%</td>
            <td>${zp.panic ?? ""}%</td>
          `;
          entriesTableBody.appendChild(tr);

          const opt = document.createElement("option");
          opt.value = index.toString();
          opt.textContent = `${entry.timestamp}`;
          loadSelect.appendChild(opt);
        });
      }

      renderEntriesTableAndDropdown();

      function storeEntry(autoSave) {
        if (!latestZonePercents || !latestTopZone) return;

        const name = document.getElementById("personName").value.trim();
        const roleLevel = roleLevelSelect.value || "";
        let contextValue = "";
        if (contextSelect.value === "User-defined") {
          contextValue = contextCustom.value.trim();
        } else {
          contextValue = contextSelect.value;
        }

        const scoreMap = { bored: 1, comfort: 2, stretch: 3, stress: 4, panic: 5 };
        const score = scoreMap[latestTopZone] || latestScaleScore || 3;
        const entries = loadEntries();
        const timestamp = new Date().toLocaleString();
        entries.push({
          timestamp,
          name,
          roleLevel,
          context: contextValue,
          score,
          zonePercents: latestZonePercents,
          zoneRaw: latestZoneRaw,
          responses: latestResponses
        });
        saveEntries(entries);
        renderEntriesTableAndDropdown();
      }

      function toCsvRow(cells) {
        return cells
          .map(cell => {
            const val = cell == null ? "" : String(cell);
            if (/[",\n]/.test(val)) {
              return '"' + val.replace(/"/g, '""') + '"';
            }
            return val;
          })
          .join(",");
      }

      function handleExportCsv() {
        const entries = loadEntries();
        if (!entries.length) {
          alert("No entries to export.");
          return;
        }
        const headers = [
          "Timestamp",
          "Name",
          "RoleLevel",
          "Context",
          "Score",
          "ZoneLabel",
          "Bored%",
          "Comfort%",
          "Stretch%",
          "Stress%",
          "Panic%"
        ];
        questions.forEach(q => headers.push(`Q${q.id}`));
        const rows = [toCsvRow(headers)];

        entries.forEach(entry => {
          const zp = entry.zonePercents || {};
          const responses = entry.responses || {};
          const top = Object.entries(zp).sort((a, b) => b[1] - a[1])[0];
          const topLabel = top ? zoneLabels[top[0]] : "";
          const row = [
            entry.timestamp,
            entry.name || "",
            entry.roleLevel || "",
            entry.context || "",
            entry.score,
            topLabel,
            zp.bored ?? "",
            zp.comfort ?? "",
            zp.stretch ?? "",
            zp.stress ?? "",
            zp.panic ?? ""
          ];
          questions.forEach(q => row.push(responses[q.id] ?? ""));
          rows.push(toCsvRow(row));
        });

        const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Bored_to_Panic_Entries.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function handleClearEntries() {
        if (!confirm("Clear all saved entries in this browser?")) return;
        localStorage.removeItem("boredToPanicEntries");
        renderEntriesTableAndDropdown();
      }

      function handleLoadEntry() {
        const idx = parseInt(loadSelect.value, 10);
        if (Number.isNaN(idx)) return;

        const entries = loadEntries();
        const entry = entries[idx];
        if (!entry) return;

        document.getElementById("personName").value = entry.name || "";
        roleLevelSelect.value = entry.roleLevel || "";

        if (entry.context) {
          const preset = Array.from(contextSelect.options).some(
            opt => opt.value === entry.context
          );
          if (preset) {
            contextSelect.value = entry.context;
            contextCustomWrapper.style.display = "none";
            contextCustom.value = "";
          } else {
            contextSelect.value = "User-defined";
            contextCustomWrapper.style.display = "block";
            contextCustom.value = entry.context;
          }
        } else {
          contextSelect.value = "";
          contextCustomWrapper.style.display = "none";
          contextCustom.value = "";
        }

        questions.forEach(q => {
          document
            .querySelectorAll(`label.response-radio input[name="q${q.id}"]`)
            .forEach(r => {
              r.checked = false;
              r.parentElement.classList.remove("selected");
            });
        });

        if (entry.responses) {
          Object.entries(entry.responses).forEach(([qid, val]) => {
            const radio = document.querySelector(
              `label.response-radio input[name="q${qid}"][value="${val}"]`
            );
            if (radio) {
              radio.checked = true;
              radio.parentElement.classList.add("selected");
            }
          });
        }

        latestResponses = entry.responses || null;
        let percents = entry.zonePercents;
        let raw = entry.zoneRaw;

        if (!percents && entry.responses) {
          const calc = calculateZoneScores(entry.responses);
          percents = calc.percents;
          raw = calc.raw;
        }
        if (!percents) {
          alert("This saved entry does not contain enough data to reconstruct scores.");
          return;
        }

        latestZonePercents = percents;
        latestZoneRaw = raw;
        const entriesArr = Object.entries(percents).sort((a, b) => b[1] - a[1]);
        const [topZone, topScore] = entriesArr[0] || ["stretch", 0];
        latestTopZone = topZone;
        latestTopScore = topScore;
        const role = roleLevelSelect.value || null;
        renderResults(percents, role, topZone, topScore);
      }

      saveButton.addEventListener("click", () => storeEntry(false));
      exportButton.addEventListener("click", handleExportCsv);
      clearButton.addEventListener("click", handleClearEntries);
      loadSelect.addEventListener("change", handleLoadEntry);

      /* Calculate – default role to L1 if not set */

      function handleCalculate() {
        if (!roleLevelSelect.value) {
          roleLevelSelect.value = "L1";   // assume Operator
        }

        const responses = getResponses();
        if (!responses) {
          alert("Please answer all questions before calculating.");
          return;
        }

        calculateButton.classList.add("calculating");
        boardWrapper.classList.add("calculated");

        const { raw, percents } = calculateZoneScores(responses);
        const entriesArr = Object.entries(percents).sort((a, b) => b[1] - a[1]);
        const [topZone, topScore] = entriesArr[0] || ["stretch", 0];

        latestZonePercents = percents;
        latestZoneRaw = raw;
        latestTopZone = topZone;
        latestTopScore = topScore;
        latestResponses = responses;

        const role = roleLevelSelect.value || null;
        renderResults(percents, role, topZone, topScore);

        storeEntry(true);
        incrementAssessmentCount();

        setTimeout(() => {
          calculateButton.classList.remove("calculating");
          boardWrapper.classList.remove("calculated");
        }, 1200);
      }

      calculateButton.addEventListener("click", handleCalculate);

      roleLevelSelect.addEventListener("change", () => {
        if (!latestZonePercents) return;
        const role = roleLevelSelect.value || null;
        const entriesArr = Object.entries(latestZonePercents).sort((a, b) => b[1] - a[1]);
        const [topZone, topScore] = entriesArr[0] || ["stretch", 0];
        renderResults(latestZonePercents, role, topZone, topScore);
      });

      /* Fullscreen */

      document.getElementById("fullscreenToggle").addEventListener("click", () => {
        if (!document.fullscreenElement) {
          boardWrapper.requestFullscreen?.();
        } else {
          document.exitFullscreen?.();
        }
      });

      /* PDF export */

      async function handleExportPdf() {
        const { jsPDF } = window.jspdf;

        const sectionEls = Array.from(document.querySelectorAll(".question-section"));
        const openState = sectionEls.map(el => el.classList.contains("open"));
        sectionEls.forEach(el => el.classList.add("open"));

        boardInner.classList.add("export-mode");

        const exportHeader = document.createElement("div");
        exportHeader.className = "export-header";
        const name = document.getElementById("personName").value.trim() || "Not specified";
        const role =
          roleLabels[roleLevelSelect.value] ||
          (roleLevelSelect.value || "Not specified");
        let contextValue = "";
        if (contextSelect.value === "User-defined") {
          contextValue = contextCustom.value.trim();
        } else {
          contextValue = contextSelect.value || "";
        }
        const contextLabel = contextValue || "Not specified";
        const now = new Date();
        const dateString = now.toLocaleString();
        const dateTag = now.toISOString().slice(0, 10);

        const isTemplate = !latestZonePercents;
        const suggestionText =
          latestFollowupText ||
          (isTemplate
            ? "Template saved before any answers were calculated."
            : "");

        exportHeader.innerHTML = `
          <div class="export-header-title">Bored to Panic assessment</div>
          <div class="export-header-meta">
            Name: ${name} · Role: ${role} · Context: ${contextLabel} · Date: ${dateString}
          </div>
          <div class="export-highlight">
            Both Bored and Panic are zones that feel negative and rarely support learning. We spend time in
            Stretch to grow our Comfort zone, and to learn how to recover when we have to visit Stress. This
            assessment is about understanding where that time is spent and whether the daily “exercise” of work
            is helping or hindering that growth.
          </div>
          <div class="export-suggestion">
            ${suggestionText}
          </div>
        `;
        boardInner.insertBefore(exportHeader, boardInner.firstChild);

        const exportFooter = document.createElement("div");
        exportFooter.className = "export-footer";
        const url = "https://imthebus.co.uk/web-tools/bored-to-panic.html";
        exportFooter.textContent = `Generated from IMTHEBUS Bored to Panic tool (${url}) on ${dateString}`;
        boardInner.appendChild(exportFooter);

        const headerEl = document.querySelector(".b2p-board-header");
        let originalBoardHeaderDisplay = "";
        if (headerEl) {
          originalBoardHeaderDisplay = headerEl.style.display;
          headerEl.style.display = "none";
        }

        const canvas = await html2canvas(boardWrapper, { scale: 2 });
        const img = canvas.toDataURL("image/jpeg", 0.9);

        const pdf = new jsPDF("p", "mm", "a4");
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(img);
        const imgWidth = pageWidth;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        let remainingHeight = imgHeight;
        let position = 0;

        pdf.addImage(img, "JPEG", 0, 0, imgWidth, Math.min(pageHeight, remainingHeight));
        remainingHeight -= pageHeight;
        position = -pageHeight;

        while (remainingHeight > 0) {
          pdf.addPage();
          position += pageHeight;
          pdf.addImage(
            img,
            "JPEG",
            0,
            position,
            imgWidth,
            Math.min(pageHeight, remainingHeight)
          );
          remainingHeight -= pageHeight;
        }

        const safeName =
          name && name !== "Not specified"
            ? name.toLowerCase().replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "")
            : "";
        const filename =
          "Bored_to_Panic" +
          (safeName ? "_" + safeName : "") +
          "_" +
          dateTag +
          ".pdf";

        pdf.save(filename);

        boardInner.removeChild(exportHeader);
        boardInner.removeChild(exportFooter);
        sectionEls.forEach((el, i) => {
          if (openState[i]) el.classList.add("open");
          else el.classList.remove("open");
        });
        boardInner.classList.remove("export-mode");

        if (headerEl) headerEl.style.display = originalBoardHeaderDisplay || "";
      }

      exportPdfButton.addEventListener("click", handleExportPdf);
    });
  </script>
</body>
</html>
