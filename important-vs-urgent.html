<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Important vs Urgent Board - IMTHEBUS Toolbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Marker style font -->
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

  <style>
    :root {
      --ink: #111111;
      --border-strong: #000000;

      --do-bg: #c7f9cc;
      --schedule-bg: #bde0fe;
      --delegate-bg: #ffeaa7;
      --delete-bg: #ffb3c1;

      --do-tag: #15803d;
      --schedule-tag: #1d4ed8;
      --delegate-tag: #b45309;
      --delete-tag: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        url("assets/whiteboard-noise.png") repeat,
        url("assets/whiteboard.jpg") repeat,
        #fdfdfd;
      background-size: 600px, 1200px;
      color: var(--ink);
    }

    /* NAVIGATION */

    nav {
      position: sticky;
      top: 0;
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 10px 20px;
      background:
        url("assets/whiteboard-noise.png") repeat,
        url("assets/whiteboard-texture.jpg") repeat,
        #ffffff;
      background-size: 600px, 1200px;
      border-bottom: 3px solid var(--border-strong);
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 0.95rem;
    }

    .nav-left {
      display: flex;
      gap: 18px;
      align-items: center;
    }

    .nav-left a {
      text-decoration: none;
      color: var(--ink);
      padding: 2px 4px;
    }

    .nav-left a:hover {
      background: #000000;
      color: #ffffff;
    }

    .nav-right {
      font-size: 1rem;
      font-weight: 700;
    }

    /* PAGE LAYOUT */

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 40px;
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
      gap: 20px;
      align-items: flex-start;
      position: relative;
    }

    @media (max-width: 900px) {
      .page {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* SIDEBAR */

    .sidebar {
      position: relative;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-radius: 10px;
      border: 2px solid #000000;
      padding: 12px 12px 14px;
      box-shadow: 0 8px 14px rgba(0, 0, 0, 0.22);
      background:
        url("assets/whiteboard-noise.png") repeat,
        url("assets/whiteboard-texture.jpg") repeat,
        rgba(255, 255, 255, 0.95);
      background-size: 600px, 1200px;
    }

    .sidebar-title {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.02em;
      margin-bottom: 2px;
    }

    .sidebar-subtitle {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 6px;
    }

    .section-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 4px 0;
    }

    .task-input-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 6px;
    }

    .task-input-row input[type="text"] {
      flex: 1 1 180px;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid #000000;
      font-size: 0.85rem;
    }

    .btn-pill {
      border-radius: 999px;
      border: 1px solid #000000;
      background: #ffffff;
      font-size: 0.8rem;
      padding: 5px 10px;
      cursor: pointer;
    }

    .btn-pill:hover {
      background: #000000;
      color: #ffffff;
    }

    .btn-pill.secondary {
      opacity: 0.8;
    }

    .task-list {
      list-style: none;
      margin: 4px 0 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 170px;
      overflow-y: auto;
    }

    .task-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.45);
      background: rgba(255, 255, 255, 0.9);
      font-size: 0.8rem;
    }

    .task-main {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 0;
      flex: 1;
    }

    .task-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-meta {
      font-size: 0.7rem;
      color: #555;
      white-space: nowrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.45);
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .pill-unassessed {
      background: #f3f4f6;
      color: #555;
    }

    .pill-q1 {
      border-color: var(--do-tag);
      color: var(--do-tag);
    }

    .pill-q2 {
      border-color: var(--schedule-tag);
      color: var(--schedule-tag);
    }

    .pill-q3 {
      border-color: var(--delegate-tag);
      color: var(--delegate-tag);
    }

    .pill-q4 {
      border-color: var(--delete-tag);
      color: var(--delete-tag);
    }

    .task-actions {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-shrink: 0;
    }

    .btn-small {
      padding: 3px 6px;
      font-size: 0.7rem;
    }

    .task-empty {
      font-size: 0.75rem;
      color: #666;
      margin-top: 2px;
    }

    .hint-chip {
      margin-top: 4px;
      font-size: 0.72rem;
      color: #555;
    }

    .hint-chip span {
      font-weight: 500;
    }

    /* collapsible guidance */

    .details-shell {
      margin-top: 4px;
      border-top: 1px dashed rgba(0, 0, 0, 0.2);
      padding-top: 4px;
    }

    .details-shell summary {
      font-size: 0.72rem;
      cursor: pointer;
      list-style: none;
    }

    .details-shell summary::-webkit-details-marker {
      display: none;
    }

    .details-shell summary::before {
      content: "+";
      display: inline-block;
      margin-right: 4px;
    }

    .details-shell[open] summary::before {
      content: "-";
    }

    .details-shell p {
      font-size: 0.72rem;
      color: #555;
      margin: 3px 0 2px;
    }

    /* QUESTION PANEL */

    .question-panel {
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.45);
      background: rgba(255, 255, 255, 0.96);
      padding: 8px 8px 6px;
      font-size: 0.78rem;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .question-task-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .question-step {
      font-size: 0.7rem;
      color: #666;
      white-space: nowrap;
    }

    .question-rows {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .question-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 4px;
      align-items: center;
      padding: 3px 0;
      border-top: 1px solid rgba(0, 0, 0, 0.08);
    }

    .question-row:first-of-type {
      border-top: none;
    }

    .question-title {
      font-size: 0.78rem;
      font-weight: 500;
    }

    .question-scale {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .scale-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.68rem;
      text-align: center;
    }

    .scale-option input[type="radio"] {
      margin-bottom: 1px;
      cursor: pointer;
      accent-color: #111111;
    }

    .scale-option span {
      white-space: nowrap;
    }

    .question-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.72rem;
      color: #555;
    }

    .question-footer .btn-pill {
      font-size: 0.72rem;
    }

    @media (max-width: 800px) {
      .question-row {
        grid-template-columns: minmax(0, 1fr);
      }
      .question-scale {
        justify-content: space-around;
      }
    }

    /* BOARD */

    .board-wrapper {
      position: relative;
      align-self: flex-start;
      border-radius: 12px;
      border: 2px solid #000000;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.28);
      overflow: hidden;
      height: 620px;
      background:
        url("assets/whiteboard-noise.png") repeat,
        url("assets/whiteboard-texture.jpg") repeat,
        rgba(255, 255, 255, 0.96);
      background-size: 600px, 1200px;
    }

    @media (max-width: 900px) {
      .board-wrapper {
        height: 520px;
      }
    }

    @media (max-width: 640px) {
      .board-wrapper {
        height: 460px;
      }
    }

    .board-title-display {
      padding: 10px 16px 0;
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.6rem;
      letter-spacing: -0.03em;
    }

    .board-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 16px 4px;
      font-size: 0.78rem;
      color: #555;
    }

    .board-meta-row small {
      white-space: nowrap;
    }

    .board-toolbar {
      display: inline-flex;
      gap: 4px;
      padding: 3px 4px;
      border-radius: 999px;
      border: 1px solid #000000;
      background: rgba(255, 255, 255, 0.95);
    }

    .board-toolbar button {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #000000;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.75rem;
    }

    .board-toolbar button:hover {
      background: #000000;
      color: #ffffff;
    }

    .board {
      position: relative;
      width: 100%;
      height: calc(100% - 48px);
      padding: 6px 16px 10px;
      display: grid;
      grid-template-rows: minmax(260px, 1fr) auto;
      gap: 6px;
    }

    /* grid area */

    .grid-wrapper {
      position: relative;
      border-radius: 10px;
      border: 1px solid #000000;
      background: transparent;
      display: grid;
      grid-template-rows: auto 1fr;
      padding: 4px 10px 8px;
    }

    .grid-header {
      display: grid;
      grid-template-columns: 1fr 1fr;
      font-size: 0.78rem;
      text-align: center;
      margin-bottom: 2px;
    }

    .grid-header span {
      font-family: "Permanent Marker", system-ui, sans-serif;
      letter-spacing: 0.08em;
    }

    .grid-body {
      position: relative;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 4px;
      font-size: 0.8rem;
    }

    .grid-y-label {
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translate(-50%, -50%) rotate(-90deg);
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
    }

    .grid-cell {
      border-radius: 8px;
      padding: 6px 8px 4px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15) inset;
    }

    .grid-cell.do {
      background: var(--do-bg);
    }

    .grid-cell.schedule {
      background: var(--schedule-bg);
    }

    .grid-cell.delegate {
      background: var(--delegate-bg);
    }

    .grid-cell.delete {
      background: var(--delete-bg);
    }

    .grid-cell-header {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1rem;
      margin-bottom: 2px;
    }

    .grid-tasks {
      list-style: none;
      margin: 0;
      padding: 0 2px 0 10px;
      max-height: 110px;
      overflow-y: auto;
    }

    .grid-tasks li {
      font-size: 0.78rem;
      padding: 1px 0;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    /* priority area */

    .priority-panel {
      border-radius: 8px;
      border: 1px solid #000000;
      background: rgba(255, 255, 255, 0.96);
      padding: 6px 8px 6px;
      font-size: 0.78rem;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 4px 10px;
    }

    @media (max-width: 800px) {
      .priority-panel {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .priority-header {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1rem;
      margin-bottom: 2px;
    }

    .priority-summary {
      font-size: 0.75rem;
      color: #555;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .priority-summary span {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      white-space: nowrap;
    }

    .priority-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #000000;
    }

    .priority-dot.do { background: var(--do-tag); }
    .priority-dot.schedule { background: var(--schedule-tag); }
    .priority-dot.delegate { background: var(--delegate-tag); }
    .priority-dot.delete { background: var(--delete-tag); }

    .priority-list {
      list-style: none;
      margin: 2px 0 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 130px;
      overflow-y: auto;
    }

    .priority-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.3);
      background: #f9fafb;
      font-size: 0.78rem;
    }

    .priority-main {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      flex: 1;
    }

    .priority-rank {
      width: 20px;
      text-align: right;
      font-size: 0.75rem;
      color: #555;
    }

    .priority-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .priority-meta {
      font-size: 0.72rem;
      color: #555;
      white-space: nowrap;
    }

    .priority-pill {
      font-size: 0.72rem;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.3);
      background: #ffffff;
      white-space: nowrap;
    }

    .priority-empty {
      font-size: 0.75rem;
      color: #666;
    }
  </style>
</head>
<body>
<nav>
  <div class="nav-left">
    <a href="important-urgent.html">Important vs Urgent</a>
    <a href="swot.html">SWOT</a>
    <a href="index.html#tools">Tools</a>
    <a href="index.html#about">About</a>
  </div>
  <div class="nav-right">IMTHEBUS tools</div>
</nav>

<div class="page">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div>
      <div class="sidebar-title">Important vs Urgent</div>
      <div class="sidebar-subtitle">
        Capture tasks on the left, see them land on the board, then work from the priority list.
      </div>
    </div>

    <div>
      <div class="section-label">Step 1 - Tasks</div>
      <div class="task-input-row">
        <input
          type="text"
          id="taskInput"
          placeholder="Example: Draft Q1 board report"
          autocomplete="off"
        />
        <button class="btn-pill" id="addTaskButton">Add</button>
        <button class="btn-pill secondary" id="clearAllButton">Clear</button>
      </div>
      <div class="hint-chip">
        <span>Tip:</span> Tasks are cleaned and questions start from the middle answer.
      </div>

      <ul class="task-list" id="taskList"></ul>
      <div class="task-empty" id="noTasksMessage">
        No tasks yet. Add one above to get started.
      </div>
    </div>

    <details class="details-shell">
      <summary>What the quadrants mean</summary>
      <p><strong>Do it</strong> - Important and urgent. Real deadlines and real impact if you miss them.</p>
      <p><strong>Schedule it</strong> - Important but not urgent. Moves you forward but can slip if you are not careful.</p>
      <p><strong>Delegate it</strong> - Time sensitive but less important for you. Better handled by someone else.</p>
      <p><strong>Delete it</strong> - Low importance and low urgency. Distractions, nice to have work, or tasks to question.</p>
    </details>

    <div id="questionPanelContainer"></div>
  </aside>

  <!-- BOARD -->
  <section class="board-wrapper">
    <div class="board-title-display">Important vs Urgent Board</div>
    <div class="board-meta-row">
      <small>Grid: Important (vertical) vs Urgent (horizontal)</small>
      <div class="board-toolbar">
        <button id="exportPdfButton" title="Export summary PDF">PDF</button>
      </div>
    </div>

    <div class="board">
      <!-- Grid -->
      <div class="grid-wrapper">
        <div class="grid-header">
          <span>URGENT</span>
          <span>NOT URGENT</span>
        </div>
        <div class="grid-body">
          <div class="grid-y-label">IMPORTANT</div>

          <div class="grid-cell do">
            <div class="grid-cell-header">Do it</div>
            <ul class="grid-tasks" id="grid-q1"></ul>
          </div>

          <div class="grid-cell schedule">
            <div class="grid-cell-header">Schedule it</div>
            <ul class="grid-tasks" id="grid-q2"></ul>
          </div>

          <div class="grid-cell delegate">
            <div class="grid-cell-header">Delegate it</div>
            <ul class="grid-tasks" id="grid-q3"></ul>
          </div>

          <div class="grid-cell delete">
            <div class="grid-cell-header">Delete it</div>
            <ul class="grid-tasks" id="grid-q4"></ul>
          </div>
        </div>
      </div>

      <!-- Priority panel -->
      <div class="priority-panel">
        <div>
          <div class="priority-header">Step 2 - Priority order</div>
          <div class="priority-summary" id="prioritySummary">
            No assessed tasks yet.
          </div>
        </div>

        <ul class="priority-list" id="priorityList">
          <li class="priority-empty">Assess at least one task to see a working list.</li>
        </ul>
      </div>
    </div>
  </section>
</div>

<script>
  // core elements
  const taskInput = document.getElementById("taskInput");
  const addTaskButton = document.getElementById("addTaskButton");
  const clearAllButton = document.getElementById("clearAllButton");
  const taskList = document.getElementById("taskList");
  const noTasksMessage = document.getElementById("noTasksMessage");
  const questionPanelContainer = document.getElementById("questionPanelContainer");
  const exportPdfButton = document.getElementById("exportPdfButton");

  const gridElements = {
    q1: document.getElementById("grid-q1"),
    q2: document.getElementById("grid-q2"),
    q3: document.getElementById("grid-q3"),
    q4: document.getElementById("grid-q4")
  };

  const priorityList = document.getElementById("priorityList");
  const prioritySummary = document.getElementById("prioritySummary");

  let tasks = [];
  let assessmentState = null;

  function cleanTaskName(raw) {
    const s = raw.trim().replace(/\s+/g, " ");
    if (!s) return "";
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  // questions - text trimmed a little
  const questions = [
    // Importance
    {
      id: "impImpact",
      title: "Impact if ignored",
      question: "Impact on outcomes if this never happened.",
      dimension: "importance",
      scaleLabels: ["Very low", "Low", "Medium", "High", "Very high"],
      options: [{ value: 1 }, { value: 2 }, { value: 3 }, { value: 4 }, { value: 5 }]
    },
    {
      id: "impStake",
      title: "Who it affects",
      question: "How many people or groups are meaningfully affected.",
      dimension: "importance",
      scaleLabels: ["Just me", "Small group", "One team", "Many teams", "Whole business / key customers"],
      options: [{ value: 1 }, { value: 2 }, { value: 3 }, { value: 4 }, { value: 5 }]
    },
    {
      id: "impGoal",
      title: "Strategic fit",
      question: "How directly this supports current priorities.",
      dimension: "importance",
      scaleLabels: ["Not at all", "Loosely", "Somewhat", "Strongly", "Directly delivers"],
      options: [{ value: 1 }, { value: 2 }, { value: 3 }, { value: 4 }, { value: 5 }]
    },
    // Urgency
    {
      id: "urgDeadline",
      title: "Real deadline",
      question: "How soon it genuinely needs to be done.",
      dimension: "urgency",
      scaleLabels: ["No date", "> 1 month", "Two weeks", "This week", "Today / tomorrow"],
      options: [{ value: 1 }, { value: 2 }, { value: 3 }, { value: 4 }, { value: 5 }]
    },
    {
      id: "urgBlock",
      title: "Others waiting",
      question: "How blocked other people are by this.",
      dimension: "urgency",
      scaleLabels: ["No one", "Would like it", "Expecting soon", "One team blocked", "Many people blocked"],
      options: [{ value: 1 }, { value: 2 }, { value: 3 }, { value: 4 }, { value: 5 }]
    },
    {
      id: "urgDelay",
      title: "Cost of delay",
      question: "Impact if you push this back by a week.",
      dimension: "urgency",
      scaleLabels: ["None", "Minor", "Noticeable", "Significant", "Serious"],
      options: [{ value: 1 }, { value: 2 }, { value: 3 }, { value: 4 }, { value: 5 }]
    }
  ];

  function defaultAnswers(existing) {
    const answers = {};
    questions.forEach(q => {
      if (existing && existing[q.id] != null) {
        answers[q.id] = existing[q.id];
      } else {
        answers[q.id] = 3; // middle option
      }
    });
    return answers;
  }

  function addTaskFromInput() {
    const cleaned = cleanTaskName(taskInput.value);
    if (!cleaned) return;

    const task = {
      id: Date.now() + Math.random().toString(16).slice(2),
      name: cleaned,
      importance: null,
      urgency: null,
      answers: null
    };
    tasks.push(task);
    taskInput.value = "";
    assessmentState = null;
    renderAll();
    taskInput.focus();
  }

  function clearAllTasks() {
    if (!tasks.length) return;
    if (!confirm("Clear all tasks?")) return;
    tasks = [];
    assessmentState = null;
    renderAll();
  }

  function deleteTask(id) {
    tasks = tasks.filter(t => t.id !== id);
    if (assessmentState && assessmentState.taskId === id) {
      assessmentState = null;
    }
    renderAll();
  }

  function startAssessment(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    assessmentState = {
      taskId,
      answers: defaultAnswers(task.answers)
    };
    renderAll();
  }

  function cancelAssessment() {
    assessmentState = null;
    renderAll();
  }

  function handleRadioChange(questionId, value) {
    if (!assessmentState) return;
    assessmentState.answers[questionId] = Number(value);
  }

  // new scoring: keep averages as decimals and treat 1-5 as low/mid/high ranges
  function finaliseAssessment() {
    if (!assessmentState) return;
    const state = assessmentState;
    const task = tasks.find(t => t.id === state.taskId);
    if (!task) return;

    const a = state.answers;

    const impValues = ["impImpact", "impStake", "impGoal"].map(id => a[id] || 3);
    const urgValues = ["urgDeadline", "urgBlock", "urgDelay"].map(id => a[id] || 3);

    const impAvg = impValues.reduce((s, v) => s + v, 0) / impValues.length;
    const urgAvg = urgValues.reduce((s, v) => s + v, 0) / urgValues.length;

    task.importance = impAvg;
    task.urgency = urgAvg;
    task.answers = { ...a };

    assessmentState = null;
    renderAll();
  }

  function levelFromScore(score) {
    if (score == null) return null;
    if (score >= 3.6) return "high";
    if (score <= 2.4) return "low";
    return "mid";
  }

  function computeQuadrant(task) {
    if (task.importance == null || task.urgency == null) return null;

    const impLevel = levelFromScore(task.importance);
    const urgLevel = levelFromScore(task.urgency);

    // clear high-high goes to Do it
    if (impLevel === "high" && urgLevel === "high") return "q1";

    // high importance, not high urgency -> Schedule
    if (impLevel === "high" && urgLevel !== "high") return "q2";

    // low importance and low urgency -> Delete
    if (impLevel === "low" && urgLevel === "low") return "q4";

    // low importance with any urgency that is not low -> Delegate
    if (impLevel === "low" && urgLevel !== "low") return "q3";

    // mid importance, high urgency -> Delegate (urgent but not clearly important)
    if (impLevel === "mid" && urgLevel === "high") return "q3";

    // mid importance, low urgency -> Delete
    if (impLevel === "mid" && urgLevel === "low") return "q4";

    // both mid or mid importance with mid urgency -> Schedule
    return "q2";
  }

  function quadrantMeta(q) {
    switch (q) {
      case "q1":
        return { label: "Do it", long: "Do it", class: "pill-q1" };
      case "q2":
        return { label: "Schedule it", long: "Schedule it", class: "pill-q2" };
      case "q3":
        return { label: "Delegate it", long: "Delegate it", class: "pill-q3" };
      case "q4":
      default:
        return { label: "Delete it", long: "Delete it", class: "pill-q4" };
    }
  }

  function computePriorityScore(task) {
    // weight importance slightly higher than urgency
    return (task.importance || 0) * 2 + (task.urgency || 0);
  }

  /* RENDER TASKS */

  function renderTasks() {
    taskList.innerHTML = "";

    if (!tasks.length) {
      noTasksMessage.style.display = "block";
      return;
    }

    noTasksMessage.style.display = "none";

    tasks.forEach(task => {
      const li = document.createElement("li");
      li.className = "task-list-item";

      const main = document.createElement("div");
      main.className = "task-main";

      const nameEl = document.createElement("div");
      nameEl.className = "task-name";
      nameEl.textContent = task.name;

      const metaEl = document.createElement("div");
      metaEl.className = "task-meta";

      const assessed = task.importance != null && task.urgency != null;

      if (!assessed) {
        metaEl.textContent = "Not assessed yet";
      } else {
        const q = computeQuadrant(task);
        const qMeta = quadrantMeta(q);
        metaEl.textContent = qMeta.long;
      }

      main.appendChild(nameEl);
      main.appendChild(metaEl);

      const actions = document.createElement("div");
      actions.className = "task-actions";

      const pill = document.createElement("div");
      if (!assessed) {
        pill.className = "pill pill-unassessed";
        pill.textContent = "Needs assessment";
      } else {
        const qMeta = quadrantMeta(computeQuadrant(task));
        pill.className = "pill " + qMeta.class;
        pill.textContent = qMeta.label;
      }

      const assessBtn = document.createElement("button");
      assessBtn.className = "btn-pill btn-small";
      assessBtn.textContent = assessed ? "Revisit" : "Assess";
      assessBtn.addEventListener("click", () => startAssessment(task.id));

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn-pill btn-small secondary";
      deleteBtn.textContent = "Remove";
      deleteBtn.style.borderColor = "rgba(185,28,28,0.7)";
      deleteBtn.style.color = "#991b1b";
      deleteBtn.addEventListener("click", () => deleteTask(task.id));

      actions.appendChild(pill);
      actions.appendChild(assessBtn);
      actions.appendChild(deleteBtn);

      li.appendChild(main);
      li.appendChild(actions);

      taskList.appendChild(li);
    });
  }

  function renderQuestionPanel() {
    questionPanelContainer.innerHTML = "";

    if (!assessmentState) {
      if (tasks.length) {
        const panel = document.createElement("div");
        panel.className = "question-panel";
        const text = document.createElement("div");
        text.className = "question-step";
        text.textContent = "Select a task above then tweak the sliders that stand out.";
        panel.appendChild(text);
        questionPanelContainer.appendChild(panel);
      }
      return;
    }

    const task = tasks.find(t => t.id === assessmentState.taskId);
    const answers = assessmentState.answers;

    const panel = document.createElement("div");
    panel.className = "question-panel";

    const header = document.createElement("div");
    header.className = "question-header";

    const nameEl = document.createElement("div");
    nameEl.className = "question-task-name";
    nameEl.textContent = task ? task.name : "";

    const stepEl = document.createElement("div");
    stepEl.className = "question-step";
    stepEl.textContent = "Six quick sliders - middle is preselected.";

    header.appendChild(nameEl);
    header.appendChild(stepEl);

    const rowsContainer = document.createElement("div");
    rowsContainer.className = "question-rows";

    questions.forEach(q => {
      const row = document.createElement("div");
      row.className = "question-row";

      const titleEl = document.createElement("div");
      titleEl.className = "question-title";
      titleEl.textContent = q.title;

      const scale = document.createElement("div");
      scale.className = "question-scale";

      q.options.forEach((opt, idx) => {
        const wrapper = document.createElement("label");
        wrapper.className = "scale-option";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "q-" + q.id;
        input.value = String(opt.value);
        input.checked = answers[q.id] === opt.value;

        input.addEventListener("change", () => handleRadioChange(q.id, opt.value));

        const labelSpan = document.createElement("span");
        labelSpan.textContent = q.scaleLabels[idx];

        wrapper.appendChild(input);
        wrapper.appendChild(labelSpan);
        scale.appendChild(wrapper);
      });

      row.appendChild(titleEl);
      row.appendChild(scale);
      rowsContainer.appendChild(row);
    });

    const footer = document.createElement("div");
    footer.className = "question-footer";

    const hint = document.createElement("div");
    hint.textContent = "Change only the answers that feel clearly high or low.";

    const actions = document.createElement("div");

    const cancelBtn = document.createElement("button");
    cancelBtn.type = "button";
    cancelBtn.className = "btn-pill btn-small secondary";
    cancelBtn.textContent = "Cancel";
    cancelBtn.addEventListener("click", cancelAssessment);

    const saveBtn = document.createElement("button");
    saveBtn.type = "button";
    saveBtn.className = "btn-pill btn-small";
    saveBtn.textContent = "Save answers";
    saveBtn.addEventListener("click", finaliseAssessment);

    actions.appendChild(cancelBtn);
    actions.appendChild(saveBtn);

    footer.appendChild(hint);
    footer.appendChild(actions);

    panel.appendChild(header);
    panel.appendChild(rowsContainer);
    panel.appendChild(footer);

    questionPanelContainer.appendChild(panel);
  }

  function renderGrid() {
    Object.values(gridElements).forEach(el => { el.innerHTML = ""; });

    const assessed = tasks.filter(t => t.importance != null && t.urgency != null);
    if (!assessed.length) return;

    const grouped = { q1: [], q2: [], q3: [], q4: [] };

    assessed.forEach(task => {
      const q = computeQuadrant(task);
      grouped[q].push(task);
    });

    Object.keys(grouped).forEach(key => {
      const ul = gridElements[key];
      const arr = grouped[key];

      if (!arr.length) return;

      arr
        .slice()
        .sort((a, b) => computePriorityScore(b) - computePriorityScore(a))
        .forEach(task => {
          const li = document.createElement("li");
          li.textContent = task.name;
          ul.appendChild(li);
        });
    });
  }

  function renderPriorities() {
    priorityList.innerHTML = "";

    const assessed = tasks.filter(t => t.importance != null && t.urgency != null);

    if (!assessed.length) {
      prioritySummary.textContent = "No assessed tasks yet.";
      const li = document.createElement("li");
      li.className = "priority-empty";
      li.textContent = "Assess at least one task to see a working list.";
      priorityList.appendChild(li);
      return;
    }

    const qOrder = { q1: 1, q2: 2, q3: 3, q4: 4 };

    const sorted = assessed
      .slice()
      .map(t => {
        const q = computeQuadrant(t);
        return { ...t, quadrant: q, score: computePriorityScore(t) };
      })
      .sort((a, b) => {
        const qa = qOrder[a.quadrant];
        const qb = qOrder[b.quadrant];
        if (qa !== qb) return qa - qb;
        return b.score - a.score;
      });

    // quadrant summary
    const counts = { q1: 0, q2: 0, q3: 0, q4: 0 };
    sorted.forEach(t => { counts[t.quadrant] = (counts[t.quadrant] || 0) + 1; });

    prioritySummary.innerHTML = "";
    const summaryBits = [
      { key: "q1", label: "Do", class: "do" },
      { key: "q2", label: "Schedule", class: "schedule" },
      { key: "q3", label: "Delegate", class: "delegate" },
      { key: "q4", label: "Delete", class: "delete" }
    ];
    summaryBits.forEach(bit => {
      const span = document.createElement("span");
      const dot = document.createElement("span");
      dot.className = "priority-dot " + bit.class;
      span.appendChild(dot);
      const text = document.createTextNode(" " + bit.label + ": " + (counts[bit.key] || 0));
      span.appendChild(text);
      prioritySummary.appendChild(span);
    });

    sorted.forEach((task, index) => {
      const li = document.createElement("li");
      li.className = "priority-item";

      const main = document.createElement("div");
      main.className = "priority-main";

      const rank = document.createElement("div");
      rank.className = "priority-rank";
      rank.textContent = index + 1;

      const nameEl = document.createElement("div");
      nameEl.className = "priority-name";
      nameEl.textContent = task.name;

      const metaEl = document.createElement("div");
      metaEl.className = "priority-meta";
      metaEl.textContent = quadrantMeta(task.quadrant).long;

      main.appendChild(rank);
      main.appendChild(nameEl);
      main.appendChild(metaEl);

      const pill = document.createElement("div");
      pill.className = "priority-pill";
      const imp = task.importance != null ? task.importance.toFixed(1) : "-";
      const urg = task.urgency != null ? task.urgency.toFixed(1) : "-";
      pill.textContent = "Impact " + imp + " · Timing " + urg;

      li.appendChild(main);
      li.appendChild(pill);

      priorityList.appendChild(li);
    });

    const unassessed = tasks.filter(t => t.importance == null || t.urgency == null);
    if (unassessed.length) {
      const li = document.createElement("li");
      li.className = "priority-empty";
      li.textContent = unassessed.length + " task" + (unassessed.length > 1 ? "s" : "") + " not yet assessed.";
      priorityList.appendChild(li);
    }
  }

  function renderAll() {
    renderTasks();
    renderQuestionPanel();
    renderGrid();
    renderPriorities();
  }

  /* PDF EXPORT */

  function formatDateForFilename(date) {
    const pad = n => String(n).padStart(2, "0");
    const yyyy = date.getFullYear();
    const mm = pad(date.getMonth() + 1);
    const dd = pad(date.getDate());
    const hh = pad(date.getHours());
    const mi = pad(date.getMinutes());
    return `${yyyy}-${mm}-${dd}_${hh}-${mi}`;
  }

  function exportAsPdf() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("PDF export is not available in this browser.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

    const margin = 40;
    let y = margin;

    const now = new Date();
    const title = "Important vs Urgent Planner";
    const subtitle = now.toLocaleString();

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text(title, margin, y);
    y += 18;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(subtitle, margin, y);
    y += 18;

    const assessed = tasks.filter(t => t.importance != null && t.urgency != null);
    const unassessed = tasks.filter(t => t.importance == null || t.urgency == null);

    const sections = [
      { key: "q1", heading: "Do it (important and urgent)" },
      { key: "q2", heading: "Schedule it (important, not urgent)" },
      { key: "q3", heading: "Delegate it (less important, urgent)" },
      { key: "q4", heading: "Delete it (less important, not urgent)" }
    ];

    doc.setFontSize(12);
    sections.forEach(sec => {
      const list = assessed.filter(t => computeQuadrant(t) === sec.key);
      doc.setFont("helvetica", "bold");
      doc.text(sec.heading, margin, y);
      y += 14;
      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);

      if (!list.length) {
        doc.text("No tasks in this quadrant.", margin + 14, y);
        y += 14;
      } else {
        list.forEach(t => {
          const line = "• " + t.name;
          const split = doc.splitTextToSize(line, 500);
          doc.text(split, margin + 14, y);
          y += 14 + (split.length - 1) * 12;
        });
      }
      y += 6;
      if (y > 760) {
        doc.addPage();
        y = margin;
      }
      doc.setFontSize(12);
    });

    if (assessed.length) {
      if (y > 720) {
        doc.addPage();
        y = margin;
      }
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Priority order", margin, y);
      y += 14;

      const qOrder = { q1: 1, q2: 2, q3: 3, q4: 4 };
      const sorted = assessed
        .slice()
        .map(t => {
          const q = computeQuadrant(t);
          return { ...t, quadrant: q, score: computePriorityScore(t) };
        })
        .sort((a, b) => {
          const qa = qOrder[a.quadrant];
          const qb = qOrder[b.quadrant];
          if (qa !== qb) return qa - qb;
          return b.score - a.score;
        });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);

      sorted.forEach((t, idx) => {
        const qMeta = quadrantMeta(t.quadrant);
        const base = `${idx + 1}. ${t.name}  (${qMeta.long})`;
        const split = doc.splitTextToSize(base, 500);
        doc.text(split, margin, y);
        y += 14 + (split.length - 1) * 12;
        if (y > 760) {
          doc.addPage();
          y = margin;
        }
      });
      y += 8;
    }

    if (unassessed.length) {
      if (y > 740) {
        doc.addPage();
        y = margin;
      }
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Not yet assessed", margin, y);
      y += 14;
      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      unassessed.forEach(t => {
        const line = "• " + t.name;
        const split = doc.splitTextToSize(line, 500);
        doc.text(split, margin + 14, y);
        y += 14 + (split.length - 1) * 12;
        if (y > 760) {
          doc.addPage();
          y = margin;
        }
      });
    }

    const filename = "important-vs-urgent-" + formatDateForFilename(now) + ".pdf";
    doc.save(filename);
  }

  addTaskButton.addEventListener("click", addTaskFromInput);
  clearAllButton.addEventListener("click", clearAllTasks);
  exportPdfButton.addEventListener("click", exportAsPdf);

  taskInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      addTaskFromInput();
    }
  });

  renderAll();
</script>
</body>
</html>

