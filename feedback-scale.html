<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Feedback scale – IMTHEBUS Toolbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared styles and core helpers -->
  <link rel="stylesheet" href="assets/imthebus-base.css" />
  <script src="assets/imthebus-core.js" defer></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

  <!-- Page-specific styles -->
  <style>
    :root {
      --fs-muted: #4b5563;
    }

    .sidebar-title {
      font-family: "Archivo Black", system-ui, sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .sidebar-subtitle {
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .sidebar-field-label {
      font-size: 0.78rem;
      margin: 4px 0 2px;
    }

    .sidebar-note {
      font-size: 0.78rem;
      color: var(--fs-muted);
      margin-top: 4px;
    }

    .sidebar-counter {
      font-size: 0.78rem;
      color: var(--fs-muted);
      margin-top: 6px;
    }

    .about-tool {
      margin-top: 8px;
    }

    .about-body {
      font-size: 0.78rem;
      color: var(--fs-muted);
      margin-top: 4px;
    }

    .about-body p {
      margin: 2px 0 4px;
    }

    .board-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .board-title {
      font-family: "Archivo Black", system-ui, sans-serif;
      font-size: 1.4rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .board-subtitle {
      font-size: 0.78rem;
      color: var(--fs-muted);
    }

    .board-meta {
      font-size: 0.78rem;
      color: var(--fs-muted);
      margin-top: 4px;
    }

    .board-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .board-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      grid-template-rows: auto auto;
      gap: 10px;
    }

    @media (max-width: 980px) {
      .board-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .board-panel {
      border-radius: 8px;
      border: 1px solid #000000;
      background: rgba(255, 255, 255, 0.96);
      padding: 8px 10px;
      font-size: 0.8rem;
    }

    .board-panel-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .board-panel-subtitle {
      font-size: 0.76rem;
      color: var(--fs-muted);
      margin-bottom: 4px;
    }

    /* Question list */

    .fs-questions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .fs-question-row {
      border-top: 1px solid rgba(0, 0, 0, 0.12);
      padding: 4px 0;
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr);
      gap: 8px;
      align-items: center;
    }

    .fs-question-row:first-of-type {
      border-top: none;
      padding-top: 0;
    }

    @media (max-width: 800px) {
      .fs-question-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .fs-question-text {
      font-size: 0.78rem;
    }

    .fs-question-zone {
      font-weight: 600;
      font-size: 0.78rem;
      margin-bottom: 1px;
    }

    .fs-scale {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      font-size: 0.7rem;
    }

    .fs-scale-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .fs-scale-option input[type="radio"] {
      cursor: pointer;
      margin-bottom: 1px;
    }

    .fs-scale-option span {
      white-space: nowrap;
    }

    .fs-scale-header {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr);
      gap: 8px;
      font-size: 0.72rem;
      color: var(--fs-muted);
      margin-bottom: 2px;
    }

    .fs-scale-header-labels {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .fs-scale-header-labels span {
      flex: 1;
      text-align: center;
    }

    .fs-question-footer {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--fs-muted);
    }

    /* Pattern bars */

    .fs-bars {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .fs-bar-row {
      display: grid;
      grid-template-columns: 80px minmax(0, 1fr) 40px;
      gap: 4px;
      align-items: center;
      font-size: 0.76rem;
    }

    .fs-bar-label {
      font-weight: 500;
    }

    .fs-bar-track {
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .fs-bar-fill {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, #f97316, #0ea5e9);
      transition: width 0.2s ease-out;
    }

    .fs-bar-value {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    /* Summary and history */

    .fs-summary-text {
      font-size: 0.78rem;
      color: var(--fs-muted);
      margin-top: 4px;
    }

    .fs-summary-text p {
      margin: 2px 0;
    }

    .fs-history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.74rem;
      margin-top: 4px;
    }

    .fs-history-table th,
    .fs-history-table td {
      border: 1px solid #000000;
      padding: 2px 4px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .fs-history-table th {
      background: #f3f4f6;
    }

    .fs-history-empty {
      font-size: 0.76rem;
      color: var(--fs-muted);
      margin-top: 4px;
    }

    /* Fullscreen helper (page-local) */

    .board-wrapper--fullscreen {
      position: fixed;
      inset: 52px 12px 12px;
      z-index: 50;
      max-width: none;
      width: auto;
    }

    body.fs-fullscreen {
      overflow: hidden;
    }
  </style>
</head>

<body data-counter-key="feedback_scale">
  <!-- Shared header -->
  <header data-include="partials/header.html"></header>

  <main class="page">
    <!-- Sidebar -->
    <aside class="sidebar-card">
      <div class="sidebar-title">Feedback scale</div>
      <div class="sidebar-subtitle">
        Map how feedback has felt recently across five zones: Silent, Sparse, Resonant, Loud and Overwhelming.
      </div>

      <label class="sidebar-field-label" for="fsName">Name (optional)</label>
      <input id="fsName" class="input-text" type="text" placeholder="e.g. Alex Smith" autocomplete="off" />

      <label class="sidebar-field-label" for="fsRole">Role level</label>
      <select id="fsRole" class="input-select">
        <option value="">Select role level</option>
        <option value="individual">Individual contributor</option>
        <option value="team-lead">Team lead / supervisor</option>
        <option value="manager">Manager</option>
        <option value="senior">Senior leader</option>
      </select>

      <label class="sidebar-field-label" for="fsContext">Context</label>
      <select id="fsContext" class="input-select">
        <option value="">Select context</option>
        <option value="1-1s">1-1s and check-ins</option>
        <option value="team">Team meetings</option>
        <option value="project">Project / initiative</option>
        <option value="whole-role">Whole role</option>
      </select>

      <div id="fsAssessmentCount" class="sidebar-counter">
        Assessments completed in this browser: 0
      </div>

      <!-- About this tool -->
      <div class="about-tool">
        <button
          class="btn btn-pill-small"
          data-collapsible-toggle
          data-collapsible-target="#aboutFsBody"
          data-label-base="About this tool"
        >
          + About this tool
        </button>
        <div id="aboutFsBody" data-collapsible-body class="about-body">
          <p>
            This tool turns gut feelings about feedback into a simple picture you can look at with your manager.
          </p>
          <p>
            It doesn’t label feedback as “good” or “bad”. Instead it shows how much time is spent in each zone:
            <strong>Silent</strong>, <strong>Sparse</strong>, <strong>Resonant</strong>,
            <strong>Loud</strong> and <strong>Overwhelming</strong>.
          </p>
          <p>
            Use it during check-ins to talk about what is working, what feels missing and where you might want to
            adjust how feedback happens.
          </p>
        </div>
      </div>
    </aside>

    <!-- Board -->
    <section class="board-wrapper">
      <div class="board-inner-shell">
        <div class="board-header-row">
          <div>
            <div class="board-title">Feedback scale assessment board</div>
            <div class="board-subtitle">
              Silent and Overwhelming are zones we rarely enjoy. The aim is to spend more time in Resonant feedback,
              with occasional Loud moments when focus or urgency is needed.
            </div>
          </div>
          <div class="board-actions">
            <button class="btn btn-pill-small" id="fsFullscreenButton">Fullscreen board</button>
            <button class="btn btn-pill-small" id="fsPdfButton">Save as PDF</button>
          </div>
        </div>

        <div class="board-meta">
          Answer the questions, click <strong>Calculate from answers</strong>, then review the pattern and decide
          what you want to change.
        </div>

        <div class="board-grid">
          <!-- Questions -->
          <section class="board-panel" id="fsQuestionsPanel">
            <div class="board-panel-title">Questions</div>
            <div class="board-panel-subtitle">
              Think about the last few days or weeks. For each row, pick the answer that best fits.
            </div>

            <div class="fs-scale-header">
              <div>Statement</div>
              <div class="fs-scale-header-labels">
                <span>1</span>
                <span>2</span>
                <span>3</span>
                <span>4</span>
                <span>5</span>
              </div>
            </div>

            <div id="fsQuestions" class="fs-questions"></div>

            <div class="fs-question-footer">
              1 = very rarely, 3 = sometimes, 5 = very often. You don’t need to overthink each answer.
            </div>

            <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
              <button class="btn btn-pill-small" id="fsCalculateButton">Calculate from answers</button>
              <button class="btn btn-pill-small" id="fsClearAnswersButton">Clear answers</button>
            </div>
          </section>

          <!-- Pattern -->
          <section class="board-panel">
            <div class="board-panel-title">Zone pattern</div>
            <div class="board-panel-subtitle">
              Shows how your recent feedback “time” is distributed across the five zones.
            </div>
            <div id="fsBars" class="fs-bars"></div>
          </section>

          <!-- Summary -->
          <section class="board-panel">
            <div class="board-panel-title">Overall feedback pattern</div>
            <div class="board-panel-subtitle">
              A short description of what this pattern might feel like day to day.
            </div>
            <div id="fsSummary" class="fs-summary-text">
              <p>No results yet. Complete the questions and calculate to see a summary.</p>
            </div>
          </section>

          <!-- History -->
          <section class="board-panel">
            <div class="board-panel-title">Recorded entries (this browser)</div>
            <div class="board-panel-subtitle">
              Each time you calculate, a row is added here so you can track how feedback changes over time.
            </div>
            <div id="fsHistoryContainer">
              <div class="fs-history-empty">No entries yet.</div>
            </div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <!-- Shared footer -->
  <footer data-include="partials/footer.html"></footer>

  <!-- Page logic -->
  <script>
    (function () {
      "use strict";

      const questions = [
        {
          id: "silent",
          zone: "Silent",
          text: "I go for long stretches without getting any feedback at all."
        },
        {
          id: "sparse",
          zone: "Sparse",
          text: "I get the occasional comment, but not enough to feel well-informed."
        },
        {
          id: "resonant",
          zone: "Resonant",
          text: "I regularly get specific feedback that helps me learn or adjust."
        },
        {
          id: "loud",
          zone: "Loud",
          text: "Feedback often arrives in a rushed or intense way (for example under pressure)."
        },
        {
          id: "overwhelming",
          zone: "Overwhelming",
          text: "Overall, feedback feels noisy, conflicting or hard to process."
        }
      ];

      const ZONES = ["Silent", "Sparse", "Resonant", "Loud", "Overwhelming"];
      const STORAGE_KEY = "imthebus_feedback_scale_entries_v1";

      const qsContainer = document.getElementById("fsQuestions");
      const barsContainer = document.getElementById("fsBars");
      const summaryEl = document.getElementById("fsSummary");
      const historyContainer = document.getElementById("fsHistoryContainer");
      const countEl = document.getElementById("fsAssessmentCount");

      const calcButton = document.getElementById("fsCalculateButton");
      const clearAnswersButton = document.getElementById("fsClearAnswersButton");
      const fullscreenButton = document.getElementById("fsFullscreenButton");
      const pdfButton = document.getElementById("fsPdfButton");
      const boardWrapper = document.querySelector(".board-wrapper");

      let entries = [];

      function renderQuestions() {
        qsContainer.innerHTML = "";
        questions.forEach(function (q) {
          const row = document.createElement("div");
          row.className = "fs-question-row";

          const left = document.createElement("div");
          const zone = document.createElement("div");
          zone.className = "fs-question-zone";
          zone.textContent = q.zone;

          const text = document.createElement("div");
          text.className = "fs-question-text";
          text.textContent = q.text;

          left.appendChild(zone);
          left.appendChild(text);

          const scale = document.createElement("div");
          scale.className = "fs-scale";

          const labels = [
            "Very rarely",
            "Occasionally",
            "Sometimes",
            "Often",
            "Very often"
          ];

          for (let i = 1; i <= 5; i++) {
            const opt = document.createElement("label");
            opt.className = "fs-scale-option";

            const input = document.createElement("input");
            input.type = "radio";
            input.name = "q-" + q.id;
            input.value = String(i);

            const span = document.createElement("span");
            span.textContent = i + " – " + labels[i - 1];

            opt.appendChild(input);
            opt.appendChild(span);
            scale.appendChild(opt);
          }

          row.appendChild(left);
          row.appendChild(scale);
          qsContainer.appendChild(row);
        });
      }

      function renderBars(percentages) {
        barsContainer.innerHTML = "";
        if (!percentages) {
          ZONES.forEach(function (z) {
            const row = document.createElement("div");
            row.className = "fs-bar-row";

            const label = document.createElement("div");
            label.className = "fs-bar-label";
            label.textContent = z;

            const track = document.createElement("div");
            track.className = "fs-bar-track";

            const fill = document.createElement("div");
            fill.className = "fs-bar-fill";
            track.appendChild(fill);

            const value = document.createElement("div");
            value.className = "fs-bar-value";
            value.textContent = "0%";

            row.appendChild(label);
            row.appendChild(track);
            row.appendChild(value);
            barsContainer.appendChild(row);
          });
          return;
        }

        ZONES.forEach(function (z) {
          const pct = percentages[z] || 0;
          const row = document.createElement("div");
          row.className = "fs-bar-row";

          const label = document.createElement("div");
          label.className = "fs-bar-label";
          label.textContent = z;

          const track = document.createElement("div");
          track.className = "fs-bar-track";

          const fill = document.createElement("div");
          fill.className = "fs-bar-fill";
          fill.style.width = pct + "%";
          track.appendChild(fill);

          const value = document.createElement("div");
          value.className = "fs-bar-value";
          value.textContent = pct.toString().padStart(2, " ") + "%";

          row.appendChild(label);
          row.appendChild(track);
          row.appendChild(value);
          barsContainer.appendChild(row);
        });
      }

      function summarise(percentages) {
        if (!percentages) {
          summaryEl.innerHTML = "<p>No results yet. Complete the questions and calculate to see a summary.</p>";
          return;
        }
        const entriesArr = Object.entries(percentages);
        const sorted = entriesArr
          .slice()
          .sort(function (a, b) { return b[1] - a[1]; });

        const top = sorted[0];
        const topZone = top ? top[0] : null;

        let mainLine = "";
        if (topZone === "Resonant") {
          mainLine =
            "Most of your recent time is in Resonant feedback. You are getting useful information that helps you learn or adjust.";
        } else if (topZone === "Silent" || topZone === "Sparse") {
          mainLine =
            "A lot of your recent time is in " + topZone + " feedback. You may not be getting enough clear, timely information.";
        } else if (topZone === "Loud" || topZone === "Overwhelming") {
          mainLine =
            "Loud and Overwhelming feedback are dominant. Feedback may feel noisy, stressful or hard to process.";
        } else {
          mainLine =
            "Your pattern is more mixed. Use this as a starting point for a conversation about what is helping and what isn’t.";
        }

        const detailLine =
          "Silent " + percentages.Silent + "% · " +
          "Sparse " + percentages.Sparse + "% · " +
          "Resonant " + percentages.Resonant + "% · " +
          "Loud " + percentages.Loud + "% · " +
          "Overwhelming " + percentages.Overwhelming + "%";

        summaryEl.innerHTML =
          "<p>" + mainLine + "</p>" +
          "<p>" + detailLine + "</p>" +
          "<p>Agree with the picture? Decide one or two changes you want to try before your next check-in.</p>";
      }

      function loadEntries() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch {
          return [];
        }
      }

      function saveEntries() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        } catch {
          // ignore storage errors
        }
      }

      function renderHistory() {
        historyContainer.innerHTML = "";
        if (!entries.length) {
          const empty = document.createElement("div");
          empty.className = "fs-history-empty";
          empty.textContent = "No entries yet.";
          historyContainer.appendChild(empty);
          if (countEl) countEl.textContent = "Assessments completed in this browser: 0";
          return;
        }

        if (countEl) {
          countEl.textContent = "Assessments completed in this browser: " + entries.length;
        }

        const table = document.createElement("table");
        table.className = "fs-history-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        ["Date/time", "Silent %", "Sparse %", "Resonant %", "Loud %", "Overw. %"].forEach(function (h) {
          const th = document.createElement("th");
          th.textContent = h;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        entries.forEach(function (entry) {
          const tr = document.createElement("tr");
          const cells = [
            entry.timestamp,
            entry.percentages.Silent,
            entry.percentages.Sparse,
            entry.percentages.Resonant,
            entry.percentages.Loud,
            entry.percentages.Overwhelming
          ];
          cells.forEach(function (val) {
            const td = document.createElement("td");
            td.textContent = typeof val === "number" ? val + "%" : val;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        historyContainer.appendChild(table);
      }

      function getAnswers() {
        const scores = {};
        let missing = false;

        questions.forEach(function (q) {
          const checked = document.querySelector('input[name="q-' + q.id + '"]:checked');
          if (!checked) {
            missing = true;
            return;
          }
          const val = Number(checked.value) || 0;
          scores[q.zone] = val;
        });

        if (missing) return null;
        return scores;
      }

      function scoresToPercentages(scores) {
        if (!scores) return null;
        let total = 0;
        ZONES.forEach(function (z) { total += scores[z] || 0; });
        if (!total) return null;

        const raw = {};
        ZONES.forEach(function (z) {
          raw[z] = (scores[z] || 0) / total * 100;
        });

        // Neaten to whole numbers and ensure sum = 100
        const rounded = {};
        let sum = 0;
        ZONES.forEach(function (z) {
          const v = Math.round(raw[z]);
          rounded[z] = v;
          sum += v;
        });
        const diff = 100 - sum;
        if (diff !== 0) {
          const target = "Resonant";
          rounded[target] = Math.max(0, rounded[target] + diff);
        }
        return rounded;
      }

      function clearAnswers() {
        questions.forEach(function (q) {
          const inputs = document.querySelectorAll('input[name="q-' + q.id + '"]');
          inputs.forEach(function (inp) { inp.checked = false; });
        });
      }

      function handleCalculate() {
        const scores = getAnswers();
        if (!scores) {
          alert("Please answer each question before calculating.");
          return;
        }
        const percentages = scoresToPercentages(scores);
        if (!percentages) return;

        renderBars(percentages);
        summarise(percentages);

        const now = new Date();
        const timestamp = now.toLocaleString();

        const entry = {
          timestamp: timestamp,
          percentages: percentages
        };

        entries.unshift(entry);
        if (entries.length > 30) entries = entries.slice(0, 30);
        saveEntries();
        renderHistory();
      }

      function handleFullscreenToggle() {
        const isFull = boardWrapper.classList.toggle("board-wrapper--fullscreen");
        document.body.classList.toggle("fs-fullscreen", isFull);
        fullscreenButton.textContent = isFull ? "Exit fullscreen" : "Fullscreen board";
      }

      function formatDateForFilename(date) {
        function pad(n) { return String(n).padStart(2, "0"); }
        const yyyy = date.getFullYear();
        const mm = pad(date.getMonth() + 1);
        const dd = pad(date.getDate());
        const hh = pad(date.getHours());
        const mi = pad(date.getMinutes());
        return yyyy + "-" + mm + "-" + dd + "_" + hh + "-" + mi;
      }

      function handlePdfExport() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert("PDF export is not available in this browser.");
          return;
        }
        const latest = entries[0];
        const jsPDF = window.jspdf.jsPDF;
        const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

        const margin = 40;
        let y = margin;
        const now = new Date();

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("Feedback scale assessment", margin, y);
        y += 18;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(now.toLocaleString(), margin, y);
        y += 18;

        if (latest) {
          doc.setFont("helvetica", "bold");
          doc.setFontSize(12);
          doc.text("Latest pattern", margin, y);
          y += 14;
          doc.setFont("helvetica", "normal");
          doc.setFontSize(10);

          const p = latest.percentages;
          const lines = [
            "Silent: " + p.Silent + "%, Sparse: " + p.Sparse + "%, Resonant: " + p.Resonant + "%,",
            "Loud: " + p.Loud + "%, Overwhelming: " + p.Overwhelming + "%"
          ];
          lines.forEach(function (ln) {
            doc.text(ln, margin + 14, y);
            y += 14;
          });
          y += 10;
        } else {
          doc.text("No calculated results yet.", margin + 14, y);
          y += 18;
        }

        if (entries.length) {
          if (y > 720) {
            doc.addPage();
            y = margin;
          }

          doc.setFont("helvetica", "bold");
          doc.setFontSize(12);
          doc.text("Recorded entries", margin, y);
          y += 14;

          doc.setFont("helvetica", "normal");
          doc.setFontSize(9);

          entries.forEach(function (entry) {
            const line =
              entry.timestamp +
              " – S " + entry.percentages.Silent + "%, Sp " + entry.percentages.Sparse +
              "%, R " + entry.percentages.Resonant + "%, L " + entry.percentages.Loud +
              "%, O " + entry.percentages.Overwhelming + "%";
            const split = doc.splitTextToSize(line, 500);
            doc.text(split, margin + 14, y);
            y += 12 + (split.length - 1) * 10;
            if (y > 760) {
              doc.addPage();
              y = margin;
            }
          });
        }

        const filename = "feedback-scale-" + formatDateForFilename(now) + ".pdf";
        doc.save(filename);
      }

      // Initialise
      renderQuestions();
      renderBars(null);

      entries = loadEntries();
      renderHistory();

      calcButton.addEventListener("click", handleCalculate);
      clearAnswersButton.addEventListener("click", function () {
        clearAnswers();
        renderBars(null);
        summarise(null);
      });
      fullscreenButton.addEventListener("click", handleFullscreenToggle);
      pdfButton.addEventListener("click", handlePdfExport);
    })();
  </script>
</body>
</html>
