<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Feedback scale – IMTHEBUS Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Inter:wght@400;500;600&display=swap">

  <!-- PDF / export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --bg-board: #fdfdfd;
      --ink: #111111;
      --border-strong: #000000;

      --silent-color: #111827;
      --sparse-color: #1d4ed8;
      --resonant-color: #15803d;
      --loud-color: #b45309;
      --overwhelming-color: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f3f3f3;
      background-image: url("assets/whiteboard.jpg");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: var(--ink);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Layout shell */

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    nav {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(253, 253, 253, 0.96);
      border-bottom: 2px solid var(--border-strong);
      padding: 0.4rem 1.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-left {
      display: flex;
      gap: 1.25rem;
      font-size: 0.95rem;
    }

    .nav-left a {
      position: relative;
      padding-bottom: 0.1rem;
    }

    .nav-left a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -0.05rem;
      width: 0;
      height: 2px;
      background: #000;
      transition: width 0.15s ease-out;
    }

    .nav-left a:hover::after {
      width: 100%;
    }

    .nav-right {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.04em;
    }

    main {
      flex: 1;
      padding: 1.5rem 1.25rem 2rem;
    }

    .page-inner {
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-grid {
      display: grid;
      grid-template-columns: minmax(260px, 340px) minmax(0, 1fr);
      gap: 1.25rem;
      align-items: flex-start;
    }

    @media (max-width: 860px) {
      .page-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Sidebar clipboard */

    .sidebar {
      background: #ffffff;
      border: 3px solid #000;
      border-radius: 18px;
      box-shadow: 0 10px 0 rgba(0, 0, 0, 0.12);
      padding: 1.1rem 1.1rem 1.2rem;
      position: relative;
    }

    .sidebar::before {
      content: "";
      position: absolute;
      top: 0.45rem;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 9px;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
    }

    .sidebar-title {
      margin-top: 1.6rem;
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.6rem;
    }

    .sidebar-subtitle {
      margin-top: 0.25rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .sidebar-field {
      margin-top: 0.75rem;
      font-size: 0.85rem;
    }

    .sidebar-field label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .sidebar-field input,
    .sidebar-field select {
      width: 100%;
      font: inherit;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
    }

    .sidebar-note {
      margin-top: 0.5rem;
      font-size: 0.78rem;
      color: #555;
    }

    .sidebar-about {
      margin-top: 0.9rem;
      border-radius: 14px;
      border: 2px dashed #000;
      background: #fffef7;
      padding: 0.55rem 0.7rem;
      font-size: 0.82rem;
      line-height: 1.5;
    }

    .sidebar-about strong {
      font-weight: 600;
    }

    .sidebar-section {
      margin-top: 0.9rem;
      border-top: 1px solid #ddd;
      padding-top: 0.5rem;
    }

    .sidebar-section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .sidebar-section-header span.label {
      font-weight: 600;
    }

    .sidebar-section-header span.hint {
      font-size: 0.78rem;
      color: #777;
    }

    .sidebar-section-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
      font-size: 0.82rem;
      color: #444;
    }

    .sidebar-section.open .sidebar-section-body {
      max-height: 260px;
    }

    .sidebar-section-body p {
      margin: 0.45rem 0;
    }

    .sidebar-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }

    .sidebar-buttons button,
    .sidebar-buttons select {
      font: inherit;
      font-size: 0.78rem;
    }

    .sidebar-buttons button {
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
    }

    .sidebar-buttons button.primary {
      background: #000;
      color: #fff;
    }

    .sidebar-buttons button.danger {
      background: #e11d48;
      color: #fff;
    }

    .sidebar-buttons button:hover {
      transform: translateY(-1px);
    }

    .sidebar-buttons select {
      border-radius: 999px;
      border: 2px solid #000;
      padding: 0.28rem 0.55rem;
      max-width: 100%;
    }

    /* Board */

    .board-wrapper {
      background: var(--bg-board);
      border-radius: 22px;
      border: 3px solid var(--border-strong);
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.14);
      padding: 1rem 1.15rem 1.35rem;
      position: relative;
      overflow: hidden;
      transition: box-shadow 0.2s ease-out;
    }

    .board-wrapper:fullscreen {
      overflow-y: auto;
    }

    .board-wrapper.calculated {
      box-shadow: 0 0 0 3px #111 inset, 0 14px 0 rgba(0, 0, 0, 0.14);
    }

    .board-inner {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .board-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .board-title-display {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.7rem;
    }

    .board-toolbar {
      display: flex;
      gap: 0.4rem;
    }

    .board-toolbar button {
      font: inherit;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.25rem 0.7rem;
      cursor: pointer;
    }

    .board-highlight {
      border-radius: 14px;
      border: 2px dashed #000;
      background: #fffef7;
      padding: 0.6rem 0.75rem;
      font-size: 0.84rem;
      line-height: 1.5;
    }

    .board-highlight strong {
      font-weight: 600;
    }

    .board-body {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(260px, 1fr);
      gap: 1rem;
      align-items: flex-start;
    }

    @media (max-width: 980px) {
      .board-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .board-inner.export-mode .board-body {
      display: flex;
      flex-direction: column;
    }

    .board-column {
      min-width: 0;
    }

    /* Question sections */

    .question-section {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .question-section-header {
      width: 100%;
      border: none;
      background: #fff;
      padding: 0.55rem 0.7rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      text-align: left;
    }

    .question-section-title {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.05rem;
    }

    .question-section-subtitle {
      font-size: 0.8rem;
      color: #555;
      margin-left: 0.35rem;
    }

    .question-section-toggle {
      font-size: 1.1rem;
      font-weight: 600;
      transform-origin: center;
      transition: transform 0.18s ease-out;
    }

    .question-section-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
      border-top: 2px solid #000;
    }

    .question-section.open .question-section-body {
      max-height: 600px;
    }

    .question-section.open .question-section-toggle {
      transform: rotate(90deg);
    }

    .question-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .question-table th,
    .question-table td {
      padding: 0.45rem 0.5rem;
      vertical-align: middle;
    }

    .question-table th {
      border-bottom: 1px solid #ddd;
      font-size: 0.78rem;
      text-align: center;
    }

    .question-table th:first-child,
    .question-table td:first-child {
      width: 2.2rem;
      text-align: center;
    }

    .question-table th:nth-child(2),
    .question-table td:nth-child(2) {
      text-align: left;
    }

    .question-number {
      font-size: 0.8rem;
      color: #444;
    }

    .question-number.missing {
      background: #fee2e2;
      border-radius: 999px;
      padding: 0.1rem 0.3rem;
    }

    .question-text {
      max-width: 420px;
    }

    .scale-label-row th span.label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .scale-label-row th span.caption {
      display: block;
      font-size: 0.7rem;
      color: #666;
    }

    .response-cell {
      text-align: center;
    }

    .response-radio {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid #000;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .response-radio input {
      display: none;
    }

    .response-radio span {
      user-select: none;
    }

    .response-radio.selected {
      background: #000;
      color: #fff;
    }

    .calculate-row {
      margin-top: 0.65rem;
      display: flex;
      justify-content: flex-start;
    }

    .calculate-row button {
      font: inherit;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #000;
      color: #fff;
      padding: 0.45rem 1.1rem;
      cursor: pointer;
      transition: background 0.15s ease-out, transform 0.08s ease-out;
    }

    .calculate-row button.calculating {
      background: #1f2937;
      transform: translateY(1px);
    }

    /* Right column: ring and results */

    .donut-panel {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.6rem 0.8rem 0.7rem;
      margin-bottom: 0.6rem;
    }

    .donut-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.3rem;
      gap: 0.5rem;
    }

    .donut-header-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .donut-header-right {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .donut-header-note {
      font-size: 0.75rem;
      color: #555;
    }

    .donut-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #000;
      overflow: hidden;
    }

    .donut-toggle button {
      font: inherit;
      font-size: 0.7rem;
      padding: 0.15rem 0.55rem;
      border: none;
      background: #fff;
      cursor: pointer;
    }

    .donut-toggle button.active {
      background: #000;
      color: #fff;
    }

    #zoneRing {
      width: 100%;
      height: 220px;
      display: block;
    }

    .zone-legend-row {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      margin-top: 0.15rem;
    }

    .zone-legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .zone-legend-label {
      flex: 1;
    }

    .zone-legend-value {
      min-width: 2.4rem;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .results-panel,
    .overall-panel,
    .entries-panel {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.7rem 0.8rem;
      font-size: 0.85rem;
      margin-bottom: 0.6rem;
    }

    .results-panel h3,
    .overall-panel h3,
    .entries-panel h3 {
      margin: 0 0 0.4rem;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .results-panel p,
    .overall-panel p {
      margin: 0.25rem 0;
    }

    .results-panel table,
    .overall-panel table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.35rem;
      font-size: 0.8rem;
    }

    .results-panel th,
    .results-panel td,
    .overall-panel th,
    .overall-panel td {
      border: 1px solid #000;
      padding: 0.25rem 0.3rem;
      vertical-align: top;
    }

    .conversation-prompts {
      margin-top: 0.4rem;
      font-size: 0.8rem;
    }

    .conversation-prompts ul {
      margin: 0.25rem 0 0.25rem 1rem;
      padding: 0;
    }

    .section-summary {
      margin-top: 0.4rem;
      font-size: 0.8rem;
    }

    .section-summary table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.25rem;
      font-size: 0.78rem;
    }

    .section-summary th,
    .section-summary td {
      border: 1px solid #000;
      padding: 0.2rem 0.3rem;
      text-align: left;
    }

    .entries-panel table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .entries-panel th,
    .entries-panel td {
      border: 1px solid #000;
      padding: 0.25rem 0.3rem;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    /* Export header/footer */

    .export-header {
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.4rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .export-header-title {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .export-header-meta {
      font-size: 0.8rem;
    }

    .export-highlight {
      margin-top: 0.45rem;
      font-size: 0.8rem;
    }

    .export-suggestion {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .export-footer {
      border-top: 1px solid #ccc;
      margin-top: 0.8rem;
      padding-top: 0.3rem;
      font-size: 0.75rem;
      text-align: right;
      color: #444;
    }

    /* Footer */

    footer.site-footer {
      border-top: 2px solid #000;
      background: rgba(253, 253, 253, 0.96);
      padding: 0.8rem 1.75rem 1rem;
      font-size: 0.8rem;
    }

    .footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
      align-items: flex-end;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 1.4rem;
    }

    .footer-group-title {
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 600;
      font-size: 0.72rem;
      margin-bottom: 0.2rem;
    }

    .footer-group a {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.1rem;
    }

    .footer-group a:hover {
      text-decoration: underline;
    }

    .footer-meta-line {
      margin-top: 0.15rem;
    }

    .footer-counter {
      margin-top: 0.25rem;
      font-size: 0.78rem;
      color: #444;
    }
  </style>
</head>

<body>
<div class="page">
  <nav>
    <div class="nav-left">
      <a href="index.html">Home</a>
      <a href="index.html#tools">Tools</a>
      <a href="about.html">About</a>
    </div>
    <div class="nav-right">IMTHEBUS tools</div>
  </nav>

  <main>
    <div class="page-inner">
      <div class="page-grid">

        <!-- Sidebar clipboard -->
        <aside class="sidebar">
          <h1 class="sidebar-title">Feedback scale</h1>
          <p class="sidebar-subtitle">
            This tool helps you and your manager understand how feedback feels at the moment.
            It maps your answers to five zones: Silent, Sparse, Resonant, Loud and Overwhelming,
            giving a shared language for the feedback environment from no feedback, through useful,
            resonant feedback, into noisy or overwhelming feedback.
          </p>

          <div class="sidebar-field">
            <label for="personName">Name</label>
            <input id="personName" type="text" placeholder="e.g. Alex Smith" />
          </div>

          <div class="sidebar-field">
            <label for="roleLevel">Role level</label>
            <select id="roleLevel">
              <option value="">Select role level</option>
              <option value="L1">Operator</option>
              <option value="L2">Senior Operator</option>
              <option value="L3">Supervisor</option>
              <option value="L4">Manager</option>
              <option value="L5">Director</option>
            </select>
          </div>

          <div class="sidebar-field">
            <label for="context">Context</label>
            <select id="context">
              <option value="">Select context</option>
              <option value="Normal week">Normal week</option>
              <option value="Peak period">Peak period</option>
              <option value="Project workload">Project workload</option>
              <option value="Returning from leave">Returning from leave</option>
              <option value="Team changes">Team changes</option>
              <option value="User-defined">Other (specify below)</option>
            </select>
          </div>

          <div class="sidebar-field" style="margin-top:0.45rem;">
            <input id="contextCustom" type="text" placeholder="Specify your context" style="display:none;">
          </div>

          <p class="sidebar-note">
            Use this once per check-in to capture how feedback has felt over the last few days or weeks.
          </p>

          <div class="sidebar-about">
            <strong>About this tool.</strong><br>
            • <strong>Silent</strong> – almost no feedback. You rarely hear how things are going unless there is a serious problem.<br>
            • <strong>Sparse</strong> – the odd comment or annual review, but little day to day signal about what is working or not.<br>
            • <strong>Resonant</strong> – regular, specific conversations that connect your work to what matters and feel respectful, even when they are challenging.<br>
            • <strong>Loud</strong> – feedback shows up often and with energy, but can feel rushed, reactive or focused mainly on problems.<br>
            • <strong>Overwhelming</strong> – feedback feels constant, conflicting or personal. It is hard to pick out what to act on and confidence can erode.<br><br>
            The aim is not “more feedback at all costs”, but the right kind of feedback in the right places. More time in the Resonant zone makes feedback easier to give and receive. Your comfort grows, you see patterns in what works and you build confidence from seeing yourself learn and improve. Occasional Loud or difficult conversations are still needed, but they feel less intense because they sit inside a wider habit of useful feedback.<br><br>
            This tool exists to make that pattern visible. It turns gut feelings like “we never hear anything” or “everything is a crisis” into a shared picture that you and your manager can work on together.
          </div>

          <!-- Data and privacy -->
          <div class="sidebar-section" id="privacySection">
            <div class="sidebar-section-header">
              <span class="label">Data and privacy</span>
              <span class="hint">tap or click to expand</span>
            </div>
            <div class="sidebar-section-body">
              <p>
                Your responses are stored only in this browser using local storage.
                Nothing is uploaded, shared or sent anywhere.
              </p>
              <p>
                Clearing browser storage, switching device or pressing “Clear all saved entries”
                deletes the data permanently.
              </p>
            </div>
          </div>

          <!-- Saved / export -->
          <div class="sidebar-section sidebar-export" id="exportSection">
            <div class="sidebar-section-header">
              <span class="label">Saved results and export</span>
              <span class="hint">tap or click to expand</span>
            </div>
            <div class="sidebar-section-body">
              <div class="sidebar-field" style="margin-top:0.4rem;">
                <label for="loadEntry">Load a previous result</label>
                <select id="loadEntry">
                  <option value="">Select saved entry</option>
                </select>
              </div>

              <div class="sidebar-buttons">
                <button id="saveEntry" type="button" class="primary">Save current view</button>
                <button id="exportCsv" type="button">Export CSV</button>
                <button id="exportPdf" type="button">Save as PDF</button>
                <button id="clearEntries" type="button" class="danger">Clear all</button>
              </div>

              <p class="sidebar-note" style="margin-top:0.35rem;">
                Entries stay in this browser only. Use CSV or PDF to keep a record elsewhere
                or share with your manager.
              </p>
            </div>
          </div>
        </aside>

        <!-- Board -->
        <section class="board-wrapper" id="boardWrapper">
          <div class="board-inner" id="boardInner">
            <div class="board-header">
              <div class="board-title-display">Feedback scale assessment board</div>
              <div class="board-toolbar">
                <button type="button" id="fullscreenToggle">Fullscreen board</button>
              </div>
            </div>

            <div class="board-highlight" id="onScreenHighlight">
              <strong>Why Silent and Overwhelming matter.</strong>
              Both Silent and Overwhelming are feedback zones we generally do not enjoy. They are not
              places where we feel safely challenged or supported to learn. We aim to spend more time in
              <strong>Resonant</strong> feedback, where conversations are useful and respectful, and we
              accept some <strong>Loud</strong> moments when focus or urgency is needed. This assessment
              is about understanding where you currently spend your feedback “time” and whether the daily
              “exercise” of feedback is helping or hindering that growth.
            </div>

            <div class="board-body" id="boardBody">
              <!-- Left: questions -->
              <div class="board-column">
                <div id="questionSections"></div>
                <div class="calculate-row">
                  <button id="calculateFromQuestions" type="button">Calculate from answers</button>
                </div>
              </div>

              <!-- Right: ring and results -->
              <div class="board-column">
                <div class="donut-panel">
                  <div class="donut-header">
                    <div class="donut-header-title">Zone pattern</div>
                    <div class="donut-header-right">
                      <span class="donut-header-note" id="donutLabel">
                        Equal starting pattern. Updates after calculation.
                      </span>
                      <div class="donut-toggle">
                        <button type="button" id="showCurrent" class="active">Current</button>
                        <button type="button" id="showIdeal">Ideal</button>
                      </div>
                    </div>
                  </div>
                  <canvas id="zoneRing" width="260" height="220"></canvas>
                  <div id="zoneRingLegend"></div>
                </div>

                <div class="results-panel">
                  <h3>Calculated zones and role comparison</h3>
                  <div id="calculationResults">
                    Answer the questions and click <strong>Calculate from answers</strong> to see your
                    distribution across Silent, Sparse, Resonant, Loud and Overwhelming, and how this
                    compares with a typical pattern for your role level.
                  </div>
                </div>

                <div class="overall-panel">
                  <h3>Overall feedback pattern</h3>
                  <div id="overallResult">
                    After calculation, this section summarises the dominant zone, key areas to pay
                    attention to and a suggested time to redo the assessment based on how close you are
                    to the expected pattern for your role.
                  </div>
                </div>

                <div class="entries-panel">
                  <h3>Recorded entries (this browser)</h3>
                  <p style="margin:0 0 0.3rem;">
                    Use this to track how your feedback pattern changes over time.
                  </p>
                  <table id="entriesTable">
                    <thead>
                    <tr>
                      <th>Date</th>
                      <th>Silent&nbsp;%</th>
                      <th>Sparse&nbsp;%</th>
                      <th>Resonant&nbsp;%</th>
                      <th>Loud&nbsp;%</th>
                      <th>Overw.&nbsp;%</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div>© <span id="year"></span> IMTHEBUS. All rights reserved.</div>
        <div class="footer-meta-line">
          Tool design, questions, scoring model and interpretation framework created by Dean Rougvie.
          All calculations are experimental and may contain errors.
        </div>
        <div class="footer-counter">
          Assessments completed in this browser: <span id="assessmentCount">0</span>
        </div>
      </div>
      <div class="footer-links">
        <div class="footer-group">
          <div class="footer-group-title">Contact</div>
          <a href="mailto:contact@imthebus.co.uk?subject=General%20enquiry">contact@imthebus.co.uk</a>
          <a href="mailto:contact@imthebus.co.uk?subject=Bug%20report">Report a bug</a>
          <a href="mailto:contact@imthebus.co.uk?subject=Tool%20idea">Suggest a tool</a>
        </div>
        <div class="footer-group">
          <div class="footer-group-title">Legal</div>
          <a href="stuff.html#privacy">Privacy notice</a>
          <a href="stuff.html#terms">Terms of use</a>
        </div>
      </div>
    </div>
  </footer>
</div>

<script>
  // Footer year
  document.getElementById("year").textContent = new Date().getFullYear();

  // Sidebar collapsible sections
  document.querySelectorAll(".sidebar-section").forEach(section => {
    const header = section.querySelector(".sidebar-section-header");
    if (!header) return;
    header.addEventListener("click", () => {
      const isOpen = section.classList.contains("open");
      if (isOpen) {
        section.classList.remove("open");
      } else {
        section.classList.add("open");
      }
    });
  });

  const contextSelect = document.getElementById("context");
  const contextCustom = document.getElementById("contextCustom");
  contextSelect.addEventListener("change", () => {
    contextCustom.style.display = contextSelect.value === "User-defined" ? "block" : "none";
  });

  /* ---------- Questions definition ---------- */

  const questions = [
    { id: 1,  text: "I receive specific feedback on my work, not just general comments." },
    { id: 2,  text: "I can go long periods without anyone commenting on how I am doing." },
    { id: 3,  text: "Feedback I receive is mostly about small day to day tasks rather than bigger development." },
    { id: 4,  text: "Feedback I receive helps me understand the impact of my work on others or on the business." },
    { id: 5,  text: "I receive so much feedback that it is hard to know what to act on first." },
    { id: 6,  text: "When something goes well, someone usually notices and says so." },
    { id: 7,  text: "Feedback usually arrives only when something has gone wrong." },
    { id: 8,  text: "I feel comfortable asking for feedback when I need it." },
    { id: 9,  text: "Different people give me conflicting feedback about what good looks like." },
    { id: 10, text: "I know what my manager would say I am doing well right now." },
    { id: 11, text: "I know what my manager would say I should improve next." },
    { id: 12, text: "Feedback conversations feel rushed, squeezed in or reactive." },
    { id: 13, text: "I leave feedback conversations with a clear next step or action." },
    { id: 14, text: "I feel anxious or worried in the lead up to feedback conversations." },
    { id: 15, text: "The tone of feedback is respectful, even when it is challenging." },
    { id: 16, text: "I receive feedback in group settings that would feel better one to one." },
    { id: 17, text: "I get regular check-ins about how I am doing, even when nothing is on fire." },
    { id: 18, text: "During feedback conversations I feel listened to, not just spoken at." },
    { id: 19, text: "The amount of feedback I receive matches the level of responsibility I have." },
    { id: 20, text: "Feedback focuses only on results, not on how the work gets done." },
    { id: 21, text: "I hear a consistent message about what good performance looks like." },
    { id: 22, text: "Feedback connects my work to the bigger picture or strategy." },
    { id: 23, text: "I feel on edge because I am expecting more criticism or negative feedback." },
    { id: 24, text: "I understand how feedback will be used in performance or pay decisions." },
    { id: 25, text: "I sometimes avoid asking for feedback because of how it is usually handled." }
  ];

  const questionMap = new Map(questions.map(q => [q.id, q]));

  const sections = [
    {
      id: "volume",
      title: "Volume and timing",
      subtitle: "How much feedback shows up and when.",
      questionIds: [2,3,5,12,17,19,24]
    },
    {
      id: "tone",
      title: "Tone and safety",
      subtitle: "How feedback feels to receive.",
      questionIds: [7,14,15,16,18,23,25]
    },
    {
      id: "clarity",
      title: "Clarity and alignment",
      subtitle: "How clearly feedback explains what good looks like.",
      questionIds: [1,4,9,10,11,20,21,22]
    },
    {
      id: "ownership",
      title: "Ownership and access",
      subtitle: "How easy it is to ask for and use feedback.",
      questionIds: [6,8,13]
    }
  ];

  const reverseScored = new Set([]); // all questions currently scored in the same direction

  const responseOptions = [
    { value: 0, label: "1" },
    { value: 1, label: "2" },
    { value: 2, label: "3" },
    { value: 3, label: "4" },
    { value: 4, label: "5" }
  ];

  // Zone mappings – note: each zone uses the mean score of its questions
  const zoneQuestions = {
    silent:       [2,7],
    sparse:       [3,7,24],
    resonant:     [1,4,6,8,10,11,13,15,17,18,19,21,22],
    loud:         [12,14,16,20],
    overwhelming: [5,9,14,16,23,25]
  };

  const zoneLabels = {
    silent: "Silent",
    sparse: "Sparse",
    resonant: "Resonant",
    loud: "Loud",
    overwhelming: "Overwhelming"
  };

  const zoneColors = {
    silent:       { fill: "rgba(17,24,39,0.85)",  stroke: "#111827" },
    sparse:       { fill: "rgba(37,99,235,0.85)",  stroke: "#1d4ed8" },
    resonant:     { fill: "rgba(22,163,74,0.85)",  stroke: "#15803d" },
    loud:         { fill: "rgba(217,119,6,0.85)",  stroke: "#b45309" },
    overwhelming: { fill: "rgba(220,38,38,0.85)",  stroke: "#b91c1c" }
  };

  const roleTargets = {
    L1: { silent: 20, sparse: 35, resonant: 35, loud: 10, overwhelming: 0 },
    L2: { silent: 15, sparse: 30, resonant: 40, loud: 15, overwhelming: 0 },
    L3: { silent: 10, sparse: 25, resonant: 45, loud: 20, overwhelming: 0 },
    L4: { silent: 8,  sparse: 20, resonant: 50, loud: 22, overwhelming: 0 },
    L5: { silent: 5,  sparse: 15, resonant: 55, loud: 25, overwhelming: 0 }
  };

  const roleLabels = {
    L1: "Operator",
    L2: "Senior Operator",
    L3: "Supervisor",
    L4: "Manager",
    L5: "Director"
  };

  const descriptions = {
    1: {
      label: "Silent",
      text: "Very little feedback. You are often guessing how you are doing. Wins may go unnoticed and development needs are not clearly named.",
      manager: "Create regular, low-drama check ins. Start with simple questions about what is going well, what is hard and what to focus on next."
    },
    2: {
      label: "Sparse",
      text: "Some feedback appears, usually around tasks or problems, but it is irregular and not joined up. The signal is there, but it is faint.",
      manager: "Agree a basic rhythm for feedback. Add short, structured conversations that cover strengths, development and expectations."
    },
    3: {
      label: "Resonant",
      text: "Healthy feedback pattern. Conversations are regular, specific and respectful. You understand what is working, what needs attention and why it matters.",
      manager: "Protect this pattern. Keep feedback anchored to concrete examples and shared goals. Remove friction that gets in the way of good conversations."
    },
    4: {
      label: "Loud",
      text: "Feedback is frequent or intense. It may feel rushed, reactive or focused mainly on problems. It can be difficult to tease out the most important points.",
      manager: "Slow things down. Prioritise one or two key messages. Agree what can wait and use quieter follow-ups rather than everything in one burst."
    },
    5: {
      label: "Overwhelming",
      text: "Feedback feels constant, conflicting or emotionally heavy. It may feel unsafe or exhausting to be on the receiving end of it.",
      manager: "Step back and reset. Clarify which feedback matters, remove unnecessary criticism and agree boundaries about how and where feedback will be given."
    }
  };

  const roleLevelSelect = document.getElementById("roleLevel");
  const saveButton = document.getElementById("saveEntry");
  const exportButton = document.getElementById("exportCsv");
  const exportPdfButton = document.getElementById("exportPdf");
  const clearButton = document.getElementById("clearEntries");
  const loadSelect = document.getElementById("loadEntry");
  const calculationResults = document.getElementById("calculationResults");
  const overallResult = document.getElementById("overallResult");
  const entriesTableBody = document.querySelector("#entriesTable tbody");
  const calculateButton = document.getElementById("calculateFromQuestions");
  const donutLabel = document.getElementById("donutLabel");
  const boardWrapper = document.getElementById("boardWrapper");
  const boardInner = document.getElementById("boardInner");
  const assessmentCountSpan = document.getElementById("assessmentCount");
  const showCurrentBtn = document.getElementById("showCurrent");
  const showIdealBtn = document.getElementById("showIdeal");

  let latestZonePercents = null;
  let latestZoneRaw = null;
  let latestTopZone = null;
  let latestTopScore = null;
  let latestResponses = null;
  let latestScaleScore = null;
  let latestFollowupText = "";
  let ringMode = "current";

  /* ---------- Assessment counter ---------- */

  function loadAssessmentCount() {
    const raw = localStorage.getItem("feedbackScaleCount");
    const n = raw ? parseInt(raw, 10) || 0 : 0;
    assessmentCountSpan.textContent = n;
    return n;
  }

  function incrementAssessmentCount() {
    const n = loadAssessmentCount() + 1;
    localStorage.setItem("feedbackScaleCount", String(n));
    assessmentCountSpan.textContent = n;
  }

  loadAssessmentCount();

  /* ---------- Build questions UI with sections ---------- */

  const questionSectionsContainer = document.getElementById("questionSections");

  function buildQuestions() {
    let displayIndex = 1;

    sections.forEach(section => {
      const wrapper = document.createElement("div");
      wrapper.className = "question-section";
      wrapper.dataset.sectionId = section.id;

      const headerBtn = document.createElement("button");
      headerBtn.type = "button";
      headerBtn.className = "question-section-header";
      headerBtn.innerHTML = `
        <div>
          <span class="question-section-title">${section.title}</span>
          <span class="question-section-subtitle">${section.subtitle}</span>
        </div>
        <div class="question-section-toggle">+</div>
      `;
      wrapper.appendChild(headerBtn);

      const body = document.createElement("div");
      body.className = "question-section-body";

      const table = document.createElement("table");
      table.className = "question-table";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr class="scale-label-row">
          <th>#</th>
          <th>Question</th>
          <th colspan="5">
            <span class="label">Never → Always</span>
            <span class="caption">1 = never, 3 = sometimes, 5 = always</span>
          </th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      section.questionIds.forEach(qid => {
        const q = questionMap.get(qid);
        if (!q) return;
        const tr = document.createElement("tr");

        const tdNum = document.createElement("td");
        tdNum.className = "question-number";
        tdNum.dataset.qid = q.id;
        tdNum.textContent = displayIndex++;
        tr.appendChild(tdNum);

        const tdText = document.createElement("td");
        tdText.className = "question-text";
        tdText.textContent = q.text;
        tr.appendChild(tdText);

        responseOptions.forEach(opt => {
          const td = document.createElement("td");
          td.className = "response-cell";

          const label = document.createElement("label");
          label.className = "response-radio";
          const input = document.createElement("input");
          input.type = "radio";
          input.name = `q${q.id}`;
          input.value = opt.value;

          const span = document.createElement("span");
          span.textContent = opt.label;

          label.appendChild(input);
          label.appendChild(span);
          td.appendChild(label);
          tr.appendChild(td);

          label.addEventListener("click", () => {
            document
              .querySelectorAll(`label.response-radio input[name="q${q.id}"]`)
              .forEach(r => r.parentElement.classList.remove("selected"));
            label.classList.add("selected");
          });
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      body.appendChild(table);
      wrapper.appendChild(body);
      questionSectionsContainer.appendChild(wrapper);

      headerBtn.addEventListener("click", () => {
        const isOpen = wrapper.classList.contains("open");
        if (isOpen) {
          wrapper.classList.remove("open");
        } else {
          document.querySelectorAll(".question-section").forEach(sec => sec.classList.remove("open"));
          wrapper.classList.add("open");
        }
      });
    });

    // Open the first section by default
    const firstSection = document.querySelector(".question-section");
    if (firstSection) firstSection.classList.add("open");
  }

  buildQuestions();

  /* ---------- Ring chart (concentric bands, not pie) ---------- */

  const ringCanvas = document.getElementById("zoneRing");
  const ringCtx = ringCanvas.getContext("2d");

  function drawRingChart(data) {
    const w = ringCanvas.width;
    const h = ringCanvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const maxRadius = Math.min(w, h) / 2 - 8;

    ringCtx.clearRect(0, 0, w, h);

    const order = ["silent", "sparse", "resonant", "loud", "overwhelming"];
    const values = data || { silent: 20, sparse: 20, resonant: 20, loud: 20, overwhelming: 20 };

    let innerR = 0;
    order.forEach(zone => {
      const pct = values[zone] ?? 0;
      const outerR = innerR + maxRadius * (pct / 100);
      if (outerR <= innerR) return;

      ringCtx.beginPath();
      ringCtx.arc(cx, cy, outerR, 0, 2 * Math.PI);
      ringCtx.arc(cx, cy, innerR, 2 * Math.PI, 0, true);
      ringCtx.closePath();
      ringCtx.fillStyle = zoneColors[zone].fill;
      ringCtx.fill();

      innerR = outerR;
    });

    ringCtx.beginPath();
    ringCtx.arc(cx, cy, maxRadius, 0, 2 * Math.PI);
    ringCtx.strokeStyle = "#000";
    ringCtx.lineWidth = 2;
    ringCtx.stroke();
  }

  function updateRingLegend(data, labelText) {
    const legend = document.getElementById("zoneRingLegend");
    const order = ["silent", "sparse", "resonant", "loud", "overwhelming"];
    const values = data || { silent: 20, sparse: 20, resonant: 20, loud: 20, overwhelming: 20 };
    const rows = order.map(zone => {
      const pct = values[zone] ?? 0;
      return `
        <div class="zone-legend-row">
          <span class="zone-legend-swatch" style="background:${zoneColors[zone].stroke};"></span>
          <span class="zone-legend-label">${zoneLabels[zone]}</span>
          <span class="zone-legend-value">${pct}%</span>
        </div>
      `;
    }).join("");
    legend.innerHTML = rows;
    donutLabel.textContent = labelText;
  }

  function currentTarget(role) {
    return role ? roleTargets[role] : null;
  }

  function refreshRing() {
    const role = roleLevelSelect.value || null;
    const target = currentTarget(role);

    if (!latestZonePercents) {
      drawRingChart(null);
      updateRingLegend(null, "Equal starting pattern. Updates after calculation.");
      return;
    }

    if (ringMode === "ideal" && role && target) {
      drawRingChart(target);
      updateRingLegend(target, `Ideal pattern for ${roleLabels[role] || role}`);
    } else {
      ringMode = "current";
      showCurrentBtn.classList.add("active");
      showIdealBtn.classList.remove("active");
      drawRingChart(latestZonePercents);
      updateRingLegend(latestZonePercents, "Current pattern");
    }
  }

  drawRingChart(null);
  updateRingLegend(null, "Equal starting pattern. Updates after calculation.");

  showCurrentBtn.addEventListener("click", () => {
    ringMode = "current";
    showCurrentBtn.classList.add("active");
    showIdealBtn.classList.remove("active");
    refreshRing();
  });

  showIdealBtn.addEventListener("click", () => {
    if (!roleLevelSelect.value) {
      alert("Select a role level first to view the ideal pattern.");
      roleLevelSelect.scrollIntoView({ behavior: "smooth", block: "center" });
      roleLevelSelect.focus();
      return;
    }
    ringMode = "ideal";
    showIdealBtn.classList.add("active");
    showCurrentBtn.classList.remove("active");
    refreshRing();
  });

  /* ---------- Scoring logic (means, not raw sums) ---------- */

  function getResponsesWithValidation() {
    const responses = {};
    // Walk through sections in order so the first missing is predictable
    for (const section of sections) {
      for (const qid of section.questionIds) {
        const q = questionMap.get(qid);
        if (!q) continue;
        const checked = document.querySelector(`input[name="q${q.id}"]:checked`);
        if (!checked) {
          return { responses: null, missingId: q.id };
        }
        responses[q.id] = parseInt(checked.value, 10);
      }
    }
    return { responses, missingId: null };
  }

  function calculateZoneScores(responses) {
    const raw = {};
    const avg = {};
    let totalIntensity = 0;
    const zones = Object.keys(zoneQuestions);

    zones.forEach(zone => {
      const ids = zoneQuestions[zone];
      let sum = 0;
      ids.forEach(id => {
        const base = responses[id] ?? 0;
        const score = reverseScored.has(id) ? (4 - base) : base;
        sum += score;
      });
      const mean = ids.length ? sum / ids.length : 0;
      raw[zone] = sum;
      avg[zone] = mean;
      totalIntensity += mean;
    });

    const percents = {};
    if (totalIntensity === 0) {
      zones.forEach(z => { percents[z] = 0; });
    } else {
      let running = 0;
      zones.forEach((zone, idx) => {
        if (idx === zones.length - 1) {
          percents[zone] = Math.max(0, 100 - running);
        } else {
          const p = Math.round((avg[zone] / totalIntensity) * 100);
          percents[zone] = p;
          running += p;
        }
      });
    }

    return { raw, percents };
  }

  function levelLabel(actual, ideal) {
    const diff = actual - ideal;
    if (Math.abs(diff) <= 5) return "about right";
    if (diff > 5) return "high";
    return "low";
  }

  function zoneNarrative(zone, actual, ideal) {
    const level = levelLabel(actual, ideal);
    switch (zone) {
      case "silent":
        if (level === "high") return "Silence is high; build in regular, low-pressure feedback moments so people are not guessing.";
        if (level === "low") return "Silence is low; most people have at least some sense of how they are doing.";
        return "Silence is about right; there is enough information flowing to avoid guesswork.";
      case "sparse":
        if (level === "high") return "Sparse feedback is high; move from occasional comments to a clearer feedback rhythm.";
        if (level === "low") return "Sparse feedback is low; more feedback is either resonant or clearly signposted.";
        return "Sparse feedback is about right; there is some day to day feedback without it dominating.";
      case "resonant":
        if (level === "high") return "Resonant feedback is high; check that volume is still manageable and focused.";
        if (level === "low") return "Resonant feedback is low; introduce clearer, specific conversations about strengths and development.";
        return "Resonant feedback is about right; protect the quality of these conversations.";
      case "loud":
        if (level === "high") return "Loud feedback is high; reduce reactive, problem-only messages and prioritise key themes.";
        if (level === "low") return "Loud feedback is low; consider whether there is enough urgency when priorities really matter.";
        return "Loud feedback is near ideal; spikes are fine but avoid constant firefighting.";
      case "overwhelming":
        if (level === "high") return "Overwhelming feedback is high; reset expectations and boundaries so feedback feels safer and more focused.";
        return "Overwhelming feedback is low; keep escalation paths clear for more serious issues.";
      default:
        return "";
    }
  }

  function buildPatternCommentary(percents) {
    const flags = [];
    const praise = [];

    if (percents.overwhelming >= 15) {
      flags.push("Overwhelming feedback at or above 15%: explore what feels unsafe or excessive and agree clear changes to how feedback is given.");
    } else if (percents.overwhelming >= 10) {
      flags.push("Overwhelming feedback between 10% and 15%: agree regular check-ins to spot patterns that push things too far.");
    }

    if (percents.loud + percents.overwhelming >= 35) {
      flags.push("Combined Loud and Overwhelming above 35%: feedback may feel intense or chaotic. Simplify the message and slow the pace.");
    }

    if (percents.silent >= 25) {
      flags.push("Silent at or above 25%: feedback is mostly absent. Agree a basic rhythm of short check-ins and clearer expectations.");
    }

    if (percents.resonant < 30) {
      flags.push("Resonant below 30%: there may be few high-quality, useful conversations. Look for one or two places to improve quality first.");
    }

    if (percents.silent >= 20 && percents.overwhelming >= 10) {
      flags.push("High Silent and high Overwhelming: feedback may swing between no information and very heavy criticism. Look for structural causes such as unclear expectations or inconsistent management styles.");
    }

    if (percents.loud >= 20 && percents.resonant < 30) {
      flags.push("Loud is high and Resonant is low: feedback may be mostly reactive or problem focused. Shift some of this energy into calmer, more specific conversations.");
    }

    if (percents.resonant >= 40 && percents.overwhelming < 10 && percents.silent < 20) {
      praise.push("Resonant feedback carries most of the load with low Silent and Overwhelming. This is a broadly healthy pattern. Focus on keeping messages aligned and respectful.");
    }

    if (percents.silent < 15 && percents.overwhelming < 5) {
      praise.push("Both Silent and Overwhelming are low. Day to day, feedback mostly happens in zones that support learning and performance.");
    }

    if (!flags.length && !praise.length) {
      praise.push("No strong risk signals from this pattern. It is still useful to ask what makes it work and what you would like more of.");
    }

    return { flags, praise };
  }

  function buildConversationPromptsHtml(percents) {
    const { flags, praise } = buildPatternCommentary(percents);
    let html = '<div class="conversation-prompts">';
    if (praise.length) {
      html += "<strong>What seems to be working:</strong><ul>";
      praise.forEach(p => { html += `<li>${p}</li>`; });
      html += "</ul>";
    }
    if (flags.length) {
      html += "<strong>Things to watch or adjust:</strong><ul>";
      flags.forEach(f => { html += `<li>${f}</li>`; });
      html += "</ul>";
    }
    html += "</div>";
    return html;
  }

  function buildComparisonTable(percents, target) {
    const zones = ["silent", "sparse", "resonant", "loud", "overwhelming"];
    let rows = "";
    zones.forEach(z => {
      const actual = percents[z];
      const ideal = target[z];
      const comment = zoneNarrative(z, actual, ideal);
      rows += `
        <tr>
          <td>${zoneLabels[z]}</td>
          <td>${actual}%</td>
          <td>${ideal}%</td>
          <td>${comment}</td>
        </tr>
      `;
    });
    return `
      <table>
        <thead>
          <tr>
            <th>Zone</th>
            <th>Current</th>
            <th>Ideal</th>
            <th>Quick interpretation and action</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    `;
  }

  function buildIdealSummary(role, target) {
    if (!target) {
      return "<span style='color:#555;'>Select a role level to see the ideal feedback distribution for that role.</span>";
    }
    const label = roleLabels[role] || role;
    return `
      Ideal for <strong>${label}</strong>:
      Silent ${target.silent}%,
      Sparse ${target.sparse}%,
      Resonant ${target.resonant}%,
      Loud ${target.loud}%,
      Overwhelming ${target.overwhelming}%.
    `;
  }

  function getFollowupSuggestion(percents, role) {
    const target = currentTarget(role);
    const now = new Date();

    if (!target) {
      const weeks = 12;
      const future = new Date(now.getTime() + weeks * 7 * 24 * 60 * 60 * 1000);
      return {
        text: `Suggested time to redo this assessment: around 3 months, around ${future.toLocaleDateString()}.`,
        dateLabel: future.toLocaleDateString()
      };
    }

    const zones = ["silent","sparse","resonant","loud","overwhelming"];
    let sumDiff = 0;
    zones.forEach(z => {
      sumDiff += Math.abs((percents[z] ?? 0) - target[z]);
    });
    const avgDiff = sumDiff / zones.length;

    let weeks;
    if (avgDiff >= 18) weeks = 6;
    else if (avgDiff >= 14) weeks = 8;
    else if (avgDiff >= 10) weeks = 12;
    else if (avgDiff >= 6) weeks = 24;
    else weeks = 52;

    const future = new Date(now.getTime() + weeks * 7 * 24 * 60 * 60 * 1000);
    const label =
      weeks === 52 ? "about a year" :
      weeks === 24 ? "about 6 months" :
      weeks === 12 ? "about 3 months" :
      `${weeks} weeks`;

    return {
      text: `Suggested time to redo this assessment: ${label}, around ${future.toLocaleDateString()}.`,
      dateLabel: future.toLocaleDateString()
    };
  }

  function buildSectionSummaryTable(responses) {
    if (!responses) return "";

    const rows = sections.map(section => {
      const ids = section.questionIds;
      let sum = 0;
      ids.forEach(id => {
        const val = responses[id];
        if (typeof val === "number") sum += val;
      });
      const meanRaw = ids.length ? sum / ids.length : 0;   // 0–4
      const meanScore = (meanRaw + 1).toFixed(1);         // 1–5
      let comment;
      if (meanScore >= 4.0) {
        comment = "Strong area – keep the current habits.";
      } else if (meanScore >= 3.0) {
        comment = "Mixed but workable – pick one or two improvements.";
      } else {
        comment = "Weak area – agree specific changes to improve this part of feedback.";
      }
      return `
        <tr>
          <td>${section.title}</td>
          <td>${meanScore} / 5</td>
          <td>${comment}</td>
        </tr>
      `;
    }).join("");

    return `
      <div class="section-summary">
        <strong>Section overview (average score per question):</strong>
        <table>
          <thead>
            <tr>
              <th>Section</th>
              <th>Average score</th>
              <th>Quick read</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function renderOverallScale(topZone, percents, role) {
    const zoneToScore = {
      silent: 1,
      sparse: 2,
      resonant: 3,
      loud: 4,
      overwhelming: 5
    };

    const score = zoneToScore[topZone] || 3;
    latestScaleScore = score;
    const desc = descriptions[score];
    const target = currentTarget(role);

    const deviations = [];
    if (target) {
      ["silent","sparse","resonant","loud","overwhelming"].forEach(z => {
        const actual = percents[z] ?? 0;
        const ideal = target[z];
        const diff = actual - ideal;
        const absDiff = Math.abs(diff);

        if (z === "overwhelming" && actual < 5 && ideal === 0) return;
        if (z === "silent" && actual < 15 && diff <= 0) return;
        if (absDiff >= 8) {
          const direction = diff > 0 ? "higher" : "lower";
          deviations.push({
            zone: z,
            absDiff,
            text: `<li><strong>${zoneLabels[z]}</strong> is ${absDiff} points ${direction} than expected: ${zoneNarrative(z, actual, ideal)}</li>`
          });
        }
      });
      deviations.sort((a, b) => b.absDiff - a.absDiff);
    }

    let deviationsHtml;
    if (!target) {
      deviationsHtml = "<span style='color:#555;'>Select a role level to see which zones differ most from the expected feedback profile.</span>";
    } else if (!deviations.length) {
      deviationsHtml = "<span style='color:#555;'>No major deviations from the ideal feedback profile for this role. Focus on keeping messages clear, respectful and aligned.</span>";
    } else {
      deviationsHtml = "<ul>" + deviations.slice(0, 3).map(d => d.text).join("") + "</ul>";
    }

    const follow = getFollowupSuggestion(percents, role);
    latestFollowupText = follow.text;

    overallResult.innerHTML = `
      <p><strong>Dominant zone:</strong> ${zoneLabels[topZone]} (score ${score} – ${desc.label})</p>
      <p><strong>Description:</strong> ${desc.text}</p>
      <p><strong>Manager focus:</strong> ${desc.manager}</p>
      <p><strong>Key differences from target pattern:</strong> ${deviationsHtml}</p>
      <p style="margin-top:0.35rem;"><strong>${follow.text}</strong></p>
    `;
  }

  function renderResults(percents, role, topZone, topScore) {
    const target = currentTarget(role);
    const idealSummary = buildIdealSummary(role, target);
    const sectionSummaryHtml = buildSectionSummaryTable(latestResponses);

    calculationResults.innerHTML = `
      <p><strong>Current pattern:</strong> Silent ${percents.silent}% · Sparse ${percents.sparse}% · Resonant ${percents.resonant}% · Loud ${percents.loud}% · Overwhelming ${percents.overwhelming}%</p>
      <p><strong>Role profile:</strong> ${idealSummary}</p>
      ${
        target
          ? buildComparisonTable(percents, target)
          : "<p style='font-size:0.8rem;color:#555;margin-top:0.3rem;'>Select a role level to compare current and ideal scores by zone.</p>"
      }
      ${buildConversationPromptsHtml(percents)}
      ${sectionSummaryHtml}
    `;

    renderOverallScale(topZone, percents, role);
    refreshRing();
  }

  /* ---------- Local storage for entries ---------- */

  function loadEntries() {
    try {
      return JSON.parse(localStorage.getItem("feedbackScaleEntries") || "[]");
    } catch {
      return [];
    }
  }

  function saveEntries(entries) {
    localStorage.setItem("feedbackScaleEntries", JSON.stringify(entries));
  }

  function renderEntriesTableAndDropdown() {
    const entries = loadEntries();
    entriesTableBody.innerHTML = "";
    loadSelect.innerHTML = '<option value="">Select saved entry</option>';

    entries.forEach((entry, index) => {
      const tr = document.createElement("tr");
      const zp = entry.zonePercents || {};
      tr.innerHTML = `
        <td>${entry.timestamp}</td>
        <td>${zp.silent ?? ""}%</td>
        <td>${zp.sparse ?? ""}%</td>
        <td>${zp.resonant ?? ""}%</td>
        <td>${zp.loud ?? ""}%</td>
        <td>${zp.overwhelming ?? ""}%</td>
      `;
      entriesTableBody.appendChild(tr);

      const opt = document.createElement("option");
      opt.value = index.toString();
      opt.textContent = `${entry.timestamp}`;
      loadSelect.appendChild(opt);
    });
  }

  renderEntriesTableAndDropdown();

  function storeEntry(autoSave) {
    if (!latestZonePercents || !latestTopZone) return;

    const name = document.getElementById("personName").value.trim();
    const roleLevel = roleLevelSelect.value || "";
    let contextValue = "";
    if (contextSelect.value === "User-defined") {
      contextValue = contextCustom.value.trim();
    } else {
      contextValue = contextSelect.value || "";
    }

    const entries = loadEntries();
    const timestamp = new Date().toLocaleString();

    entries.push({
      timestamp,
      name,
      roleLevel,
      context: contextValue,
      score: latestScaleScore || 3,
      zonePercents: latestZonePercents,
      zoneRaw: latestZoneRaw,
      responses: latestResponses
    });

    saveEntries(entries);
    renderEntriesTableAndDropdown();
  }

  /* ---------- CSV export ---------- */

  function toCsvRow(cells) {
    return cells.map(cell => {
      const val = cell == null ? "" : String(cell);
      if (/[",\n]/.test(val)) {
        return '"' + val.replace(/"/g, '""') + '"';
      }
      return val;
    }).join(",");
  }

  function handleExportCsv() {
    const entries = loadEntries();
    if (!entries.length) {
      alert("No entries to export.");
      return;
    }

    const headers = [
      "Timestamp","Name","RoleLevel","Context","Score","ZoneLabel",
      "Silent%","Sparse%","Resonant%","Loud%","Overwhelming%"
    ];
    questions.forEach(q => headers.push(`Q${q.id}`));
    const rows = [toCsvRow(headers)];

    entries.forEach(entry => {
      const zp = entry.zonePercents || {};
      const responses = entry.responses || {};
      const row = [
        entry.timestamp,
        entry.name || "",
        entry.roleLevel || "",
        entry.context || "",
        entry.score,
        descriptions[entry.score]?.label || "",
        zp.silent ?? "",
        zp.sparse ?? "",
        zp.resonant ?? "",
        zp.loud ?? "",
        zp.overwhelming ?? ""
      ];
      questions.forEach(q => row.push(responses[q.id] ?? ""));
      rows.push(toCsvRow(row));
    });

    const blob = new Blob([rows.join("\r\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "feedback_scale_entries.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function handleClearEntries() {
    if (!confirm("Clear all saved entries in this browser?")) return;
    localStorage.removeItem("feedbackScaleEntries");
    renderEntriesTableAndDropdown();
  }

  function handleLoadEntry() {
    const idx = loadSelect.value;
    if (idx === "") return;
    const entries = loadEntries();
    const entry = entries[parseInt(idx, 10)];
    if (!entry) return;

    document.getElementById("personName").value = entry.name || "";
    roleLevelSelect.value = entry.roleLevel || "";

    if (entry.context) {
      const match = Array.from(contextSelect.options).find(o => o.value === entry.context);
      if (match) {
        contextSelect.value = entry.context;
        contextCustom.value = "";
        contextCustom.style.display = "none";
      } else {
        contextSelect.value = "User-defined";
        contextCustom.value = entry.context;
        contextCustom.style.display = "block";
      }
    } else {
      contextSelect.value = "";
      contextCustom.value = "";
      contextCustom.style.display = "none";
    }

    questions.forEach(q => {
      document
        .querySelectorAll(`label.response-radio input[name="q${q.id}"]`)
        .forEach(r => {
          r.checked = false;
          r.parentElement.classList.remove("selected");
        });
    });

    if (entry.responses) {
      Object.entries(entry.responses).forEach(([qid, val]) => {
        const radio = document.querySelector(`label.response-radio input[name="q${qid}"][value="${val}"]`);
        if (radio) {
          radio.checked = true;
          radio.parentElement.classList.add("selected");
        }
      });
    }

    latestResponses = entry.responses || null;

    let percents = entry.zonePercents;
    let raw = entry.zoneRaw;

    if (!percents && entry.responses) {
      const calc = calculateZoneScores(entry.responses);
      percents = calc.percents;
      raw = calc.raw;
    }

    if (!percents) {
      alert("This saved entry does not contain enough data to reconstruct scores.");
      return;
    }

    latestZonePercents = percents;
    latestZoneRaw = raw;
    const entriesArr = Object.entries(percents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["resonant", 0];
    latestTopZone = topZone;
    latestTopScore = topScore;
    latestScaleScore = entry.score || null;

    const role = roleLevelSelect.value || null;
    renderResults(percents, role, topZone, topScore);
  }

  saveButton.addEventListener("click", () => storeEntry(false));
  exportButton.addEventListener("click", handleExportCsv);
  clearButton.addEventListener("click", handleClearEntries);
  loadSelect.addEventListener("change", handleLoadEntry);

  /* ---------- Calculation ---------- */

  function expandSectionForQuestion(questionId) {
    document.querySelectorAll(".question-number").forEach(el => el.classList.remove("missing"));

    const section = sections.find(s => s.questionIds.includes(questionId));
    if (!section) return;
    const sectionEl = document.querySelector(`.question-section[data-section-id="${section.id}"]`);
    if (!sectionEl) return;

    document.querySelectorAll(".question-section").forEach(sec => sec.classList.remove("open"));
    sectionEl.classList.add("open");

    const numCell = sectionEl.querySelector(`.question-number[data-qid="${questionId}"]`);
    if (numCell) {
      numCell.classList.add("missing");
      numCell.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }

  function handleCalculate() {
    if (!roleLevelSelect.value) {
      alert("Select a role level before calculating – it is used to compare your pattern against an ideal profile.");
      roleLevelSelect.scrollIntoView({ behavior: "smooth", block: "center" });
      roleLevelSelect.focus();
      const originalBorder = roleLevelSelect.style.borderColor;
      roleLevelSelect.style.borderColor = "#b91c1c";
      setTimeout(() => {
        roleLevelSelect.style.borderColor = originalBorder || "#000000";
      }, 1200);
      return;
    }

    const { responses, missingId } = getResponsesWithValidation();
    if (missingId != null) {
      expandSectionForQuestion(missingId);
      alert("Please answer all questions before calculating. A missing question has been highlighted.");
      return;
    }

    const validResponses = responses;

    calculateButton.classList.add("calculating");
    calculateButton.textContent = "Calculating…";
    boardWrapper.classList.add("calculated");

    const { raw, percents } = calculateZoneScores(validResponses);
    const entriesArr = Object.entries(percents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["resonant", 0];

    latestZonePercents = percents;
    latestZoneRaw = raw;
    latestTopZone = topZone;
    latestTopScore = topScore;
    latestResponses = validResponses;

    const role = roleLevelSelect.value || null;
    renderResults(percents, role, topZone, topScore);

    storeEntry(true);
    incrementAssessmentCount();

    setTimeout(() => {
      calculateButton.classList.remove("calculating");
      calculateButton.textContent = "Calculate from answers";
      boardWrapper.classList.remove("calculated");
    }, 1200);
  }

  calculateButton.addEventListener("click", handleCalculate);

  roleLevelSelect.addEventListener("change", () => {
    if (!latestZonePercents) return;
    const role = roleLevelSelect.value || null;
    const entriesArr = Object.entries(latestZonePercents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["resonant", 0];
    renderResults(latestZonePercents, role, topZone, topScore);
  });

  /* ---------- Fullscreen ---------- */

  document.getElementById("fullscreenToggle").addEventListener("click", () => {
    if (!document.fullscreenElement) {
      boardWrapper.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });

  /* ---------- PDF export with header/footer and both patterns ---------- */

  async function handleExportPdf() {
    const { jsPDF } = window.jspdf;

    const sectionEls = Array.from(document.querySelectorAll(".question-section"));
    const openState = sectionEls.map(el => el.classList.contains("open"));
    sectionEls.forEach(el => el.classList.add("open"));

    boardInner.classList.add("export-mode");

    const name = document.getElementById("personName").value.trim() || "Not specified";
    const roleCode = roleLevelSelect.value;
    const role = roleLabels[roleCode] || (roleCode || "Not specified");
    let contextValue = "";
    if (contextSelect.value === "User-defined") {
      contextValue = contextCustom.value.trim();
    } else {
      contextValue = contextSelect.value || "";
    }
    const contextLabel = contextValue || "Not specified";
    const now = new Date();
    const dateString = now.toLocaleString();

    const currentPattern = latestZonePercents
      ? `Current pattern – Silent ${latestZonePercents.silent}% · Sparse ${latestZonePercents.sparse}% · Resonant ${latestZonePercents.resonant}% · Loud ${latestZonePercents.loud}% · Overwhelming ${latestZonePercents.overwhelming}%.`
      : "Current pattern – not yet calculated.";

    const target = currentTarget(roleCode);
    const idealPattern = target
      ? `Ideal pattern for ${role}: Silent ${target.silent}% · Sparse ${target.sparse}% · Resonant ${target.resonant}% · Loud ${target.loud}% · Overwhelming ${target.overwhelming}%.`
      : "Ideal pattern – select a role level in the tool to view.";

    const exportHeader = document.createElement("div");
    exportHeader.className = "export-header";
    exportHeader.innerHTML = `
      <div class="export-header-title">Feedback scale assessment</div>
      <div class="export-header-meta">
        Name: ${name} · Role: ${role} · Context: ${contextLabel} · Date: ${dateString}
      </div>
      <div class="export-highlight">
        Both Silent and Overwhelming are feedback zones we generally do not enjoy and that rarely support learning.
        We aim to spend more time in Resonant feedback so that everyday conversations help us grow, and we get better
        at recovering from the occasional Loud or difficult moment. This assessment is about understanding where
        your feedback environment sits now and whether the daily “exercise” of feedback is helping or hindering that growth.
      </div>
      <div class="export-highlight">
        ${currentPattern}<br>
        ${idealPattern}
      </div>
      <div class="export-suggestion">
        ${latestFollowupText || ""}
      </div>
    `;
    boardInner.insertBefore(exportHeader, boardInner.firstChild);

    const exportFooter = document.createElement("div");
    exportFooter.className = "export-footer";
    const url = "https://imthebus.co.uk/web-tools/feedback-scale.html";
    exportFooter.textContent = `Generated from IMTHEBUS Feedback scale tool (${url}) on ${dateString}`;
    boardInner.appendChild(exportFooter);

    const boardHeaderEl = document.querySelector(".board-header");
    const originalBoardHeaderDisplay = boardHeaderEl.style.display;
    boardHeaderEl.style.display = "none";

    const canvas = await html2canvas(boardWrapper, { scale: 2 });

    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    let yPos = 0;
    let page = 0;

    while (yPos < canvas.height) {
      if (page > 0) pdf.addPage();
      const pageCanvas = document.createElement("canvas");
      const pageCtx = pageCanvas.getContext("2d");
      pageCanvas.width = canvas.width;
      const pagePixelHeight = Math.min(
        canvas.height - yPos,
        Math.round((pageHeight * canvas.width) / pageWidth)
      );
      pageCanvas.height = pagePixelHeight;
      pageCtx.drawImage(canvas, 0, yPos, canvas.width, pagePixelHeight, 0, 0, canvas.width, pagePixelHeight);
      const pageImg = pageCanvas.toDataURL("image/jpeg", 0.9);
      const pageImgHeight = (pagePixelHeight * imgWidth) / canvas.width;
      pdf.addImage(pageImg, "JPEG", 0, 0, imgWidth, pageImgHeight);
      yPos += pagePixelHeight;
      page += 1;
    }

    pdf.save("Feedback_Scale_Assessment.pdf");

    exportHeader.remove();
    exportFooter.remove();
    boardInner.classList.remove("export-mode");
    boardHeaderEl.style.display = originalBoardHeaderDisplay || "";

    sectionEls.forEach((el, idx) => {
      el.classList.toggle("open", openState[idx]);
    });
  }

  exportPdfButton.addEventListener("click", handleExportPdf);
</script>
</body>
</html>
