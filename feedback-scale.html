<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Feedback scale – IMTHEBUS Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Inter:wght@400;500;600&display=swap">

  <!-- PDF / capture -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --bg-board: #fdfdfd;
      --ink: #111111;
      --border-strong: #000000;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f3f3f3;
      background-image: url("assets/whiteboard.jpg");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: var(--ink);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Shell */

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    nav {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(253, 253, 253, 0.96);
      border-bottom: 2px solid var(--border-strong);
      padding: 0.4rem 1.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-left {
      display: flex;
      gap: 1.25rem;
      font-size: 0.95rem;
    }

    .nav-left a {
      position: relative;
      padding-bottom: 0.1rem;
    }

    .nav-left a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -0.05rem;
      width: 0;
      height: 2px;
      background: #000;
      transition: width 0.15s ease-out;
    }

    .nav-left a:hover::after {
      width: 100%;
    }

    .nav-right {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.2rem;
      letter-spacing: 0.04em;
    }

    main {
      flex: 1;
      padding: 1.5rem 1.25rem 2rem;
    }

    .page-inner {
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-grid {
      display: grid;
      grid-template-columns: minmax(260px, 340px) minmax(0, 1fr);
      gap: 1.25rem;
      align-items: flex-start;
    }

    @media (max-width: 860px) {
      .page-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Sidebar clipboard */

    .sidebar {
      background: #ffffff;
      border: 3px solid #000;
      border-radius: 18px;
      box-shadow: 0 10px 0 rgba(0, 0, 0, 0.12);
      padding: 1.1rem 1.1rem 1.2rem;
      position: relative;
    }

    .sidebar::before {
      content: "";
      position: absolute;
      top: 0.45rem;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 9px;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
    }

    .sidebar-title {
      margin-top: 1.6rem;
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.6rem;
    }

    .sidebar-subtitle {
      margin-top: 0.25rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .sidebar-field {
      margin-top: 0.75rem;
      font-size: 0.85rem;
    }

    .sidebar-field label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .sidebar-field input,
    .sidebar-field select {
      width: 100%;
      font: inherit;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
    }

    .sidebar-note {
      margin-top: 0.5rem;
      font-size: 0.78rem;
      color: #555;
    }

    .sidebar-section {
      margin-top: 0.9rem;
      border-top: 1px solid #ddd;
      padding-top: 0.5rem;
    }

    .sidebar-section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .sidebar-section-header span.label {
      font-weight: 600;
    }

    .sidebar-section-header span.hint {
      font-size: 0.78rem;
      color: #777;
    }

    .sidebar-section-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
      font-size: 0.82rem;
      color: #444;
    }

    .sidebar-section.open .sidebar-section-body {
      max-height: 260px;
    }

    .sidebar-section-body p {
      margin: 0.45rem 0;
    }

    .sidebar-section-body ul {
      margin: 0.3rem 0 0.3rem 1.1rem;
      padding: 0;
    }

    .sidebar-section-body li {
      margin-bottom: 0.2rem;
    }

    .sidebar-section.sidebar-export.open .sidebar-section-body {
      max-height: 260px;
    }

    .sidebar-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }

    .sidebar-buttons button {
      font: inherit;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 2px solid #000;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
      background: #fff;
    }

    .sidebar-buttons button.primary {
      background: #000;
      color: #fff;
    }

    .sidebar-buttons button.danger {
      background: #e11d48;
      color: #fff;
    }

    .sidebar-buttons button:hover {
      transform: translateY(-1px);
    }

    .sidebar-buttons select {
      font: inherit;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 2px solid #000;
      padding: 0.28rem 0.55rem;
      max-width: 100%;
    }

    /* Board */

    .board-wrapper {
      background: var(--bg-board);
      border-radius: 22px;
      border: 3px solid var(--border-strong);
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.14);
      padding: 1rem 1.15rem 1.35rem;
      position: relative;
      overflow: hidden;
      transition: box-shadow 0.2s ease-out;
    }

    .board-wrapper:fullscreen {
      overflow-y: auto;
    }

    .board-wrapper.calculated {
      box-shadow: 0 0 0 3px #111 inset, 0 14px 0 rgba(0, 0, 0, 0.14);
    }

    .board-inner {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .board-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .board-title-display {
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.7rem;
    }

    .board-toolbar {
      display: flex;
      gap: 0.4rem;
    }

    .board-toolbar button {
      font: inherit;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.25rem 0.7rem;
      cursor: pointer;
    }

    .board-highlight {
      border-radius: 18px;
      border: 2px solid #000;
      background: #fffbe6;
      padding: 0.65rem 0.8rem;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .board-highlight strong {
      font-weight: 600;
    }

    .board-body {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(260px, 1fr);
      gap: 1rem;
      align-items: flex-start;
    }

    @media (max-width: 980px) {
      .board-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .board-inner.export-mode .board-body {
      display: flex;
      flex-direction: column;
    }

    .board-column {
      min-width: 0;
    }

    /* Questions */

    .question-note {
      font-size: 0.78rem;
      color: #555;
      margin-bottom: 0.45rem;
    }

    .question-card {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      overflow: hidden;
    }

    .question-card-header {
      padding: 0.55rem 0.7rem;
      border-bottom: 2px solid #000;
      font-family: "Permanent Marker", system-ui, sans-serif;
      font-size: 1.05rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .question-card-header span.sub {
      font-family: "Inter", system-ui, sans-serif;
      font-size: 0.78rem;
      font-weight: 400;
      color: #555;
      margin-left: 0.25rem;
    }

    .question-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .question-table th,
    .question-table td {
      padding: 0.45rem 0.5rem;
      vertical-align: middle;
    }

    .question-table th {
      border-bottom: 1px solid #ddd;
      font-size: 0.78rem;
      text-align: center;
    }

    .question-table th:first-child,
    .question-table td:first-child {
      width: 2.2rem;
      text-align: center;
    }

    .question-table th:nth-child(2),
    .question-table td:nth-child(2) {
      text-align: left;
    }

    .question-number {
      font-size: 0.8rem;
      color: #444;
    }

    .question-text {
      max-width: 420px;
    }

    .scale-header-row th {
      font-weight: 500;
    }

    .scale-header-row th:nth-child(3) {
      text-align: center;
    }

    .scale-header-row span.label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .scale-header-row span.caption {
      display: block;
      font-size: 0.7rem;
      color: #666;
    }

    .response-cell {
      text-align: center;
    }

    .response-radio {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid #000;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .response-radio input {
      display: none;
    }

    .response-radio span {
      user-select: none;
    }

    .response-radio.selected {
      background: #000;
      color: #fff;
    }

    .calculate-row {
      margin-top: 0.65rem;
      display: flex;
      justify-content: flex-start;
    }

    .calculate-row button {
      font: inherit;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 2px solid #000;
      background: #000;
      color: #fff;
      padding: 0.45rem 1.1rem;
      cursor: pointer;
      transition: background 0.15s ease-out, transform 0.08s ease-out;
    }

    .calculate-row button.calculating {
      background: #1f2937;
      transform: translateY(1px);
    }

    /* Donut and results */

    .donut-panel {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.6rem 0.8rem 0.7rem;
      margin-bottom: 0.6rem;
    }

    .donut-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.3rem;
    }

    .donut-header-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .donut-header-note {
      font-size: 0.75rem;
      color: #555;
    }

    #zoneRing {
      width: 100%;
      height: 220px;
      display: block;
    }

    .zone-legend-row {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      margin-top: 0.15rem;
    }

    .zone-legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .zone-legend-label {
      flex: 1;
    }

    .zone-legend-value {
      min-width: 2.4rem;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .results-panel,
    .overall-panel,
    .entries-panel {
      border-radius: 16px;
      border: 2px solid #000;
      background: #fff;
      padding: 0.7rem 0.8rem;
      font-size: 0.85rem;
      margin-bottom: 0.6rem;
    }

    .results-panel h3,
    .overall-panel h3,
    .entries-panel h3 {
      margin: 0 0 0.4rem;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .results-panel table,
    .overall-panel table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.35rem;
      font-size: 0.8rem;
    }

    .results-panel th,
    .results-panel td,
    .overall-panel th,
    .overall-panel td {
      border: 1px solid #000;
      padding: 0.25rem 0.3rem;
      vertical-align: top;
    }

    .conversation-prompts {
      margin-top: 0.4rem;
      font-size: 0.8rem;
    }

    .conversation-prompts ul {
      margin: 0.25rem 0 0.25rem 1rem;
      padding: 0;
    }

    .entries-panel table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .entries-panel th,
    .entries-panel td {
      border: 1px solid #000;
      padding: 0.25rem 0.3rem;
    }

    /* Export header/footer */

    .export-header {
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.4rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .export-header-title {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .export-header-meta {
      font-size: 0.8rem;
    }

    .export-footer {
      border-top: 1px solid #ccc;
      margin-top: 0.8rem;
      padding-top: 0.3rem;
      font-size: 0.75rem;
      text-align: right;
      color: #444;
    }

    /* Footer */

    footer.site-footer {
      border-top: 2px solid #000;
      background: rgba(253, 253, 253, 0.96);
      padding: 0.8rem 1.75rem 1rem;
      font-size: 0.8rem;
    }

    .footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 1.4rem;
    }

    .footer-group-title {
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 600;
      font-size: 0.72rem;
      margin-bottom: 0.2rem;
    }

    .footer-group a {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.1rem;
    }

    .footer-group a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div class="page">
  <nav>
    <div class="nav-left">
      <a href="index.html">Home</a>
      <a href="index.html#tools">Tools</a>
      <a href="about.html">About</a>
    </div>
    <div class="nav-right">IMTHEBUS tools</div>
  </nav>

  <main>
    <div class="page-inner">
      <div class="page-grid">

        <!-- Sidebar -->
        <aside class="sidebar">
          <h1 class="sidebar-title">Feedback scale</h1>
          <p class="sidebar-subtitle">
            A shared language for how feedback feels at work, from Silent through Sparse and Resonant, into Loud and Overwhelming.
          </p>

          <div class="sidebar-field">
            <label for="personName">Name (optional)</label>
            <input id="personName" type="text" placeholder="e.g. Alex Smith" />
          </div>

          <div class="sidebar-field">
            <label for="roleLevel">Role level (optional)</label>
            <select id="roleLevel">
              <option value="">Select role level</option>
              <option value="L1">Operator</option>
              <option value="L2">Senior Operator</option>
              <option value="L3">Supervisor</option>
              <option value="L4">Manager</option>
              <option value="L5">Director</option>
            </select>
          </div>

          <div class="sidebar-field">
            <label for="context">Context (optional)</label>
            <select id="context">
              <option value="">Select context</option>
              <option value="Normal week">Normal week</option>
              <option value="Peak period">Peak period</option>
              <option value="Project workload">Project workload</option>
              <option value="Returning from leave">Returning from leave</option>
              <option value="Team changes">Team changes</option>
              <option value="User-defined">Other (specify below)</option>
            </select>
          </div>
          <div class="sidebar-field" style="margin-top:0.45rem;">
            <input id="contextCustom" type="text" placeholder="Specify your context (optional)" style="display:none;">
          </div>

          <p class="sidebar-note">
            Use this to capture how the last few days or weeks of feedback have actually felt.
          </p>

          <div class="sidebar-section">
            <div class="sidebar-section-header">
              <span class="label">How this tool works</span>
              <span class="hint">tap or click to expand</span>
            </div>
            <div class="sidebar-section-body">
              <p>
                The Silent → Sparse → Resonant → Loud → Overwhelming scale turns the feedback environment into a simple conversational tool.
              </p>
              <p>
                You answer a short set of questions about the volume, tone and usefulness of feedback.
                The tool estimates how much of your experience sits in each zone and suggests prompts for a better conversation.
              </p>
              <p>
                It is not a diagnostic or performance rating. It is a way to structure a discussion about expectations, support and how feedback is handled.
              </p>
            </div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-section-header">
              <span class="label">Data and privacy</span>
              <span class="hint">tap or click to expand</span>
            </div>
            <div class="sidebar-section-body">
              <p>
                Your responses are stored only in this browser using local storage.
                Nothing is uploaded, shared or sent anywhere.
              </p>
              <p>
                Clearing browser storage, switching device or pressing “Clear all saved entries” deletes the data permanently.
              </p>
            </div>
          </div>

          <div class="sidebar-section sidebar-export">
            <div class="sidebar-section-header">
              <span class="label">Saved results and export</span>
              <span class="hint">tap or click to expand</span>
            </div>
            <div class="sidebar-section-body">
              <div class="sidebar-field" style="margin-top:0.4rem;">
                <label for="loadEntry">Load a previous result</label>
                <select id="loadEntry">
                  <option value="">Select saved entry</option>
                </select>
              </div>
              <div class="sidebar-buttons">
                <button id="saveEntry" type="button" class="primary">Save entry</button>
                <button id="exportCsv" type="button">Export CSV</button>
                <button id="exportPdf" type="button">Save as PDF</button>
                <button id="clearEntries" type="button" class="danger">Clear all</button>
              </div>
              <p class="sidebar-note" style="margin-top:0.35rem;">
                Saved entries stay in this browser only. Use CSV or PDF to keep a record elsewhere.
              </p>
            </div>
          </div>
        </aside>

        <!-- Board -->
        <section class="board-wrapper" id="boardWrapper">
          <div class="board-inner" id="boardInner">
            <div class="board-header">
              <div class="board-title-display">Feedback scale assessment</div>
              <div class="board-toolbar">
                <button type="button" id="fullscreenToggle">Fullscreen board</button>
              </div>
            </div>

            <div class="board-highlight">
              <strong>Why feedback patterns matter.</strong>
              This tool helps you and your manager understand what feedback looks and feels like in your role.
              It maps your answers to five zones: Silent, Sparse, Resonant, Loud and Overwhelming, so you can
              talk about the environment rather than guessing or relying only on formal reviews.
            </div>

            <div class="board-body" id="boardBody">
              <!-- Left: questions -->
              <div class="board-column">
                <p class="question-note">
                  For each statement, choose how often it matches your current feedback experience.
                  Keep the dots on <strong>3</strong> if a question does not really apply.
                </p>

                <div class="question-card">
                  <div class="question-card-header">
                    <div>
                      Feedback questions
                      <span class="sub">Volume, tone and usefulness of feedback.</span>
                    </div>
                  </div>
                  <table class="question-table">
                    <thead>
                    <tr class="scale-header-row">
                      <th>#</th>
                      <th>Question</th>
                      <th colspan="5">
                        <span class="label">Never → Always</span>
                        <span class="caption">1 = never, 3 = sometimes, 5 = always</span>
                      </th>
                    </tr>
                    </thead>
                    <tbody id="questionsBody"></tbody>
                  </table>
                </div>

                <div class="calculate-row">
                  <button id="calculateFromQuestions" type="button">Calculate from answers</button>
                </div>
              </div>

              <!-- Right: charts and summaries -->
              <div class="board-column">
                <div class="donut-panel">
                  <div class="donut-header">
                    <div class="donut-header-title">Zone pattern</div>
                    <div class="donut-header-note" id="donutLabel">
                      Equal starting pattern. Update after calculation.
                    </div>
                  </div>
                  <canvas id="zoneRing" width="260" height="220"></canvas>
                  <div id="zoneRingLegend"></div>
                </div>

                <div class="results-panel">
                  <h3>Calculated zone and scores</h3>
                  <div id="calculationResults">
                    Answer the questions and click <strong>Calculate from answers</strong> to see your pattern,
                    ideal profile for the role and suggested prompts.
                  </div>
                </div>

                <div class="overall-panel">
                  <h3>Overall scale result</h3>
                  <div id="overallResult">
                    Run a calculation to see the dominant feedback zone, a short description, manager guidance
                    and where your pattern differs most from the ideal profile for this role.
                  </div>
                </div>

                <div class="entries-panel">
                  <h3>Recorded entries (this browser)</h3>
                  <p style="margin:0 0 0.3rem;">Use this to track how the feedback pattern changes over time.</p>
                  <table id="entriesTable">
                    <thead>
                    <tr>
                      <th>Date/time</th>
                      <th>Name</th>
                      <th>Role</th>
                      <th>Context</th>
                      <th>Score</th>
                      <th>Zone</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div>© <span id="year"></span> IMTHEBUS. All rights reserved.</div>
        <div>
          Tool design, questions, scoring model and interpretation framework created by Dean Rougvie.
          All calculations are experimental and may contain errors.
        </div>
      </div>
      <div class="footer-links">
        <div class="footer-group">
          <div class="footer-group-title">Contact</div>
          <a href="mailto:contact@imthebus.co.uk?subject=General%20enquiry">contact@imthebus.co.uk</a>
          <a href="mailto:contact@imthebus.co.uk?subject=Bug%20report">Report a bug</a>
          <a href="mailto:contact@imthebus.co.uk?subject=Tool%20idea">Suggest a tool</a>
        </div>
        <div class="footer-group">
          <div class="footer-group-title">Legal</div>
          <a href="stuff.html#privacy">Privacy notice</a>
          <a href="stuff.html#terms">Terms of use</a>
        </div>
      </div>
    </div>
  </footer>
</div>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();

  // Sidebar collapsible sections (click to open/close, like Bored to Panic)
  document.querySelectorAll(".sidebar-section").forEach(section => {
    const header = section.querySelector(".sidebar-section-header");
    if (!header) return;
    header.addEventListener("click", () => {
      section.classList.toggle("open");
    });
  });

  const contextSelect = document.getElementById("context");
  const contextCustom = document.getElementById("contextCustom");
  contextSelect.addEventListener("change", () => {
    contextCustom.style.display = contextSelect.value === "User-defined" ? "block" : "none";
  });

  // Questions and options
  const questions = [
    { id: 1,  text: "I receive specific feedback on my work, not just general comments." },
    { id: 2,  text: "I can go long periods without anyone commenting on how I am doing." },
    { id: 3,  text: "Feedback I receive is mostly about small day to day tasks rather than bigger development." },
    { id: 4,  text: "Feedback helps me understand the impact of my work on others or on the business." },
    { id: 5,  text: "I receive so much feedback that it is hard to know what to act on first." },
    { id: 6,  text: "When something goes well, someone usually notices and says so." },
    { id: 7,  text: "Feedback usually arrives only when something has gone wrong." },
    { id: 8,  text: "I feel comfortable asking for feedback when I need it." },
    { id: 9,  text: "Different people give me conflicting feedback about what good looks like." },
    { id: 10, text: "I know what my manager would say I am doing well right now." },
    { id: 11, text: "I know what my manager would say I should improve next." },
    { id: 12, text: "Feedback conversations feel rushed, squeezed in or reactive." },
    { id: 13, text: "I leave feedback conversations with a clear next step or action." },
    { id: 14, text: "I feel anxious or worried in the lead up to feedback conversations." },
    { id: 15, text: "The tone of feedback is respectful, even when it is challenging." },
    { id: 16, text: "I receive feedback in group settings that would feel better one to one." },
    { id: 17, text: "I get regular check ins about how I am doing, even when nothing is on fire." },
    { id: 18, text: "During feedback conversations I feel listened to, not just spoken at." },
    { id: 19, text: "The amount of feedback I receive matches the level of responsibility I have." },
    { id: 20, text: "Feedback focuses only on results, not on how the work gets done." },
    { id: 21, text: "I hear a consistent message about what good performance looks like." },
    { id: 22, text: "Feedback connects my work to the bigger picture or strategy." },
    { id: 23, text: "I feel on edge because I am expecting more criticism or negative feedback." },
    { id: 24, text: "I understand how feedback will be used in performance or pay decisions." },
    { id: 25, text: "I sometimes avoid asking for feedback because of how it is usually handled." }
  ];

  const reverseScored = new Set([]); // none for this tool

  const responseOptions = [
    { value: 0, label: "1" },
    { value: 1, label: "2" },
    { value: 2, label: "3" },
    { value: 3, label: "4" },
    { value: 4, label: "5" }
  ];

  // Zone mapping
  const zoneQuestions = {
    silent:       [2, 7],
    sparse:       [3, 7, 24],
    resonant:     [1, 4, 6, 8, 10, 11, 13, 15, 17, 18, 19, 21, 22],
    loud:         [12, 14, 16, 20],
    overwhelming: [5, 9, 14, 16, 23, 25]
  };

  const zoneLabels = {
    silent: "Silent",
    sparse: "Sparse",
    resonant: "Resonant",
    loud: "Loud",
    overwhelming: "Overwhelming"
  };

  const zoneColors = {
    silent:       { fill: "#111827", stroke: "#111827" },
    sparse:       { fill: "#60a5fa", stroke: "#1d4ed8" },
    resonant:     { fill: "#4ade80", stroke: "#15803d" },
    loud:         { fill: "#fbbf24", stroke: "#b45309" },
    overwhelming: { fill: "#f97373", stroke: "#b91c1c" }
  };

  // Role targets
  const roleTargets = {
    L1: { silent: 20, sparse: 35, resonant: 35, loud: 10, overwhelming: 0 },
    L2: { silent: 15, sparse: 30, resonant: 40, loud: 15, overwhelming: 0 },
    L3: { silent: 10, sparse: 25, resonant: 45, loud: 20, overwhelming: 0 },
    L4: { silent: 8,  sparse: 20, resonant: 50, loud: 22, overwhelming: 0 },
    L5: { silent: 5,  sparse: 15, resonant: 55, loud: 25, overwhelming: 0 }
  };

  const roleLabels = {
    L1: "Operator",
    L2: "Senior Operator",
    L3: "Supervisor",
    L4: "Manager",
    L5: "Director"
  };

  const descriptions = {
    1: {
      label: "Silent",
      text: "Very little feedback. You are often guessing how you are doing. Wins may go unnoticed and development needs are not clearly named.",
      manager: "Create regular, low drama check ins. Start with simple questions such as what is going well, what is hard and what should we focus on next."
    },
    2: {
      label: "Sparse",
      text: "Some feedback appears, usually around tasks or problems, but it is irregular and not joined up. The signal is there, but it is faint.",
      manager: "Agree a basic rhythm for feedback. Add short, structured conversations that cover strengths, development and expectations, not only issues when they arise."
    },
    3: {
      label: "Resonant",
      text: "Healthy feedback pattern. Conversations are regular, specific and respectful. You understand what is working, what needs attention and why it matters.",
      manager: "Protect this pattern. Keep feedback anchored to concrete examples and shared goals. Remove friction that gets in the way of good conversations."
    },
    4: {
      label: "Loud",
      text: "Feedback is frequent or intense. It may feel rushed, highly reactive or focused only on problems. It can be difficult to tease out the most important points.",
      manager: "Slow things down. Prioritise no more than one or two key messages. Agree what can wait and use quieter follow ups rather than everything in one burst."
    },
    5: {
      label: "Overwhelming",
      text: "Feedback feels constant, conflicting or emotionally heavy. It may feel unsafe or exhausting to be on the receiving end of it.",
      manager: "Step back and reset. Clarify which feedback matters, remove unnecessary criticism and agree clear boundaries about how and where feedback will be given."
    }
  };

  const roleLevelSelect = document.getElementById("roleLevel");
  const saveButton = document.getElementById("saveEntry");
  const exportButton = document.getElementById("exportCsv");
  const exportPdfButton = document.getElementById("exportPdf");
  const clearButton = document.getElementById("clearEntries");
  const loadSelect = document.getElementById("loadEntry");
  const questionsBody = document.getElementById("questionsBody");
  const calculateButton = document.getElementById("calculateFromQuestions");
  const calculationResults = document.getElementById("calculationResults");
  const overallResult = document.getElementById("overallResult");
  const entriesTableBody = document.querySelector("#entriesTable tbody");
  const donutLabel = document.getElementById("donutLabel");
  const boardWrapper = document.getElementById("boardWrapper");
  const boardInner = document.getElementById("boardInner");

  let latestZonePercents = null;
  let latestZoneRaw = null;
  let latestTopZone = null;
  let latestTopScore = null;
  let latestResponses = null;
  let latestScaleScore = null;

  /* Build questions (with default 3 selected, like earlier version) */

  function buildQuestions() {
    questions.forEach(q => {
      const tr = document.createElement("tr");

      const tdNum = document.createElement("td");
      tdNum.className = "question-number";
      tdNum.textContent = q.id;
      tr.appendChild(tdNum);

      const tdText = document.createElement("td");
      tdText.className = "question-text";
      tdText.textContent = q.text;
      tr.appendChild(tdText);

      responseOptions.forEach(opt => {
        const td = document.createElement("td");
        td.className = "response-cell";

        const label = document.createElement("label");
        label.className = "response-radio";
        const input = document.createElement("input");
        input.type = "radio";
        input.name = `q${q.id}`;
        input.value = opt.value;
        if (opt.value === 2) input.checked = true;

        const span = document.createElement("span");
        span.textContent = opt.label;

        label.appendChild(input);
        label.appendChild(span);
        td.appendChild(label);
        tr.appendChild(td);

        label.addEventListener("click", () => {
          document
            .querySelectorAll(`label.response-radio input[name="q${q.id}"]`)
            .forEach(r => r.parentElement.classList.remove("selected"));
          label.classList.add("selected");
        });

        if (opt.value === 2) {
          label.classList.add("selected");
        }
      });

      questionsBody.appendChild(tr);
    });
  }

  buildQuestions();

  /* Donut chart (wedge style preserved) */

  const ringCanvas = document.getElementById("zoneRing");
  const ringCtx = ringCanvas.getContext("2d");

  function drawRingChart(data) {
    const w = ringCanvas.width;
    const h = ringCanvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const maxRadius = Math.min(w, h) / 2 - 6;

    ringCtx.clearRect(0, 0, w, h);

    const order = ["silent", "sparse", "resonant", "loud", "overwhelming"];
    const values = data || { silent: 20, sparse: 20, resonant: 20, loud: 20, overwhelming: 20 };

    let startAngle = -Math.PI / 2;
    order.forEach(zone => {
      const pct = values[zone] ?? 0;
      const angle = (pct / 100) * 2 * Math.PI;
      if (angle <= 0) return;

      ringCtx.beginPath();
      ringCtx.moveTo(cx, cy);
      ringCtx.arc(cx, cy, maxRadius, startAngle, startAngle + angle);
      ringCtx.closePath();
      ringCtx.fillStyle = zoneColors[zone].fill;
      ringCtx.fill();

      startAngle += angle;
    });

    ringCtx.beginPath();
    ringCtx.arc(cx, cy, maxRadius, 0, 2 * Math.PI);
    ringCtx.strokeStyle = "#000";
    ringCtx.lineWidth = 2;
    ringCtx.stroke();
  }

  function updateRingLegend(data, labelText) {
    const legend = document.getElementById("zoneRingLegend");
    const order = ["silent", "sparse", "resonant", "loud", "overwhelming"];
    const values = data || { silent: 20, sparse: 20, resonant: 20, loud: 20, overwhelming: 20 };
    const rows = order.map(zone => {
      const pct = values[zone] ?? 0;
      return `
        <div class="zone-legend-row">
          <span class="zone-legend-swatch" style="background:${zoneColors[zone].stroke};"></span>
          <span class="zone-legend-label">${zoneLabels[zone]}</span>
          <span class="zone-legend-value">${pct}%</span>
        </div>
      `;
    }).join("");
    legend.innerHTML = rows;
    donutLabel.textContent = labelText;
  }

  drawRingChart(null);
  updateRingLegend(null, "Equal starting pattern. Update after calculation.");

  /* Scoring using per-zone averages */

  function getResponses() {
    const responses = {};
    for (const q of questions) {
      const checked = document.querySelector(`input[name="q${q.id}"]:checked`);
      if (!checked) return null;
      responses[q.id] = parseInt(checked.value, 10);
    }
    return responses;
  }

  function calculateZoneScores(responses) {
    const raw = {};
    const avg = {};
    let totalIntensity = 0;
    const zones = Object.keys(zoneQuestions);

    zones.forEach(zone => {
      const ids = zoneQuestions[zone];
      let sum = 0;
      ids.forEach(id => {
        const base = responses[id] ?? 0;
        const score = reverseScored.has(id) ? (4 - base) : base;
        sum += score;
      });
      const mean = ids.length ? sum / ids.length : 0;
      raw[zone] = sum;
      avg[zone] = mean;
      totalIntensity += mean;
    });

    const percents = {};
    if (totalIntensity === 0) {
      zones.forEach(z => { percents[z] = 0; });
    } else {
      let running = 0;
      zones.forEach((zone, idx) => {
        if (idx === zones.length - 1) {
          percents[zone] = Math.max(0, 100 - running);
        } else {
          const p = Math.round((avg[zone] / totalIntensity) * 100);
          percents[zone] = p;
          running += p;
        }
      });
    }

    return { raw, percents };
  }

  function currentTarget(role) {
    return role ? roleTargets[role] : null;
  }

  function buildFlags(percents) {
    const flags = [];

    if (percents.overwhelming >= 15) {
      flags.push("Overwhelming feedback at or above 15%: explore what feels unsafe or excessive and agree clear changes to how feedback is given.");
    } else if (percents.overwhelming >= 10) {
      flags.push("Overwhelming feedback between 10% and 15%: agree regular check-ins to spot patterns that push things too far.");
    }

    if (percents.loud + percents.overwhelming >= 35) {
      flags.push("Combined Loud and Overwhelming above 35%: feedback may feel intense or chaotic. Simplify the message and slow the pace.");
    }

    if (percents.silent >= 25) {
      flags.push("Silent at or above 25%: feedback is mostly absent. Agree a basic rhythm of short check-ins and clearer expectations.");
    }

    if (percents.resonant < 30) {
      flags.push("Resonant below 30%: there may be few high quality, useful feedback conversations. Look for one or two places to improve quality first.");
    }

    if (
      percents.resonant >= 35 &&
      percents.resonant <= 60 &&
      percents.overwhelming < 15 &&
      percents.silent < 20 &&
      percents.loud >= 10 &&
      percents.loud <= 25
    ) {
      flags.push("Overall pattern looks healthy: mostly in Resonant with some Loud for urgency and low Overwhelming. Focus on keeping messages clear and aligned.");
    }

    return flags;
  }

  function levelLabel(actual, ideal) {
    const diff = actual - ideal;
    if (Math.abs(diff) <= 5) return "about right";
    if (diff > 5) return "high";
    return "low";
  }

  function zoneNarrative(zone, actual, ideal) {
    const level = levelLabel(actual, ideal);
    switch (zone) {
      case "silent":
        if (level === "high") return "Silence is high; build in regular, low pressure feedback moments.";
        if (level === "low") return "Silence is low; people usually know where they stand.";
        return "Silence is about right; there is enough information flowing.";
      case "sparse":
        if (level === "high") return "Sparse feedback is high; make basic conversations more frequent and purposeful.";
        if (level === "low") return "Sparse feedback is low; focus instead on maintaining strong Resonant feedback.";
        return "Sparse feedback is about right; day to day comments exist but do not dominate.";
      case "resonant":
        if (level === "high") return "Resonant feedback is high; check that the volume is still manageable and focused.";
        if (level === "low") return "Resonant feedback is low; introduce clearer, specific conversations about strengths and development.";
        return "Resonant feedback is about right; protect the quality of these conversations.";
      case "loud":
        if (level === "high") return "Loud feedback is high; strip out noise and reduce reactive, problem only feedback.";
        if (level === "low") return "Loud feedback is low; consider whether there is enough urgency and follow through where needed.";
        return "Loud feedback is near ideal; watch for spikes and avoid constant firefighting.";
      case "overwhelming":
        if (level === "high") return "Overwhelming feedback is high; reset expectations and boundaries so feedback feels safer and more focused.";
        return "Overwhelming feedback is low; keep escalation paths clear for more serious issues.";
      default:
        return "";
    }
  }

  function buildComparisonTable(percents, target) {
    const zones = ["silent", "sparse", "resonant", "loud", "overwhelming"];
    let rows = "";
    zones.forEach(z => {
      const actual = percents[z];
      const ideal = target[z];
      const comment = zoneNarrative(z, actual, ideal);
      rows += `
        <tr>
          <td>${zoneLabels[z]}</td>
          <td>${actual}%</td>
          <td>${ideal}%</td>
          <td>${comment}</td>
        </tr>
      `;
    });
    return `
      <table>
        <thead>
          <tr>
            <th>Zone</th>
            <th>Current</th>
            <th>Target</th>
            <th>Quick interpretation and action</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    `;
  }

  function buildIdealSummary(role, target) {
    if (!target) {
      return "<span style='color:#555;'>Select a role level to see the ideal feedback distribution for that role.</span>";
    }
    const label = roleLabels[role] || role;
    return `
      Ideal for <strong>${label}</strong>:
      Silent ${target.silent}%,
      Sparse ${target.sparse}%,
      Resonant ${target.resonant}%,
      Loud ${target.loud}%,
      Overwhelming ${target.overwhelming}%.
    `;
  }

  function buildNextLevelRecommendation(percents, role) {
    const nextRoleMap = { L1: "L2", L2: "L3", L3: "L4", L4: "L5" };
    const nextRole = nextRoleMap[role];
    if (!role || !nextRole) {
      return "<span style='color:#555;'>Select a role level below Director to see a suggested focus for progressing to the next level.</span>";
    }

    const nextTarget = roleTargets[nextRole];
    if (!nextTarget) {
      return "<span style='color:#555;'>No next level profile available.</span>";
    }

    const zones = ["silent", "sparse", "resonant", "loud", "overwhelming"];
    let bestZone = null;
    let bestGap = 0;

    zones.forEach(z => {
      const actual = percents[z] ?? 0;
      const ideal = nextTarget[z];
      const gap = Math.abs(actual - ideal);

      if (gap < 5) return;
      if (z === "overwhelming" && actual < 5 && ideal === 0) return;

      if (gap > bestGap) {
        bestGap = gap;
        bestZone = z;
      }
    });

    if (!bestZone) {
      const label = roleLabels[nextRole] || "next level";
      return `<span style="color:#555;">Your pattern is already close to the ideal feedback profile for a ${label}. Focus on consistency and alignment of messages.</span>`;
    }

    const actual = percents[bestZone] ?? 0;
    const ideal = nextTarget[bestZone];
    const label = roleLabels[nextRole] || "next level";
    const zoneLabel = zoneLabels[bestZone];

    let action;
    if (bestZone === "silent") {
      action = "Introduce more deliberate feedback moments so people are not guessing how they are doing.";
    } else if (bestZone === "sparse") {
      action = actual > ideal
        ? "Move from occasional comments to a clear feedback rhythm that covers strengths and development."
        : "Trim low value surface comments and invest in fewer but richer conversations.";
    } else if (bestZone === "resonant") {
      action = actual < ideal
        ? "Schedule regular one to one conversations that connect feedback to impact and next steps."
        : "Prioritise the most important topics so high quality feedback does not become overwhelming.";
    } else if (bestZone === "loud") {
      action = actual > ideal
        ? "Reduce reactive or problem only feedback. Agree the top messages and follow up in calmer spaces."
        : "Add some time bound feedback on goals and outcomes so urgency and focus increase where appropriate.";
    } else {
      action = "Reset how feedback is delivered. Agree ground rules, narrow the focus and protect psychological safety.";
    }

    return `
      To move toward the profile for a <strong>${label}</strong>, focus first on <strong>${zoneLabel}</strong>
      (now ${actual}%, ideal ${ideal}%). ${action}
    `;
  }

  function renderOverallScale(topZone, percents, role) {
    const zoneToScore = {
      silent: 1,
      sparse: 2,
      resonant: 3,
      loud: 4,
      overwhelming: 5
    };

    const score = zoneToScore[topZone] || 3;
    latestScaleScore = score;
    const desc = descriptions[score];
    const target = currentTarget(role);

    const deviations = [];
    if (target) {
      ["silent","sparse","resonant","loud","overwhelming"].forEach(z => {
        const actual = percents[z] ?? 0;
        const ideal = target[z];
        const diff = actual - ideal;
        const absDiff = Math.abs(diff);

        if (z === "overwhelming") {
          if (actual >= 5 && diff >= 5) {
            deviations.push({ zone: z, absDiff, text: `<li><strong>${zoneLabels[z]}</strong> is ${diff} points higher than expected: ${zoneNarrative(z, actual, ideal)}</li>` });
          }
          return;
        }

        if (z === "silent") {
          if (actual >= 15 && diff >= 5) {
            deviations.push({ zone: z, absDiff, text: `<li><strong>${zoneLabels[z]}</strong> is ${diff} points higher than expected: ${zoneNarrative(z, actual, ideal)}</li>` });
          }
          return;
        }

        if (absDiff >= 8) {
          const direction = diff > 0 ? "higher" : "lower";
          deviations.push({
            zone: z,
            absDiff,
            text: `<li><strong>${zoneLabels[z]}</strong> is ${absDiff} points ${direction} than expected: ${zoneNarrative(z, actual, ideal)}</li>`
          });
        }
      });
      deviations.sort((a, b) => b.absDiff - a.absDiff);
    }

    let deviationsHtml;
    if (!target) {
      deviationsHtml = "<span style='color:#555;'>Select a role level to see which zones differ most from the expected feedback profile.</span>";
    } else if (!deviations.length) {
      deviationsHtml = "<span style='color:#555;'>No major deviations from the ideal feedback profile for this role. Focus on keeping messages clear, respectful and aligned.</span>";
    } else {
      deviationsHtml = "<ul>" + deviations.slice(0,3).map(d => d.text).join("") + "</ul>";
    }

    const nextLevelText = buildNextLevelRecommendation(percents, role);

    overallResult.innerHTML = `
      <p><strong>Dominant zone:</strong> ${zoneLabels[topZone]} (score ${score} (${desc.label}))</p>
      <p><strong>Description:</strong> ${desc.text}</p>
      <p><strong>Manager guidance:</strong> ${desc.manager}</p>
      <p><strong>Other areas to notice:</strong> ${deviationsHtml}</p>
      <p><strong>Next-level progression focus:</strong></p>
      <p style="margin-top:0.25rem;">${nextLevelText}</p>
    `;
  }

  function renderResults(percents, role, topZone, topScore) {
    const flags = buildFlags(percents);
    const target = currentTarget(role);
    const idealSummary = buildIdealSummary(role, target);

    calculationResults.innerHTML = `
      <p><strong>Dominant zone:</strong> ${zoneLabels[topZone]} (${topScore}%)</p>
      <p><strong>Pattern:</strong> Silent ${percents.silent}% · Sparse ${percents.sparse}% · Resonant ${percents.resonant}% · Loud ${percents.loud}% · Overwhelming ${percents.overwhelming}%</p>
      <p><strong>Ideal profile:</strong> ${idealSummary}</p>
      ${
        target
          ? buildComparisonTable(percents, target)
          : "<p style='font-size:0.8rem;color:#555;margin-top:0.3rem;'>Select a role level to compare current and ideal scores by zone.</p>"
      }
      <div class="conversation-prompts">
        <strong>Conversation prompts:</strong>
        ${
          flags.length
            ? "<ul>" + flags.map(f => `<li>${f}</li>`).join("") + "</ul>"
            : "<p>No specific risk flags from this pattern. Still useful to discuss what is helping it work well and what you want more of.</p>"
        }
      </div>
    `;

    renderOverallScale(topZone, percents, role);
    drawRingChart(percents);
    updateRingLegend(percents, "Current pattern");
  }

  function handleCalculate() {
    const responses = getResponses();
    if (!responses) {
      alert("Please answer all questions before calculating.");
      return;
    }

    // Visual feedback like Bored to Panic
    calculateButton.classList.add("calculating");
    boardWrapper.classList.add("calculated");

    const { raw, percents } = calculateZoneScores(responses);
    const entriesArr = Object.entries(percents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["resonant", 0];

    latestZonePercents = percents;
    latestZoneRaw = raw;
    latestTopZone = topZone;
    latestTopScore = topScore;
    latestResponses = responses;

    const role = roleLevelSelect.value || null;
    renderResults(percents, role, topZone, topScore);

    setTimeout(() => {
      calculateButton.classList.remove("calculating");
      boardWrapper.classList.remove("calculated");
    }, 1200);
  }

  calculateButton.addEventListener("click", handleCalculate);

  roleLevelSelect.addEventListener("change", () => {
    if (!latestZonePercents) return;
    const role = roleLevelSelect.value || null;
    const entriesArr = Object.entries(latestZonePercents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["resonant", 0];
    renderResults(latestZonePercents, role, topZone, topScore);
  });

  /* Local storage */

  function loadEntries() {
    try {
      return JSON.parse(localStorage.getItem("feedbackScaleEntries") || "[]");
    } catch {
      return [];
    }
  }

  function saveEntries(entries) {
    localStorage.setItem("feedbackScaleEntries", JSON.stringify(entries));
  }

  function renderEntriesTableAndDropdown() {
    const entries = loadEntries();
    entriesTableBody.innerHTML = "";
    loadSelect.innerHTML = '<option value="">Select saved entry</option>';

    entries.forEach((entry, index) => {
      const tr = document.createElement("tr");
      const roleLabel = roleLabels[entry.roleLevel] || entry.roleLevel || "";
      tr.innerHTML = `
        <td>${entry.timestamp}</td>
        <td>${entry.name || ""}</td>
        <td>${roleLabel}</td>
        <td>${entry.context || ""}</td>
        <td>${entry.score}</td>
        <td>${descriptions[entry.score]?.label || ""}</td>
      `;
      entriesTableBody.appendChild(tr);

      const opt = document.createElement("option");
      const label = descriptions[entry.score]?.label || `Score ${entry.score}`;
      opt.value = index.toString();
      opt.textContent = `${entry.timestamp} – ${entry.name || "No name"} (${label})`;
      loadSelect.appendChild(opt);
    });
  }

  renderEntriesTableAndDropdown();

  function handleSave() {
    if (!latestZonePercents || !latestTopZone) {
      alert("Please calculate your results before saving.");
      return;
    }

    const name = document.getElementById("personName").value.trim();
    const roleLevel = roleLevelSelect.value || "";
    let contextValue = "";
    if (contextSelect.value === "User-defined") {
      contextValue = contextCustom.value.trim();
    } else {
      contextValue = contextSelect.value || "";
    }

    const entries = loadEntries();
    const timestamp = new Date().toLocaleString();

    entries.push({
      timestamp,
      name,
      roleLevel,
      context: contextValue,
      score: latestScaleScore || 3,
      zonePercents: latestZonePercents,
      zoneRaw: latestZoneRaw,
      responses: latestResponses
    });

    saveEntries(entries);
    renderEntriesTableAndDropdown();
    alert("Entry saved in this browser.");
  }

  function toCsvRow(cells) {
    return cells.map(cell => {
      const val = cell == null ? "" : String(cell);
      if (/[",\n]/.test(val)) {
        return '"' + val.replace(/"/g, '""') + '"';
      }
      return val;
    }).join(",");
  }

  function handleExportCsv() {
    const entries = loadEntries();
    if (!entries.length) {
      alert("No entries to export.");
      return;
    }

    const headers = [
      "Timestamp","Name","RoleLevel","Context","Score","Zone",
      "Silent%","Sparse%","Resonant%","Loud%","Overwhelming%"
    ];
    questions.forEach(q => headers.push(`Q${q.id}`));
    const rows = [toCsvRow(headers)];

    entries.forEach(entry => {
      const zp = entry.zonePercents || {};
      const responses = entry.responses || {};
      const row = [
        entry.timestamp,
        entry.name || "",
        entry.roleLevel || "",
        entry.context || "",
        entry.score,
        descriptions[entry.score]?.label || "",
        zp.silent ?? "",
        zp.sparse ?? "",
        zp.resonant ?? "",
        zp.loud ?? "",
        zp.overwhelming ?? ""
      ];
      questions.forEach(q => row.push(responses[q.id] ?? ""));
      rows.push(toCsvRow(row));
    });

    const blob = new Blob([rows.join("\r\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "feedback_scale_entries.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function handleClearEntries() {
    if (!confirm("Clear all saved entries in this browser?")) return;
    localStorage.removeItem("feedbackScaleEntries");
    renderEntriesTableAndDropdown();
  }

  function handleLoadEntry() {
    const idx = loadSelect.value;
    if (idx === "") return;
    const entries = loadEntries();
    const entry = entries[parseInt(idx, 10)];
    if (!entry) return;

    document.getElementById("personName").value = entry.name || "";
    roleLevelSelect.value = entry.roleLevel || "";

    if (entry.context) {
      const match = Array.from(contextSelect.options).find(o => o.value === entry.context);
      if (match) {
        contextSelect.value = entry.context;
        contextCustom.value = "";
        contextCustom.style.display = "none";
      } else {
        contextSelect.value = "User-defined";
        contextCustom.value = entry.context;
        contextCustom.style.display = "block";
      }
    } else {
      contextSelect.value = "";
      contextCustom.value = "";
      contextCustom.style.display = "none";
    }

    questions.forEach(q => {
      document
        .querySelectorAll(`label.response-radio input[name="q${q.id}"]`)
        .forEach(r => {
          r.checked = false;
          r.parentElement.classList.remove("selected");
        });
    });

    if (entry.responses) {
      Object.entries(entry.responses).forEach(([qid, val]) => {
        const radio = document.querySelector(`label.response-radio input[name="q${qid}"][value="${val}"]`);
        if (radio) {
          radio.checked = true;
          radio.parentElement.classList.add("selected");
        }
      });
    }

    latestResponses = entry.responses || null;

    let percents = entry.zonePercents;
    let raw = entry.zoneRaw;

    if (!percents && entry.responses) {
      const calc = calculateZoneScores(entry.responses);
      percents = calc.percents;
      raw = calc.raw;
    }

    if (!percents) {
      alert("This saved entry does not contain enough data to reconstruct scores.");
      return;
    }

    latestZonePercents = percents;
    latestZoneRaw = raw;
    const entriesArr = Object.entries(percents).sort((a, b) => b[1] - a[1]);
    const [topZone, topScore] = entriesArr[0] || ["resonant", 0];
    latestTopZone = topZone;
    latestTopScore = topScore;
    latestScaleScore = entry.score || null;

    const role = roleLevelSelect.value || null;
    renderResults(percents, role, topZone, topScore);
  }

  saveButton.addEventListener("click", handleSave);
  exportButton.addEventListener("click", handleExportCsv);
  clearButton.addEventListener("click", handleClearEntries);
  loadSelect.addEventListener("change", handleLoadEntry);

  /* Fullscreen */

  document.getElementById("fullscreenToggle").addEventListener("click", () => {
    if (!document.fullscreenElement) {
      boardWrapper.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });

  /* PDF export with header/footer */

  async function handleExportPdf() {
    const { jsPDF } = window.jspdf;

    const name = document.getElementById("personName").value.trim() || "Not specified";
    const role = roleLabels[roleLevelSelect.value] || (roleLevelSelect.value || "Not specified");
    let contextValue = "";
    if (contextSelect.value === "User-defined") {
      contextValue = contextCustom.value.trim();
    } else {
      contextValue = contextSelect.value || "";
    }
    const contextLabel = contextValue || "Not specified";
    const now = new Date();
    const dateString = now.toLocaleString();

    const exportHeader = document.createElement("div");
    exportHeader.className = "export-header";
    exportHeader.innerHTML = `
      <div class="export-header-title">Feedback scale assessment</div>
      <div class="export-header-meta">
        Name: ${name} · Role: ${role} · Context: ${contextLabel} · Date: ${dateString}
      </div>
    `;
    boardInner.insertBefore(exportHeader, boardInner.firstChild);

    const exportFooter = document.createElement("div");
    exportFooter.className = "export-footer";
    const url = "https://imthebus.co.uk/web-tools/feedback-scale.html";
    exportFooter.textContent = `Generated from IMTHEBUS Feedback scale tool (${url}) on ${dateString}`;
    boardInner.appendChild(exportFooter);

    boardInner.classList.add("export-mode");

    const canvas = await html2canvas(boardWrapper, { scale: 2 });
    const img = canvas.toDataURL("image/jpeg", 0.9);
    const pdf = new jsPDF("p", "mm", "a4");
    const width = pdf.internal.pageSize.getWidth();
    const height = (canvas.height * width) / canvas.width;
    pdf.addImage(img, "JPEG", 0, 0, width, height);
    pdf.save("Feedback_Scale_Assessment.pdf");

    exportHeader.remove();
    exportFooter.remove();
    boardInner.classList.remove("export-mode");
  }

  exportPdfButton.addEventListener("click", handleExportPdf);
</script>
</body>
</html>
